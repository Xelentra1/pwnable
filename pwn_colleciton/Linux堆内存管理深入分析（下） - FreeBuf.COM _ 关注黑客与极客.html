<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
                              _.._        ,------------.
                           ,'      `.    ( We want you! )
                          /  __) __` \    `-,----------'
                         (  (`-`(-')  ) _.-'
                         /)  \  = /  (
                        /'    |--' .  \
                       (  ,---|  `-.)__`
                        )(  `-.,--'   _`-.
                       '/,'          (  Uu",
                        (_       ,    `/,-' )
                        `.__,  : `-'/  /`--'
                          |     `--'  |
                          `   `-._   /
                           \        (
                           /\ .      \.  freebuf
                          / |` \     ,-\
                         /  \| .)   /   \
                        ( ,'|\    ,'     :
                        | \,`.`--"/      }
                        `,'    \  |,'    /
                       / "-._   `-/      |
                       "-.   "-.,'|     ;
                      /        _/["---'""]
                     :        /  |"-     '
                     '           |      /
                                 `      |
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Linux堆内存管理深入分析（下） - FreeBuf.COM | 关注黑客与极客</title>
<meta name="description" content="一、前言回顾

在上一篇文章中，详细介绍了堆内存管理中涉及到的基本概念以及相互关系，同时也着重介绍了堆中chunk分配和释放策略中使用到的隐式链表技术。通过前面的介绍，我们知道使用隐式链表来管理内存chunk总…" />
<meta name="keywords" content="" />
<meta name="baidu-site-verification" content="nKKKqQxp6R" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta property="qc:admins" content="6620477777662552566375" />
<link rel='stylesheet' id='wpfp-css' href='http://www.freebuf.com/buf/plugins/wp-favorite-posts/wpfp.css' type='text/css' />
<link rel='stylesheet' id='wp-recentcomments-css'  href='http://static.3001.net/css/recentcomments/wp-recentcomments.css?ver=2.2.3' type='text/css' media='screen' />
<link rel='stylesheet' id='mycred-widget-css'  href='http://www.freebuf.com/buf/plugins/gold/assets/css/widget.css?ver=1.3.2.1' type='text/css' media='all' />
<script type='text/javascript' src='http://static.3001.net/js/header/jquery.min.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://www.freebuf.com/buf/plugins/wp-favorite-posts/wpfp.js?ver=3.6.1'></script>
<link rel='prev' title='风控反欺诈领域恶意竞争，输的是谁？' href='http://www.freebuf.com/articles/neopoints/105244.html' />
<link rel='next' title='使用Windbg和Python进行堆跟踪' href='http://www.freebuf.com/articles/system/103816.html' />
<link rel='canonical' href='http://www.freebuf.com/articles/security-management/105285.html' />
<link rel='shortlink' href='http://www.freebuf.com/?p=105285' />

<link rel="stylesheet" href="http://static.3001.net/css/highslide/highslide.css" type="text/css" />
<script type="text/javascript" src="http://static.3001.net/js/highslide/highslide-with-html.packed.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
    hs.graphicsDir = "http://www.freebuf.com/buf/plugins/auto-highslide/images/graphics/";
    hs.outlineType = "rounded-white";
    hs.dimmingOpacity = 0.8;
    hs.outlineWhileAnimating = true;
    hs.showCredits = false;
    hs.captionEval = "this.thumb.alt";
    hs.numberPosition = "caption";
    hs.align = "center";
    hs.transitions = ["expand", "crossfade"];
    hs.addSlideshow({
        interval: 5000,
        repeat: true,
        useControls: true,
        fixedControls: "fit",
        overlayOptions: {
            opacity: 0.75,
            position: "bottom center",
            hideOnMouseOut: true

        }

    });
});
</script>
          <script language="JavaScript" type="text/javascript" src="http://www.freebuf.com/buf/plugins/cartpauj-pm/js/script.js"></script>
      <link rel="stylesheet" type="text/css" href="http://www.freebuf.com/buf/plugins/cartpauj-pm/style/style.css" />
      <script type="text/javascript" src="http://www.freebuf.com/buf/plugins/simditor/highlight/highlight.pack.js"></script><link type="text/css" rel="stylesheet" href=" http://www.freebuf.com/buf/plugins/simditor/highlight/styles/default.css" />	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<link rel="shortcut icon" href="http://static.freebuf.com/images/favicon.ico" />
<link href="http://static.3001.net/css/new/bootstrap.min.css?ver=2016051701" rel="stylesheet" media="screen">
<link href="http://static.3001.net/css/new/style.css?ver=2016071401" rel="stylesheet" type="text/css">
<style type="text/css">
#contenttxt hr {
  display: block;
  height: 0px;
  border: 0;
  border-top: 1px solid #ccc;
  margin: 15px 0;
  padding: 0;
}
#contenttxt table {
  width: 100%;
  table-layout: fixed;
  border-collapse: collapse;
  border-spacing: 0;
  margin: 15px 0;
}
#contenttxt table thead {
  background-color: #f9f9f9;
}
#contenttxt table td, #contenttxt table th {
  min-width: 40px;
  height: 30px;
  border: 1px solid #ccc;
  vertical-align: top;
  padding: 2px 4px;
  text-align: left;
  box-sizing: border-box;
  white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word;
}
#contenttxt table td.active, #contenttxt table th.active {
  background-color: #ffffee;
  white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word;
}
</style>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/jquery-2.0.3.min.js"></script>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/bootstrap.min.js"></script>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/slider.js?2016022501.1" type="text/javascript"></script>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/jquery.sticky.js" type="text/javascript"></script>
<script src="http://static.3001.net/js/focus/bjqs-1.3.min.js" type="text/javascript" ></script>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/mosaic.1.0.1.min.js" type="text/javascript" ></script>
<!--[if lt IE 9]>
    <script src="http://www.freebuf.com/buf/themes/freebuf/js/html5shiv.min.js"></script>
    <script src="http://www.freebuf.com/buf/themes/freebuf/js/respond.min.js"></script>
<![endif]-->
</head>

<body>
<!----------header---------->
<div class="main-header">
  <nav class="navbar navbar-inverse" role="navigation">

    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle collapsed" aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" type="button"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
        <div class="logo"><a href="http://www.freebuf.com"><img src="http://image.3001.net/images/new/logo.png"/></a><span class="visible-lg-block">关注黑客与极客</span></div>
      </div>
      <div id="navbar" class="navbar-collapse collapse globalnav" aria-expanded="false" >
        <ul class="nav nav-pills pull-left">
          <li ><a href="http://www.freebuf.com">首页</a></li>
          <li class="dropdown"> <a href="javascript:viod(0);" class="dropdown-toggle" data-toggle="dropdown">分类阅读<b class="caret"></b> </a>
            <ul class="dropdown-menu article-nav">
              <li> <strong>黑客</strong>
                <div class="nav"> <a href="http://www.freebuf.com/vuls" target="_blank">漏洞</a> <a href="http://www.freebuf.com/sectool" target="_blank">安全工具</a> <a href="http://www.freebuf.com/articles/web" target="_blank">WEB安全</a> <a href="http://www.freebuf.com/articles/system" target="_blank">系统安全</a> <a href="http://www.freebuf.com/articles/network" target="_blank">网络安全</a> <a href="http://www.freebuf.com/articles/wireless" target="_blank">无线安全</a> <a href="http://www.freebuf.com/articles/terminal" target="_blank">设备/客户端安全</a> <a href="http://www.freebuf.com/articles/database" target="_blank">数据库安全</a> <a href="http://www.freebuf.com/articles/security-management" target="_blank">安全管理</a></div>
              </li>
              <li> <strong>极客</strong>
                <div class="nav"> <a href="http://www.freebuf.com/geek" target="_blank">极客有意思</a> <a href="http://www.freebuf.com/news/others" target="_blank">周边</a></div>
              </li>
              <li> <strong>特色</strong>
                <div class="nav"><a href="http://www.freebuf.com/news/special" target="_blank">头条</a><a href="http://www.freebuf.com/articles/people" target="_blank">人物志</a><a href="http://www.freebuf.com/fevents" target="_blank">活动</a><a href="http://www.freebuf.com/video" target="_blank">视频</a><a href="http://www.freebuf.com/articles/neopoints" target="_blank">观点</a><a href="http://www.freebuf.com/jobs" target="_blank">招聘</a><a href="http://www.freebuf.com/paper/" target="_blank">报告</a></div>
              </li>
            </ul>
          </li>
          <li > <a href="http://www.freebuf.com/wenku" target="_blank">文库<b class="icon-betr"></b> </a></li>
          <li><a href="http://bar.freebuf.com/" target="_blank">小酒馆</a><span ></span></li>
          <li><a href="http://open.freebuf.com" target="_blank">公开课</a></li>
          <li><a href="http://shop.freebuf.com" target="_blank">商城</a></li>
          <li><a href="https://www.vulbox.com" target="_blank">漏洞盒子</a><span class="icon-hot"></span></li>
        </ul>
                <div class="main-login">
          <ul class="nav nav-pills pull-right login">
            <li class="pull-right"><a href="https://account.tophant.com/register.html">注册</a></li>
            <li class="active pull-right"><a href="http://www.freebuf.com/oauth">登录</a></li>
          </ul>
        </div>
              </div>
    </div>
  </nav>
</div>
<script type="text/javascript">
function ntabs(thisObj,Num){
    if(thisObj.className == "active")return;
    var tabObj = thisObj.parentNode.id;
    var tabList = document.getElementById(tabObj).getElementsByTagName("li");
    for(i=0; i <tabList.length; i++)
    {
        if (i == Num){
            thisObj.className = "active"; 
            document.getElementById(tabObj+"_content"+i).style.display = "block";
        }else{
            tabList[i].className = "normal"; 
            document.getElementById(tabObj+"_content"+i).style.display = "none";
        }
    } 
}
</script> 
<!----------header end----------><script>
    jQuery(window).load(function(){
      if(jQuery(window).width()>480){
        jQuery(".main-header").sticky({ topSpacing: 0 });
      }else{
        jQuery(".main-header nav").removeClass("navbar-fixed-top");
      }
      jQuery("#mar-right").sticky({ topSpacing: 105,bottomSpacing: 410 });
    });
</script>
<script type="text/javascript" src="http://static.3001.net/js/pretty/prettify.js"></script>
<script type="text/javascript" src="http://static.3001.net/js/header/lazyload.js"></script>
<script type="text/javascript" charset="utf-8">
      jQuery(function() {
          jQuery("img").lazyload({
              effect : "fadeIn"
          });
      });
 </script>
<script type="text/javascript">
    window.onload = function(){
        prettyPrint();
    }
</script>
<script language="JavaScript" type="text/javascript">
//<![CDATA[
var va = "您已经点亮过了";
function acv_vote(id,option, m){
  if( m==null) m =''; m = m + '';
  jQuery('#acv_stat_'+m+id).html('Loading...');
  var url="http://www.freebuf.com/index.php?acv_ajax=true&option="+option+"&ID="+id;
  jQuery.get(url,function(d){
    d =d.split('|');var s='#acv_stat_'+m+d[0];
    var sele = '#cos_support-'+m+id,unsele = '#cos_unsupport-'+m+id,tpjs = 'javascript:alert(va)';
    jQuery( s ).html( d[1] );jQuery(s).fadeOut(400,function(){jQuery(s).fadeIn();});
    if( d[2] == 1 ){ jQuery(sele).html(jQuery(sele).html()*1+1); }
    if( d[2] == -1 ){ jQuery(unsele).html(jQuery(unsele).html()*1+1); }
    jQuery('#vote4-'+id).attr('href',tpjs);jQuery('#vote4-2'+id).attr('href',tpjs);
    jQuery('#votea-'+id).attr('href',tpjs);jQuery('#votea-2'+id).attr('href',tpjs);
  });
}
  
$(document).on("mouseenter",".comment-tools",function(){
  $(this).find(".btn-report").show();
  $(this).find(".btn-report").addClass("hover");
}).on("mouseleave",".comment-tools",function(){
  var $_this = $(this);
  $(this).find(".btn-report").removeClass("hover");
  if(!$(this).find(".dropup").hasClass('open')){
    $(this).find(".btn-report").hide(); 
    $_this.find(".dropdown-menu").css("display","none");
  }else{
    setTimeout(function(){
      if(!$_this.find(".btn-report").hasClass("hover")){
        $_this.find(".dropup").removeClass("open");
        $_this.find(".dropdown-menu").css("display","none");
        $_this.find(".btn-report").hide(); 
      }
    },"500");
  }
})

$(document).on("click",".click_report",function(){
  $(this).parent().parent().css("display","none");
  var id = $(this).attr("data-id");
  var url="http://www.freebuf.com/index.php?acv_ajax=true&option=0&ID="+id;
  $_this = $(this);
  jQuery.get(url,function(d){
    d =d.split('|');
    if(d[1]=='您已经点过灯了'){
      d[1] = '您已经举报过了';
    }
    if(d[1]=='Thank you'){
      d[1] = '举报成功';
    }
    $_this.parent().parent().parent().find(".btn-report").text(d[1]);
    $_this.parent().parent().parent().find(".btn-report").css("display","block");
  })
})

$(document).on("click",".btn-report",function(){
  if($(this).parent().hasClass('open')){
    $(this).parent().find(".dropdown-menu").css("display","block");
  }else{
    $(this).parent().find(".dropdown-menu").css("display","none");
  }
})
//]]>
</script>
<div class="container pad-top35">
  <div class="row clearfix">
        <div class="col-md-9">
      <div class="article-wrap panel panel-default">
                    <div class="articlecontent">
        <div class="title">
          <h2> Linux堆内存管理深入分析（下） </h2>
          <div class="property">
		  		  <span class="name"><a href="http://www.freebuf.com/author/%E9%98%BF%E9%87%8C%E8%81%9A%E5%AE%89%E5%85%A8" title="由 阿里聚安全 发布" rel="author">阿里聚安全</a></span>
		  		  <span class="icon-f"><a href="http://www.freebuf.com/bufer" target="_blank"><img src="http://image.3001.net/images/index/f2.png" title="认证厂商"></a></span>
		  <span class="time">2016-05-26</span>
             
		  <span class="look">共<strong>86411</strong>人围观
              ，发现 <strong>1</strong> 个不明物体 </span>          </span>
		  <span class="tags">		  
		  <a href="http://www.freebuf.com/./articles/security-management">安全管理</a></span>	
        <span class="tags_01"></span>			  
		  </div>
        </div>
                        <div id="contenttxt">
           <h2>一、前言回顾<br /></h2>
</p>
<p><span style="font-size: 15px; color: rgb(0, 176, 80);"><b>在上一篇文章中，详细介绍了堆内存管理中涉及到的基本概念以及相互关系，同时也着重介绍了堆中chunk分配和释放策略中使用到的隐式链表技术。通过前面的介绍，我们知道使用隐式链表来管理内存chunk总会涉及到内存的遍历，效率极低。对此glibc malloc引入了显示链表技术来提高堆内存分配和释放的效率。</b></span></p>
<p><span style="font-size: 15px;">所谓的显示链表就是我们在数据结构中常用的链表，而链表本质上就是将一些属性相同的“结点”串联起来，方便管理。在glibc malloc中这些链表统称为bin，链表中的“结点”就是各个chunk，结点的共同属性就是：</span></p>
<p><span style="font-size: 15px;">1)&nbsp;均为free chunk</span></p>
<p><span style="font-size: 15px;">2)&nbsp;同一个链表中各个chunk的大小相等(有一个特例，详情见后文)</span></p>
<h2>二、bin介绍<br /></h2>
<p><span style="font-size: 15px;">如前文所述，bin是一种记录free chunk的链表数据结构。系统针对不同大小的free chunk，将bin分为了4类：</span></p>
<blockquote><p><span style="font-size: 15px;">1) Fast bin</span></p>
<p><span style="font-size: 15px;">2) Unsorted bin</span></p>
<p><span style="font-size: 15px;">3) Small bin</span></p>
<p><span style="font-size: 15px;">4) Large bin</span></p>
</blockquote>
<p><span style="font-size: 15px;">在glibc中用于记录bin的数据结构有两种，分别如下所示：</span></p>
<p><strong><span style="font-size: 15px;">fastbinsY</span></strong><span style="font-size: 15px;">:&nbsp;这是一个数组，用于记录所有的fast bins；</span></p>
<p><strong><span style="font-size: 15px;">bins</span></strong><span style="font-size: 15px;">:&nbsp;这也是一个数组，用于记录除fast bins之外的所有bins。事实上，一共有126个bins，分别是：</span></p>
<blockquote><p><span style="font-size: 15px;">bin 1&nbsp;为unsorted bin;</span></p>
<p><span style="font-size: 15px;">bin 2&nbsp;到63为small bin;</span></p>
<p><span style="font-size: 15px;">bin 64到126为large bin。</span></p>
</blockquote>
<p><span style="font-size: 15px;">其中具体数据结构定义如下：</span></p>
<p><span style="font-size: 14px;"></span></p>
<pre><code>struct malloc_state
{
&nbsp; ……
&nbsp; /* Fastbins */
&nbsp; mfastbinptr fastbinsY[NFASTBINS];
&nbsp; ……
&nbsp; /* Normal bins packed as described above */
&nbsp; mchunkptr bins[NBINS * 2 - 2]; &nbsp;// #define NBINS &nbsp; &nbsp;128
&nbsp; ……
};
这里mfastbinptr的定义：typedef struct malloc_chunk *mfastbinptr;
mchunkptr的定义：typedef struct malloc_chunk* mchunkptr;<br /></code></pre>
<p><span style="font-size: 15px;">画图更直观：</span></p>
<p style="text-align: center;"><img alt="2.png" data-original="http://image.3001.net/images/20160525/14641459166101.png!small" src="http://www.freebuf.com/buf/themes/freebuf/images/grey.gif" width="576" height="241"></p>
<noscript><img alt="2.png" src="http://image.3001.net/images/20160525/14641459166101.png!small" width="576" height="241"></p></noscript>
<p style="text-align: center;">图1-1 bins分类</p>
<p><span style="font-size: 15px;">那么处于bins中个各个free chunk是如何链接在一起的呢？回顾malloc_chunk的数据结构：</span></p>
<p><span style="font-size: 14px;"></span></p>
<pre><code>struct malloc_chunk {
&nbsp; /* #define INTERNAL_SIZE_T size_t */
&nbsp; INTERNAL_SIZE_T &nbsp; &nbsp; &nbsp;prev_size; &nbsp;/* Size of previous chunk (if free). &nbsp;*/
&nbsp; INTERNAL_SIZE_T &nbsp; &nbsp; &nbsp;size; &nbsp; &nbsp; &nbsp; /* Size in bytes, including overhead. */
&nbsp; struct malloc_chunk* fd; &nbsp; &nbsp; &nbsp; &nbsp; /* 这两个指针只在free chunk中存在*/
&nbsp; struct malloc_chunk* bk;
&nbsp;
&nbsp; /* Only used for large blocks: pointer to next larger size. &nbsp;*/
&nbsp; struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */
&nbsp; struct malloc_chunk* bk_nextsize;
};<br /></code></pre>
<p><span style="font-size: 14px;"></span></p>
<p><span style="font-size: 15px;">其中的fd和bk指针就是指向当前chunk所属的链表中forward或者backward chunk。</span></p>
<h2>三、Fast bin<br /></h2>
<p><span style="font-size: 15px;">既然有fast bin，那就肯定有fast chunk——chunk size为<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c?spm=a313e.7916648.0.0.aKGnqF#L1249" target="_blank">16</a>到<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c?spm=a313e.7916648.0.0.aKGnqF#L1600" target="_blank">80</a>字节的chunk就叫做fast chunk。为了便于后文描述，这里对chunk大小做如下约定：</span></p>
<blockquote><p><span style="font-size: 15px;">1)&nbsp;只要说到chunk size，那么就表示该malloc_chunk的实际整体大小；</span></p>
<p><span style="font-size: 15px;">2)&nbsp;而说到chunk unused size，就表示该malloc_chunk中刨除诸如prev_size, size, fd和bk这类辅助成员之后的实际可用的大小。因此，对free chunk而言，其实际可用大小总是比实际整体大小<strong>少16字节</strong>。</span></p>
</blockquote>
<p><span style="font-size: 15px;">在内存分配和释放过程中，fast bin是所有bin中操作速度最快的。下面详细介绍fast bin的一些特性：</span></p>
<p><span style="font-size: 15px;">1) fast bin的个数——10个</span></p>
<p><span style="font-size: 15px;">2)&nbsp;每个fast bin都是一个单链表(<strong>只使用fd指针</strong>)。为什么使用单链表呢？因为在fast bin中无论是添加还是移除fast chunk，都是对“<strong>链表尾</strong>”进行操作，而不会对某个中间的fast chunk进行操作。更具体点就是LIFO(后入先出)算法：添加操作(free内存)就是将新的fast chunk加入链表尾，删除操作(malloc内存)就是将链表尾部的fast chunk删除。需要注意的是，为了实现LIFO算法，fastbinsY数组中每个fastbin元素均指向了该链表的rear end（尾结点），而尾结点通过其fd指针指向前一个结点，依次类推，如图2-1所示。</span></p>
<p><span style="font-size: 15px;">3) chunk size：10个fast bin中所包含的fast chunk size是按照步进8字节排列的，即第一个fast bin中所有fast chunk size均为16字节，第二个fast bin中为24字节，依次类推。在进行malloc初始化的时候，最大的fast chunk size被设置为80字节(chunk unused size为64字节)，因此默认情况下大小为16到80字节的chunk被分类到fast chunk。详情如图2-1所示。</span></p>
<p><span style="font-size: 15px;">4)&nbsp;不会对free chunk进行合并操作。鉴于设计fast bin的初衷就是进行快速的<b>小内存</b>分配和释放，因此系统将属于fast bin的chunk的P(未使用标志位)总是设置为1，这样即使当fast bin中有某个chunk同一个free chunk相邻的时候，系统也不会进行自动合并操作，而是保留两者。虽然这样做可能会造成额外的碎片化问题，但瑕不掩瑜。</span></p>
<p><span style="font-size: 15px;">5) malloc(fast chunk)操作：即用户通过malloc请求的大小属于fast chunk的大小范围(注意：用户请求size加上16字节就是实际内存chunk size)。在初始化的时候fast bin支持的最大内存大小以及所有fast bin链表都是空的，所以当最开始使用malloc申请内存的时候，即使申请的内存大小属于fast chunk的内存大小(即16到80字节)，它也不会交由fast bin来处理，而是向下传递交由small bin来处理，如果small bin也为空的话就交给unsorted bin处理：</span></p>
<p><span style="font-size: 14px;"></span></p>
<pre><code>/* Maximum size of memory handled in fastbins. &nbsp;*/
static INTERNAL_SIZE_T global_max_fast;
&nbsp;
/* offset 2 to use otherwise unindexable first 2 bins */
/*这里SIZE_SZ就是sizeof(size_t)，在32位系统为4，64位为8，fastbin_index就是根据要malloc的size来快速计算该size应该属于哪一个fast bin，即该fast bin的索引。因为fast bin中chunk是从16字节开始的，所有这里以8字节为单位(32位系统为例)有减2*8 = 16的操作！*/
#define fastbin_index(sz) \
&nbsp; ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)
&nbsp;
&nbsp;
/* The maximum fastbin request size we support */
#define MAX_FAST_SIZE &nbsp; &nbsp; (80 * SIZE_SZ / 4)
&nbsp;
#define NFASTBINS &nbsp;(fastbin_index (request2size (MAX_FAST_SIZE)) + 1)<br /></code></pre>
<p><span style="font-size: 14px;"></span></p>
<p><strong><span style="font-size: 15px;">那么fast bin&nbsp;是在哪？怎么进行初始化的呢？</span></strong><span style="font-size: 15px;">当我们第一次调用malloc(fast bin)的时候，系统执行_int_malloc函数，该函数首先会发现当前fast bin为空，就转交给small bin处理，进而又发现small bin&nbsp;也为空，就调用malloc_consolidate函数对malloc_state结构体进行初始化，malloc_consolidate函数主要完成以下几个功能：</span></p>
<p><strong><span style="font-size: 15px;">a.&nbsp;</span></strong><span style="font-size: 15px;">首先判断当前malloc_state结构体中的fast bin是否为空，如果为空就说明整个malloc_state都没有完成初始化，需要对malloc_state进行初始化。</span></p>
<p><strong><span style="font-size: 15px;">b.&nbsp;</span></strong><span style="font-size: 15px;">malloc_state的初始化操作由函数malloc_init_state(av)完成，该函数先初始化除fast bin之外的所有的bins(构建双链表，详情见后文small bins介绍)，再初始化fast bins。</span></p>
<p><span style="font-size: 15px;">然后当再次执行malloc(fast chunk)函数的时候，此时fast bin相关数据不为空了，就开始使用fast bin(见下面代码中的※1部分)：</span></p>
<p><span style="font-size: 14px;"></span></p>
<pre><code>static void *
_int_malloc (mstate av, size_t bytes)
{
&nbsp; ……
&nbsp; /*
&nbsp; &nbsp; &nbsp;If the size qualifies as a fastbin, first check corresponding bin.
&nbsp; &nbsp; &nbsp;This code is safe to execute even if av is not yet initialized, so we
&nbsp; &nbsp; &nbsp;can try it without checking, which saves some time on this fast path.
&nbsp; &nbsp;*/
&nbsp; &nbsp;//第一次执行malloc(fast chunk)时这里判断为false，因为此时get_max_fast ()为0
&nbsp; &nbsp;if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ()))
&nbsp; &nbsp; {
&nbsp; ※1 &nbsp;idx = fastbin_index (nb);
&nbsp; &nbsp; &nbsp; mfastbinptr *fb = &amp;fastbin (av, idx);
&nbsp; &nbsp; &nbsp; mchunkptr pp = *fb;
&nbsp; &nbsp; &nbsp; do
&nbsp; &nbsp; &nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; victim = pp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (victim == NULL)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp;※2 while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))!= victim);
&nbsp; &nbsp; &nbsp; if (victim != 0)
&nbsp; &nbsp; &nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0))
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; errstr = "malloc(): memory corruption (fast)";
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; errout:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; malloc_printerr (check_action, errstr, chunk2mem (victim));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check_remalloced_chunk (av, victim, nb);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; void *p = chunk2mem (victim);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc_perturb (p, bytes);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return p;
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }<br /></code></pre>
<p><span style="font-size: 15px;">得到第一个来自于fast bin的chunk之后，系统就将该chunk从对应的fast bin中移除，并将其地址返回给用户，见上面代码※2处。</span></p>
<p><span style="font-size: 15px;">6) free(fast chunk)操作：这个操作很简单，主要分为两步：先通过chunksize函数根据传入的地址指针获取该指针对应的chunk的大小；然后根据这个chunk大小获取该chunk所属的fast bin，然后再将此chunk添加到该fast bin的链尾即可。整个操作都是在_int_free函数中完成。</span></p>
<p><span style="font-size: 15px;">在main arena中Fast bins(即数组fastbinsY)的整体操作示意图如下图所示：</span></p>
<p style="text-align: center;"><img alt="6.png" data-original="http://image.3001.net/images/20160525/14641459278751.png!small" src="http://www.freebuf.com/buf/themes/freebuf/images/grey.gif" width="690" height="501"></p>
<noscript><img alt="6.png" src="http://image.3001.net/images/20160525/14641459278751.png!small" width="690" height="501"></p></noscript>
<p style="text-align: center;">图2-1 fast bin示意图</p>
<h2>四、Unsorted bin</h2>
<p>当释放较小或较大的chunk的时候，如果系统没有将它们添加到对应的bins中(为什么，在什么情况下会发生这种事情呢？详情见后文)，系统就将这些chunk添加到unsorted bin中。为什么要这么做呢？这主要是为了让“glibc malloc机制”能够有第二次机会重新利用最近释放的chunk(第一次机会就是fast bin机制)。利用unsorted bin，可以加快内存的分配和释放操作，因为整个操作都不再需要花费额外的时间去查找合适的bin了。</p>
<p><span style="font-size: 15px;">Unsorted bin的特性如下：</span></p>
<blockquote><p><span style="font-size: 15px;">1) unsorted bin的个数：&nbsp;1个。unsorted bin是一个由free chunks组成的循环双链表。</span></p>
<p><span style="font-size: 15px;">2) Chunk size:&nbsp;在unsorted bin中，对chunk的大小并没有限制，任何大小的chunk都可以归属到unsorted bin中。这就是前言说的特例了，不过特例并非仅仅这一个，后文会介绍。</span></p>
</blockquote>
<h2>五、Small bin<br /></h2>
<p><span style="font-size: 15px;">小于512字节的chunk称之为small chunk，small bin就是用于管理small chunk的。就内存的分配和释放速度而言，small bin比larger bin快，但比fast bin慢。</span></p>
<p><span style="font-size: 15px;">Small bin的特性如下：</span></p>
<p><span style="font-size: 15px;">1) small bin个数：62个。每个small bin也是一个由对应free chunk组成的循环双链表。同时Small bin采用FIFO(先入先出)算法：内存释放操作就将新释放的chunk添加到链表的front end(前端)，分配操作就从链表的rear end(尾端)中获取chunk。</span></p>
<p><span style="font-size: 15px;">2) chunk size:&nbsp;同一个small bin中所有chunk大小是一?样的，且第一个small bin中chunk大小为16字节，后续每个small bin中chunk的大小依次增加8字节，即最后一个small bin的chunk为16 + 62 * 8 = 512字节。</span></p>
<p><span style="font-size: 15px;">3)&nbsp;合并操作：相邻的free chunk需要进行合并操作，即合并成一个大的free chunk。具体操作见下文free(small chunk)介绍。</span></p>
<p><span style="font-size: 15px;">4) malloc(small chunk)操作：类似于fast bins，最初所有的small bin都是空的，因此在对这些small bin完成初始化之前，即使用户请求的内存大小属于small chunk也不会交由small bin进行处理，而是交由unsorted bin处理，如果unsorted bin也不能处理的话，glibc malloc就依次遍历后续的所有bins，找出第一个满足要求的bin，如果所有的bin都不满足的话，就转而使用top chunk，如果top chunk大小不够，那么就扩充top chunk，这样就一定能满足需求了(还记得上一篇文章中在Top Chunk中留下的问题么？答案就在这里)。注意遍历后续bins以及之后的操作同样被large bin所使用，因此，将这部分内容放到large bin的malloc操作中加以介绍。</span></p>
<p><span style="font-size: 15px;">那么glibc malloc是如何初始化这些bins的呢？因为这些bin属于malloc_state结构体，所以在初始化malloc_state的时候就会对这些bin进行初始化，代码如下：</span></p>
<p><span style="font-size: 14px;"></span></p>
<pre><code>malloc_init_state (mstate av)
{
&nbsp; int i;
&nbsp; mbinptr bin;
&nbsp;
&nbsp; /* Establish circular links for normal bins */
&nbsp; for (i = 1; i &lt; NBINS; ++i)
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; bin = bin_at (av, i);
&nbsp; &nbsp; &nbsp; bin-&gt;fd = bin-&gt;bk = bin;
}
……
}<br /></code></pre>
<p><span style="font-size: 15px;">注意在malloc源码中，将bins数组中的第一个<strong>成员索引值设置为了1</strong>，而不是我们常用的0(在bin_at宏中，自动将i进行了减1处理…)。从上面代码可以看出在初始化的时候glibc malloc将所有bin的指针都指向了自己——这就代表这些bin都是空的。</span></p>
<p><span style="font-size: 15px;">过后，当再次调用malloc(small chunk)的时候，如果该chunk size对应的small bin不为空，就从该small bin链表中取得small chunk，否则就需要交给unsorted bin及之后的逻辑来处理了。</span></p>
<p><span style="font-size: 15px;">5) free(small chunk)：当释放small chunk的时候，先检查该chunk相邻的chunk是否为free，如果是的话就进行合并操作：将这些chunks合并成新的chunk，然后将它们从small bin中移除，<strong>最后将新的chunk添加到unsorted bin中</strong>。</span></p>
<h2>六、Large bin<br /></h2>
<p><span style="font-size: 15px;">大于512字节的chunk称之为large chunk，large bin就是用于管理这些large chunk的。</span></p>
<p><span style="font-size: 15px;">Large bin的特性如下：</span></p>
<p><span style="font-size: 15px;">1) large bin的数量：63个。Large bin类似于small bin，只是需要注意两点：一是同一个large bin中每个chunk的大小可以不一样，但必须处于某个给定的范围(特例2)&nbsp;；二是large chunk可以添加、删除在large bin的任何一个位置。</span></p>
<p><span style="font-size: 15px;">在这63个large bins中，前32个large bin依次以64字节步长为间隔，即第一个large bin中chunk size为512~575字节，第二个large bin中chunk size为576 ~ 639字节。紧随其后的16个large bin依次以512字节步长为间隔；之后的8个bin以步长4096为间隔；再之后的4个bin以32768字节为间隔；之后的2个bin以262144字节为间隔；剩下的chunk就放在最后一个large bin中。</span></p>
<p><span style="font-size: 15px;">鉴于同一个large bin中每个chunk的大小不一定相同，因此为了加快内存分配和释放的速度，就将同一个large bin中的所有chunk按照chunk size进行<strong>从大到小的排列</strong>：最大的chunk放在链表的front end，最小的chunk放在rear end。</span></p>
<p><span style="font-size: 15px;">2)&nbsp;合并操作：类似于small bin。</span></p>
<p><span style="font-size: 15px;">3) malloc(large chunk)操作：</span></p>
<p><span style="font-size: 15px;">初始化完成之前的操作类似于small bin，这里主要讨论large bins初始化完成之后的操作。首先确定用户请求的大小属于哪一个large bin，然后判断该large bin中最大的chunk的size是否大于用户请求的size(只需要对比链表中front end的size即可)。如果大于，就从rear end开始遍历该large bin，找到第一个size相等或接近的chunk，分配给用户。如果该chunk大于用户请求的size的话，就将该chunk拆分为两个chunk：前者返回给用户，且size等同于用户请求的size；剩余的部分做为一个新的chunk<strong>添加到unsorted bin中。</strong></span></p>
<p><span style="font-size: 15px;">如果该large bin中最大的chunk的size小于用户请求的size的话，那么就依次查看后续的large bin中是否有满足需求的chunk，不过需要注意的是鉴于bin的个数较多(不同bin中的chunk极有可能在不同的内存页中)，如果按照上一段中介绍的方法进行遍历的话(即遍历每个bin中的chunk)，就可能会发生多次内存页中断操作，进而严重影响检索速度，所以glibc malloc设计了Binmap结构体来帮助提高bin-by-bin检索的速度。Binmap记录了各个bin中是否为空，通过bitmap可以避免检索一些空的bin。如果通过binmap找到了下一个非空的large bin的话，就按照上一段中的方法分配chunk，否则就使用top chunk来分配合适的内存。</span></p>
<p><span style="font-size: 15px;">4) Free(large chunk)：类似于small chunk。</span></p>
<p><span style="font-size: 15px;">了解上面知识之后，再结合下图，就不难理解各类bins的处理逻辑了：</span></p>
<p style="text-align: center;"><img alt="8.jpg" data-original="http://image.3001.net/images/20160525/14641459364705.jpg!small" src="http://www.freebuf.com/buf/themes/freebuf/images/grey.gif" width="690" height="552"></p>
<noscript><img alt="8.jpg" src="http://image.3001.net/images/20160525/14641459364705.jpg!small" width="690" height="552"></p></noscript>
<h2>七、总结<br /></h2>
<p><span style="font-size: 15px;">至此glibc malloc中涉及到的所有显示链表技术已经介绍完毕。鉴于篇幅和精力有限，本文没能详细介绍完所有的技术细节，但是我相信带着这些知识点再去研究glibc malloc的话，定能起到事半功倍的效果。</span></p>
<p><span style="font-size: 15px;">另外，就我个人所了解到的基于堆溢出攻击而言，掌握以上知识，已经足够理解绝大部分堆溢出攻击技术了。因此，后面的文章将会结合这些知识详细介绍各个攻击技术的实现原理。</span></p>
<p><span style="font-size: 15px;">老规矩：如有错误，欢迎斧正！</span></p>
<p><span style="font-size: 15px;"><b>作者：走位@阿里聚安全，转载请注明来自FreeBuf黑客与极客（FreeBuf.COM）</b><br /></span></p>
        </div>
        <div class="article-oper">
        <!-- Baidu Button BEGIN -->
        <div class="share float-l"><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
        <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","weixin","renren","tqq","douban","bdhome","hi","youdao","xg","fbook","twi","deli","linkedin","copy","print"],"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></div>
        <!-- Baidu Button END -->
		<div class="statement">
        <div class="but-col"><span class='wpfp-span'><img src='http://www.freebuf.com/buf/plugins/wp-favorite-posts/img/heart.png' alt='Favorite' title='Favorite' class='wpfp-img' /><img src='http://www.freebuf.com/buf/plugins/wp-favorite-posts/img/loading.gif' alt='Loading' title='Loading' class='wpfp-hide wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=105285' title='收藏该文' rel='nofollow'>收藏该文</a></span></div>
		  </div>
		<span class="score float-r"></span>
        </div>        
        <div class=" panel panel-default author-info">
          <div class="author-detial">
		                <div class="user_photo"><img src="http://image.3001.net/2016/05/5999BF76BE2196E27242F9259C72D8ED.jpg" width="50" height="50" alt="阿里聚安全" class="avatar avatar-50 wp-user-avatar wp-user-avatar-50 photo" /></div>
            <p><span class="name"><a href="http://www.freebuf.com/author/%E9%98%BF%E9%87%8C%E8%81%9A%E5%AE%89%E5%85%A8" title="由 阿里聚安全 发布" rel="author">阿里聚安全</a></span>
			<span class="icon-f"><a href="http://www.freebuf.com/bufer" target="_blank"><img src="http://image.3001.net/images/index/f2.png" title="认证厂商"></a></span>
			<span><i class="colour-red">27</i>篇文章</span><span>等级：<i class="colour-green">5</i>级</span></p>
            <p>阿里巴巴移动安全官方</p>
                      </div>
                    <div class="but">
		  <a href="http://www.freebuf.com/author/阿里聚安全" class="btn btn-default btn-home">个人主页</a>
		  <a href="http://www.freebuf.com/user/pm?pmaction=newmessage&to=阿里聚安全" class="btn btn-default btn-letter">发私信</a>
		  </div>
		          </div>
                        		        <div class="article-pager">
          <ul>
            <li class="previous"><span>上一篇：</span><a href="http://www.freebuf.com/articles/security-management/105166.html" rel="prev">内部威胁那些事儿（二）：系统破坏</a>			</li>
            <li class="next"><span>下一篇：</span>
			<a href="http://www.freebuf.com/articles/network/105633.html" rel="next">内部威胁那些事儿（三）：信息窃取</a>			</li>
          </ul>
        </div>
      </div>
      </div>
          <div class="comment-bright"><div class="main-tit04">
    <h3>这些评论亮了</h3></div>      <ul>      <li>
            <div class="user_photo">             <img src="http://image.3001.net/images/headimg/pic8.png">             </div>
            <div class="tit"><span class="name"> 0ops </span> 
						<span class="explain"></span>
			<span class="reply"><a onclick="return addComment.moveForm( 'comment-','', 'respond','105285' ) " href="?replytocom=#respond" class="comment-reply-link" rel="nofollow">回复</a></span></div>
            <div class="txt">
						下集来了</div>
            <div class="but"><span class="vote-count">)</span><span style="none" id="cos_support-2186633" class="vote-count">7</span><span class="vote-count">(</span><span class="vote">  <a class="ilike_icon" id="vote4-2186633" href="javascript:acv_vote(186633,1,2);">亮了</a></span></div>
          </li>
         </ul></div><div class="comment-list">
      <div class="main-tit02">
		<a rel="nofollow" class="btnbtn-default btn-comment" href="#respond">发表评论</a>
        <h3>已有 <span class="color_red">1</span> 条评论
      </div>
      <ul>
         <li class="comment even thread-even depth-1" id="li-comment-186633">
    <div id="comment-186633">
        <div class="photo">     <img src="http://image.3001.net/images/headimg/pic15.png">     </div>
    <div class="tit"> 
	    <span class="name"> 0ops </span>
        		<span class="explain">  </span>
		<span class="time">&nbsp;2016-05-26</span>
		<span class="time"> </span>
        <span class="useragent_output_custom"></span>
        <span class="useragent_output_custom"></span> 
		<span class="reply">
		        <!-- 正常情况 -->
           <a onclick="return addComment.moveForm( 'comment-186633','186633', 'respond','105285' ) " href="?replytocom=186633#respond" class="comment-reply-link" rel="nofollow">回复</a>
        	    </span>
		<span class="floor">1楼</span>
	</div>
	    <div class="txt">
	  <p class="useragent_output_custom"></p>
      <p>下集来了</p>
<div class="comment-tools">
<div class="vote" id="vote-186633"><span id="acv_stat_186633"></span><a class="ilike_icon"  id="vote4-186633" href="javascript:acv_vote(186633,1);">亮了</a>(<span id="cos_support-186633">7</span>)</div>
<div class="dropup"><a class="dropdown-toggle btn-report" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="display:none;"> 举报</a>
<ul class="dropdown-menu" style="display:none;bottom:auto;">
<li><a data-id="186633" class="click_report" href="javascript:;">广告等垃圾信息</a></li>
<li><a data-id="186633" class="click_report" href="javascript:;">不友善内容</a></li>
<li><a data-id="186633" class="click_report" href="javascript:;">违反法律法规的内容</a></li>
<li><a data-id="186633" class="click_report" href="javascript:;">不宜公开讨论的政治内容</a></li>
<li><a data-id="186633" class="click_report" href="javascript:;">其他</a></li>
</ul></div>
</div>
	</div></div>
</li><!-- #comment-## -->
      </ul>
      <div class="commentnav page01" style="padding-top:10px; text-align: center;">
               </div>
	  
<script src="http://www.freebuf.com/buf/themes/freebuf/js/ajaxfileupload.js" type="text/javascript"></script>
<div id="respond" class="comment-box">
<input type="file" id="uploadUnit" name="upfile" class="hidden" value="">
    <form action="http://www.freebuf.com/wp-comments-post.php" method="post" id="commentform">
        <div id="comment-author-info">
	    <div class="login-other">
		  <div class="login_button login_icon_sina" title="使用新浪微博登陆" onclick="login_button_click('sina')"></div>
          <div class="login_button login_icon_qq" title="使用腾讯QQ登陆" onclick="login_button_click('qq')"></div></div>
        <div class="login-input">
	    <p><label for="author">昵称</label>
		          <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p><span>必须</span><span>您当前尚未登录。<a  class="simplemodal-login" href="http://www.freebuf.com/wp-login.php?redirect_to=http%3A%2F%2Ffreebuf.com%2Farticles%2Fsecurity-management%2F105285.html" title="登陆">登陆？</a><a  href="http://www.freebuf.com/wp-login.php?action=register" target="_blank">注册</a></span></div>
		<div class="login-input">
		  <p><label for="email">邮箱</label><input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required /></p>
		<span>必须（保密）</span>
		</div>
    </div>

        <div id="test" class="post-area">
      <div class="holiday"></div>
	    <div class="comment-editor">
			<a id="comment-smiley" href="javascript:;">表情</a><a href="javascript:;" id="imageThumb">插图</a>
	    </div>
        <div id="smileys" >
           <a title="mrgreen" href="javascript:grin(':mrgreen:')"><img src="http://image.3001.net/images/index/smilies/icon_mrgreen.gif" /></a><a title="razz" href="javascript:grin(':razz:')"><img src="http://image.3001.net/images/index/smilies/icon_razz.gif" /></a><a title="sad" href="javascript:grin(':sad:')"><img src="http://image.3001.net/images/index/smilies/icon_sad.gif" /></a><a title="smile" href="javascript:grin(':smile:')"><img src="http://image.3001.net/images/index/smilies/icon_smile.gif" /></a><a title="oops" href="javascript:grin(':oops:')"><img src="http://image.3001.net/images/index/smilies/icon_redface.gif" /></a><a title="grin" href="javascript:grin(':grin:')"><img src="http://image.3001.net/images/index/smilies/icon_biggrin.gif" /></a><a title="eek" href="javascript:grin(':eek:')"><img src="http://image.3001.net/images/index/smilies/icon_surprised.gif" /></a><a title="???" href="javascript:grin(':???:')"><img src="http://image.3001.net/images/index/smilies/icon_confused.gif" /></a><a title="cool" href="javascript:grin(':cool:')"><img src="http://image.3001.net/images/index/smilies/icon_cool.gif" /></a><a title="lol" href="javascript:grin(':lol:')"><img src="http://image.3001.net/images/index/smilies/icon_lol.gif" /></a><a title="mad" href="javascript:grin(':mad:')"><img src="http://image.3001.net/images/index/smilies/icon_mad.gif" /></a><a title="twisted" href="javascript:grin(':twisted:')"><img src="http://image.3001.net/images/index/smilies/icon_twisted.gif" /></a><a title="roll" href="javascript:grin(':roll:')"><img src="http://image.3001.net/images/index/smilies/icon_rolleyes.gif" /></a><a title="wink" href="javascript:grin(':wink:')"><img src="http://image.3001.net/images/index/smilies/icon_wink.gif" /></a><a title="idea" href="javascript:grin(':idea:')"><img src="http://image.3001.net/images/index/smilies/icon_idea.gif" /></a><a title="arrow" href="javascript:grin(':arrow:')"><img src="http://image.3001.net/images/index/smilies/icon_arrow.gif" /></a><a title="neutral" href="javascript:grin(':neutral:')"><img src="http://image.3001.net/images/index/smilies/icon_neutral.gif" /></a><a title="cry" href="javascript:grin(':cry:')"><img src="http://image.3001.net/images/index/smilies/icon_cry.gif" /></a><a title="?" href="javascript:grin(':?:')"><img src="http://image.3001.net/images/index/smilies/icon_question.gif" /></a><a title="evil" href="javascript:grin(':evil:')"><img src="http://image.3001.net/images/index/smilies/icon_evil.gif" /></a><a title="shock" href="javascript:grin(':shock:')"><img src="http://image.3001.net/images/index/smilies/icon_eek.gif" /></a><a title="!" href="javascript:grin(':!:')"><img src="http://image.3001.net/images/index/smilies/icon_exclaim.gif" /></a>        </div>
         <textarea name="comment" id="comment" cols="100%" rows="7" tabindex="4" style="overflow-x:hidden; overflow-y:hidden; border:0; width:100%;" onkeydown="if(event.ctrlKey&amp;&amp;event.keyCode==13){document.getElementById('submit').click();return false};"></textarea>
    </div>
      <div class="subcon but">
      <input class="btn btn-success" type="submit" name="submit" id="submit" tabindex="5" value="提交评论(Ctrl+Enter)" />
      <a rel="nofollow" class="btn btn-default" id="cancel-comment-reply-link" href="javascript:;">取消</a>
      <div class="checkbox"><input type='hidden' name='comment_post_ID' value='105285' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
<label for="comment_mail_notify" class="comment_mail"><input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked"/>有人回复时邮件通知我</label></div>
      </div>
    <input name="Token" id="Token" type="hidden" value="q9pm92" />
  </form>
  </div>
</div>	  
<div class="commentshow">
<div class="comments-loading">Loading...</div>
</div>
<script language="javascript">
jQuery(document).ready(function($){ //Begin jQuery
    $('.reply').click(function() {
    var atid = '"#' + $(this).parent().attr("id") + '"';
    var atname = $(this).parent().find('span:first').text();
    $("#comment").val("@" + atname + " ").focus();
});
    $('.cancel-comment-reply a').click(function() { //点击取消回复评论清空评论框的内容
    $("#comment").val('');
});
}) 

jQuery(document).ready(function($) {
    $body = (window.opera) ? (document.compatMode == "CSS1Compat" ? $('html') : $('body')) : $('html,body');//commentnav ajax
    $(document).on('click', '.commentnav a', function(e) {
        e.preventDefault();
        $.ajax({
            type: "GET",
            url: $(this).attr('href'),
            beforeSend: function() {
                $('.commentnav').remove();
                $('.comment-list').remove();
                $('.comments-loading').slideDown();
            },
            dataType: "html",
            success: function(out) {
                result = $(out).find('.comment-list');
                nextlink = $(out).find('.commentnav');
                $('.comments-loading').slideUp(550);
                $('.comments-loading').after(result.fadeIn(800));
                $(".comment-list img").each(function(){
                  var url = $(this).attr("data-original");
                  $(this).attr("src",url);
                })
            }
        });
    });    
});
</script>    </div>
        <div class="col-md-3 visible-md-block visible-lg-block">
      <div class="panel panel-default">
        <div class="author-wrap">
          <div class="author-header"><img src="http://image.3001.net/2016/05/5999BF76BE2196E27242F9259C72D8ED.jpg" width="100" height="100" alt="阿里聚安全" class="avatar avatar-100 wp-user-avatar wp-user-avatar-100 photo" /></div>
          <p class="name"><a href="http://www.freebuf.com/author/%E9%98%BF%E9%87%8C%E8%81%9A%E5%AE%89%E5%85%A8" title="由 阿里聚安全 发布" rel="author">阿里聚安全</a><span><a href="http://www.freebuf.com/bufer" target="_blank"><img src="http://image.3001.net/images/index/f2.png" title="认证厂商"></a></span></p>
          <p class="signature">阿里巴巴移动安全官方</p>
          <p class="art-com"><span class="aut-article"><a href="/author/阿里聚安全" target="_blank">27篇文章</a></span><span class="aut-comment"><a href="/author/阿里聚安全?comment=1" target="_blank">4条评论</a></span></p>
        </div>
      </div>
	  <script type="text/javascript">
	          var dispatch = function() {
              q = document.getElementById("q");
              if (q.value != "") {
                  window.open('http://www.freebuf.com/?s=' + q.value, "_blank");
                     return false;
                   } else {
                       return false;
                       }
             }
	  </script>
      <div class="form-group has-active search-col search-in">
        <form id="hpsform-new" class="navbar-search navbar-form" onsubmit="return dispatch()">
          <div class="form-group">
            <input id="q" class="input form-control" type="text" placeholder="关键字查找" autocomplete="off" title="关键字查找" name="q">
            <button class="submit" onclick="INTEL_TYPE_AHEAD.onSubmitHps(' 关键字查找', '/content/www/cn/zh', 'zh_CN')" value="Search" type="submit"></button>
          </div>
        </form>
      </div>
      <div class="ad-right" style="margin-bottom:24px;">
        <a href="http://click.aliyun.com/m/6683/" target="_blank"><img src="http://image.3001.net/images/20161012/14762626001909.jpg" width="263"></a>
      </div>
   
      <div class="panel panel-default">
        <div class="read visible-md-block visible-lg-block">
          <div class="main-tit02">
            <h3>相关阅读</h3>
          </div>		
          <ul>
  <li><a href="http://www.freebuf.com/articles/network/103818.html" target="_blank" title=如何在网络中追踪入侵者（一）：架构>如何在网络中追踪入侵者（一）：架构</a></li>
  
  <li><a href="http://www.freebuf.com/news/topnews/103895.html" target="_blank" title=2016年全球TOP10安全并购案，哪些领域成为大佬的“眼中宝”？>2016年全球TOP10安全并购案，哪些领域成为大佬的“眼中宝”？</a></li>
  
  <li><a href="http://www.freebuf.com/articles/system/105879.html" target="_blank" title=如何用ELK和Wazuh搭建 PCI-DSS（支付卡行业安全标准）>如何用ELK和Wazuh搭建 PCI-DSS（支付卡行业安全标准）</a></li>
  
  <li><a href="http://www.freebuf.com/articles/terminal/104063.html" target="_blank" title=内网渗透防御：如何防御Hash注入攻击>内网渗透防御：如何防御Hash注入攻击</a></li>
  
  <li><a href="http://www.freebuf.com/news/82777.html" target="_blank" title=移动APP安全测试要点解析>移动APP安全测试要点解析</a></li>
  </ul>        </div>
      </div>
      <!--<div class="ad-wrap"><a href="http://www.ijiami.cn/?freebuf.com" target="_blank"><img width="100%" src="http://image.3001.net/images/20141201/14174039186901.jpg"></a></div>-->
      <div class="panel panel-default rec-spe">
        <div class="main-tit03 colour-blue">
          <h3>特别推荐</h3>
        </div>
         
      </div>
	  <div id="mar-right">
      <!--<div class="read visible-lg-block">
        <div class="main-tit04">
          <h3>商城新品</h3>
        </div>
        <div id="slider" class="nivoSlider">  </div>
      </div>-->
      <div class="panel panel-default code"> <img src="http://image.3001.net/images/new/code.jpg" width="192" height="192">
        <p>关注我们  分享每日精选文章</p>
      </div>
	  </div>
    </div>
  </div>
  <div class="row marvellous visible-lg-block">
    <h3>不容错过</h3>
    <ul>
      <li><a href="http://www.freebuf.com/articles/terminal/78699.html" rel="bookmark" title="外卖O2O App安全性分析：App漏洞评估平台技术细节">外卖O2O App安全性分析：App漏洞评估平台技术细节</a>
        <p>		  <span class="name"><a href="http://www.freebuf.com/author/bt0sea" title="由 bt0sea 发布" rel="author">bt0sea</a></span>
		  		<span class="time">2015-09-21</span></p>
      </li>
      <li><a href="http://www.freebuf.com/sectool/103766.html" rel="bookmark" title="CobaltStrike最新版完美破解方法">CobaltStrike最新版完美破解方法</a>
        <p>		  <span class="name"><a href="http://www.freebuf.com/author/dmzlab" title="由 DMZLab 发布" rel="author">DMZLab</a></span>
		  		<span class="time">2016-05-10</span></p>
      </li>
      <li><a href="http://www.freebuf.com/jobs/115236.html" rel="bookmark" title="「知乎」招聘安全人才">「知乎」招聘安全人才</a>
        <p>		  <span class="name"><a href="http://www.freebuf.com/author/%e7%9f%a5%e4%b9%8e%e5%ae%89%e5%85%a8" title="由 知乎安全 发布" rel="author">知乎安全</a></span>
		  		<span class="time">2016-09-26</span></p>
      </li>
      <li><a href="http://www.freebuf.com/news/10704.html" rel="bookmark" title="黑市交易 &#8211; 女性肉鸡价格比男性贵100倍">黑市交易 &#8211; 女性肉鸡价格比男性贵100倍</a>
        <p>		  <span class="name"><a href="http://www.freebuf.com/author/h3lvin" title="由 H3lvin 发布" rel="author">H3lvin</a></span>
		  		<span class="time">2013-06-21</span></p>
      </li>
    </ul>
  </div>
</div>
<script type="text/javascript">
  $(window).load(function() {
    $('#slider').nivoSlider();
  });
  $('#contenttxt img').removeAttr('height');
  $('#contenttxt img').wrap(function(){
    if(!$(this).parent().attr('href')){
      var imgurl = $(this).attr('data-original');
      if(imgurl.substr(-6)=='!small'){
        imgurl = imgurl.substring(0,imgurl.length-6);
      }
      return '<a href="' + imgurl + '" class="highslide-image" onclick="return hs.expand(this);" target="_blank"></a>';
    }
  })
</script>
<script src="http://www.freebuf.com/buf/themes/freebuf/js/comments-ajax.js" type="text/javascript"></script>
<script type="text/javascript" src="http://static.3001.net/js/focus/jquery.nivo.slider.pack.js"></script>
<!----------footer---------->
<div class="footer">
  <div class="container">
    <div class="footer-list col-sm-2 col-md-2">
      <h3>FREEBUF</h3>
      <ul>
        <li><a href="http://www.freebuf.com/dis">免责声明</a></li>
        <li><a href="http://www.freebuf.com/news/others/864.html">关于我们</a></li>
        <li><a href="http://www.freebuf.com/jobs/40386.html">加入我们</a></li>
        <li><a href="http://www.freebuf.com/donate">捐助我们</a></li>
      </ul>
    </div>
    <div class="footer-list col-sm-2 col-md-2">
      <h3>广告及服务</h3>
      <ul>
        <li><a target="_blank" href="mailto:root@freebuf.com">寻求报道</a></li>
        <li><a href="http://www.freebuf.com/advertise">广告合作</a></li>
        <li><a target="_blank" href="mailto:help@freebuf.com">联系我们</a></li>
        <li><a href="http://www.freebuf.com/friends">友情链接</a></li>
      </ul>
    </div>
    <div class="footer-list col-sm-2 col-md-2">
      <h3>关注我们</h3>
      <ul>
        <li><div class="weixin-pannel weixin"><a class="qr" href="javascript:viod(0);"><span class="g-icon-qr1">官方微信</span><i></i></a></div></li>
        <li><a rel="nofollow" target="_blank" href="http://weibo.com/freebuf">新浪微博</a></li>
        <li><a rel="nofollow" target="_blank" href="http://t.qq.com/freebuf">腾讯微博</a></li>
        <li><a rel="nofollow" target="_blank" href="http://twitter.com/freebuf">Twitter</a></li>
      </ul>
    </div>
    <div class="footer-list col-sm-2 col-md-2">
      <h3>赞助商</h3>
      <ul>
        <li style="padding:6px 0 10px;"><a rel="nofollow" target="_blank" href="http://www.aliyun.com/?freebuf"><img src="http://image.3001.net/images/ad/ali.png"></a></li>
        <li><a rel="nofollow" target="_blank" href="http://www.upyun.com/?freebuf"><img src="http://image.3001.net/images/ad/upyun.png"></a></li>
        <li style="padding:6px 0 10px;"><a rel="nofollow" target="_blank" href="https://www.trustasia.com/?freebuf"><img src="http://image.3001.net/images/ad/ad-yzcx.png"></a></li>
      </ul>
    </div>
    <div class="footer-list col-sm-2 col-md-2">
      <ul>
      </ul>
    </div>
    <div class="footer-logo col-sm-2 col-md-2 pull-right"><img src="http://image.3001.net/images/index/freebufrobot_shendanjie.png" ></div>
  </div>
  <div class="copyright"><div class="container"><p>Copyright &copy; 2013 WWW.FREEBUF.COM All Rights Reserved <a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn">沪ICP备13033796号</a></p><span><a rel="nofollow" target="_blank" href="http://click.aliyun.com/m/1336/?freebuf"><img src="http://image.3001.net/images/new/icon-aly.png"></a></span></div></div>
</div>
<div class="bottom_tools"><a id="scrollUp" href="javascript:;" title="飞回顶部"></a></div>
<!----------footer end----------> 
<script src="http://static.3001.net/js/new/backtop.js"></script>
<script type="text/javascript">
jQuery(function(){	
	jQuery('.tabPanes ul li').click(function(){
		jQuery(this).addClass('hit').siblings().removeClass('hit');
		jQuery('.panesl>div:eq('+jQuery(this).index()+')').show().siblings().hide();	
	})
	jQuery('.vulbox-nav').click(function(e) { 
        e.stopPropagation(); 
    });  
})
</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fcc53db168808048541c6735ce30421f5' type='text/javascript'%3E%3C/script%3E"));
</script>
<img alt='css.php' src="http://www.freebuf.com/buf/plugins/cc/css.php?k=3cb185a485c81b23211eb80b75a406fd&amp;o=i&amp;t=1373268050" width='1' height='1' /><script type="text/javascript">
jQuery(function() {
    jQuery(".simditor pre").each(function(i, block){
        hljs.highlightBlock(block);    
    });
    hljs.initHighlightingOnLoad();
});
</script>
<script>
/* <![CDATA[ */
var rcGlobal = {
	serverUrl		:'http://www.freebuf.com',
	infoTemp		:'%REVIEWER% on %POST%',
	loadingText		:'Loading',
	noCommentsText	:'No comments',
	newestText		:'&laquo; 最新',
	newerText		:'&laquo; 新一点',
	olderText		:'旧一点 &raquo;',
	showContent		:'1',
	external		:'1',
	avatarSize		:'32',
	avatarPosition	:'left',
	anonymous		:'Anonymous'
};
/* ]]> */
</script>
<script type='text/javascript' src='http://static.3001.net/js/recentcomments/wp-recentcomments-jquery.js?ver=2.2.3'></script>
</body>
</html>
