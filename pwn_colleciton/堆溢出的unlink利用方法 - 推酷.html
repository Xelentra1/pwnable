<!DOCTYPE HTML>

<!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="tc-auth" content="MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451" />
  <meta content="authenticity_token" name="csrf-param" />
<meta content="kXqzXbeXutoqsg4w3VDjXHsJAWF1uju55CWdbulczKM=" name="csrf-token" />
    <title>
            堆溢出的unlink利用方法 - 推酷
   </title>
    <meta name="description" content="堆溢出的unlink利用方法"/>
  <link rel="shortcut icon" href="http://static0.tuicool.com/favicon.ico" type="image/x-icon" />
  <link href="http://static0.tuicool.com/images/icon114.png" rel="Bookmark" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://static1.tuicool.com/images/icon57.png" /> 
  <link rel="apple-touch-icon" sizes="72x72" href="http://static2.tuicool.com/images/icon72.png" />  
  <link rel="apple-touch-icon" sizes="114x114" href="http://static0.tuicool.com/images/icon114.png" />    
  <link rel="apple-touch-icon" sizes="144x144" href="http://static1.tuicool.com/images/icon144.png"/>  
  <link href="http://asset.tuicool.com/assets/application-79535689d4effa45d2ea7ede6503dd7f.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="http://static0.tuicool.com/assets/font-awesome.min.css" rel="stylesheet">
  <script src="http://asset.tuicool.com/assets/application-7edeeea3a20493861059090224f774ae.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="http://assets.tuicool.com/assets/font-awesome-ie7.min.css">
  <![endif]--> 
    <script type="text/javascript" src="http://static2.tuicool.com/assets/tip.js?t=3"></script>
  
  <script type="text/javascript" src="http://static1.tuicool.com/assets/spin.min.js"></script>
<link rel="stylesheet" href="http://static0.tuicool.com/assets/github.css">

</head>
<body>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="http://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="http://www.tuicool.com/a/">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="http://www.tuicool.com/sites">
                  站点
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="http://huodong.tuicool.com/">
                  活动
                </a>
              </li>
                  <li class="">
                    <a href="http://course.tuicool.com/">
                      公开课
                    </a>
                  </li>
              <li class="">
                <a href="http://www.tuicool.com/mobile">
                  APP
                </a>
              </li>
              <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="http://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="http://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="http://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="http://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="http://www.tuicool.com/mags/guru">Guru Weekly</a></li> 
                  <li><a href="http://www.tuicool.com/articles/weekly">一周拾遗</a></li>                  
                </ul>
              </li>
              
              </ul>
            <form class="navbar-search pull-left" action="http://www.tuicool.com/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索">
            </form>
            <ul class="nav pull-right">
                          
                <li class="dropdown">         
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    <img alt="wolfzhang" src="http://static0.tuicool.com/images/0m.png">
                    wolfzhang
                    <b class="caret"></b>
                  </a>
                  <ul class="dropdown-menu">
                    <li><a href='http://www.tuicool.com/user/462071652'>我的主页</a></li>
                    <li><a href='http://www.tuicool.com/articles/my'>我的收藏</a></li>
                    <li><a href="http://www.tuicool.com/settings">个人设置</a></li>           
                    <li><a href="http://www.tuicool.com/notifications">消息通知</a></li>
                    <li><a href="http://www.tuicool.com/bbs/go/issues">意见反馈</a></li>
                    <li><a href="http://www.tuicool.com/logout">退出</a></li>
                  </ul>
                </li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id ="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>堆溢出的unlink利用方法</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间&nbsp;2015-07-22 14:18:23
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="/sites/a2UJrq" target="_blank">WooYun知识库
                    </a>
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="http://drops.wooyun.org/tips/7326?utm_source=tuicool&amp;utm_medium=referral" style="display:inline-block;">http://drops.wooyun.org/tips/7326</a>
            </div>
            <div>
                <span>主题</span>
                <a href="/topics/11000086" target='_blank' >
                    <span class="new-label">安全技术</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div ng-bind-html="postContentTrustedHtml">
  <h2>0x00 背景</h2>
  <p>本文写给对堆溢出无的放矢的童鞋，分为如下几部分：</p>
  <pre class="prettyprint"><code>一.经典的unlink利用方法简介
二.在当今glibc的保护下如何绕过进行unlink利用
</code></pre>
  <p>
建议阅读本文之前先对glibc的    <code>malloc.c</code>
有所了解  </p>
  <p>
    <a href="http://code.woboq.org/userspace/glibc/malloc/malloc.c.html" rel="nofollow,noindex">你可以在这里在线看到所有的malloc.c的源码</a>
  </p>
  <h2>0x01 第一部分</h2>
  <p>首先简要介绍一下堆chunk的结构</p>
  <p>
我们可以在    <code>malloc.c</code>
中找到关于堆    <code>chunk</code>
结构的代码  </p>
  <pre class="prettyprint"><code>#!c
struct malloc_chunk {
	INTERNAL_SIZE_T	prev_size;  /* Size of previous chunk (if free).  */
	INTERNAL_SIZE_T	size;	 /* Size in bytes, including overhead. */
	struct malloc_chunk* fd;	   /* double links -- used only if free. */
	struct malloc_chunk* bk;
	/* Only used for large blocks: pointer to next larger size.  */
	struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */
	struct malloc_chunk* bk_nextsize;
    };
</code>
</pre>
  <p>
这指明了一个    <code>heap chunk</code>
是如下的结构  </p>
  <pre class="prettyprint"><code>#!c
+-----------+---------+------+------+-------------+
|           |         |      |      |             |
|           |         |      |      |             |
| prev_size |size&Flag|  fd  |  bk  |             |
|           |         |      |      |             |
|           |         |      |      |             |
+-----------+---------+------+------+-------------+
</code></pre>
  <p>
如果本    <code>chunk</code>
前面的    <code>chunk</code>
是空闲的，那么第一部分    <code>prev_size</code>
会记录前面一个    <code>chunk</code>
的大小，第二部分是本    <code>chunk</code>
的    <code>size</code>
,因为它的大小需要8字节对齐，所以    <code>size</code>
的低三位一定会空闲出来，这时候这三个位置就用作三个    <code>Flag</code>
(最低位:指示前一个    <code>chunk</code>
是否正在使用;倒数第二位:指示这个    <code>chunk</code>
是否是通过    <code>mmap</code>
方式产生的;倒数第三位:这个    <code>chunk</code>
是否属于一个线程的    <code>arena</code>
)。之后的FD和BK部分在此    <code>chunk</code>
是空闲状态时会发挥作用。FD指向下一个空闲的    <code>chunk</code>
，BK指向前一个空闲的    <code>chunk</code>
，由此串联成为一个空闲    <code>chunk</code>
的双向链表。如果不是空闲的。那么从fd开始，就是用户数据了。(详细信息请参考    <code>glibc</code>
的    <code>malloc.c</code>
部分，在此不再多做解释。)  </p>
  <p>首先，为了方便，我直接引用一位外国博主的漏洞示例程序，以便继续解释</p>
  <pre class="prettyprint"><code>#!c
/* 
 Heap overflow vulnerable program. 
 */
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
int main( int argc, char * argv[] )
{
	char * first, * second;
/*[1]*/ first = malloc( 666 );
/*[2]*/ second = malloc( 12 );
	if(argc!=1)
/*[3]*/	 strcpy( first, argv[1] );
/*[4]*/ free( first );
/*[5]*/ free( second );
/*[6]*/ return( 0 );
}
</code>
</pre>
  <p>
这个程序在[3]处有很明显的堆溢出漏洞，    <code>argv[1]</code>
中的内容若过长则会越界覆盖到second部分。  </p>
  <p>简单给出此程序的堆结构</p>
  <pre class="prettyprint"><code>#!c
+---------------------+   &lt;--first chunk ptr
|     prev_size       |
+---------------------+
|     size=0x201      |          
+---------------------+   &lt;--first                  
|                     |
|     allocated       |         
|      chunk          |      
+---------------------+   &lt;--second chunk ptr                
|    prev_size        |         
+---------------------+                     
|    size=0x11        |         
+---------------------+   &lt;--second                  
|     Allocated       |         
|       chunk         |     
+---------------------+   &lt;-- top                  
|     prev_size       |            
+---------------------+                     
|    size=0x205d1     |           
+---------------------+                      
|                     |
|                     |
|                     |
|        TOP          |   
|                     |
|       CHUNK         |    
|                     |
+---------------------+
</code></pre>
  <p>此处不赘余介绍exploit具体代码，只介绍利用方法.</p>
  <p>只要我们通过溢出构造，使得second chunk</p>
  <pre class="prettyprint"><code>#!c
prev_size=任意值
size=-4(因为最低位的flag没有设置，所以prev_size是什么值是无所谓了)
fd=free@got-12(修改got的原理不清楚的同学可以查阅一下“延迟绑定技术”)
bk=shellcode地址
</code></pre>
  <p>在我们的payload将指定位置的数值改好后。下面介绍在[4][5]行代码执行时发生的详细情况。</p>
  <p>
第四行执行    <code>free(first)</code>
发生如下操作  </p>
  <p>1).检查是否可以向后合并</p>
  <p>
首先需要检查    <code>previous chunk</code>
是否是空闲的（通过当前    <code>chunk size</code>
部分中的    <code>flag</code>
最低位去判断），当然在这个例子中，前一个    <code>chunk</code>
是正在使用的，不满足向后合并的条件。  </p>
  <p>2).检查是否可以向前合并</p>
  <p>
在这里需要检查    <code>next chunk</code>
是否是空闲的(通过下下个    <code>chunk</code>
的flag的最低位去判断)，在找下下个chunk(这里的下、包括下下都是相对于    <code>chunk first</code>
而言的)的过程中，首先当前    <code>chunk+</code>
当前    <code>size</code>
可以引导到下个    <code>chunk</code>
，然后从下个    <code>chunk</code>
的开头加上下个    <code>chunk</code>
的    <code>size</code>
就可以引导到下下个    <code>chunk</code>
。但是我们已经把下个    <code>chunk</code>
的    <code>size</code>
覆盖为了-4，那么它会认为下个    <code>chunk</code>
从    <code>prev_size</code>
开始就是下下个chunk了，既然已经找到了下下个    <code>chunk</code>
，那就就要去看看    <code>size</code>
的最低位以确定下个    <code>chunk</code>
是否在使用，当然这个    <code>size</code>
是    <code>-4</code>
，所以它指示下个    <code>chunk</code>
是空闲的。  </p>
  <p>
在这个时候，就要发生向前合并了。即    <code>first chunk</code>
会和    <code>first chunk</code>
的下个    <code>chunk</code>
(即    <code>second chunk</code>
)发生合并。在此时会触发    <code>unlink(second)</code>
宏，想将    <code>second</code>
从它所在的    <code>bin list</code>
中解引用。  </p>
  <p>具体如下</p>
  <pre class="prettyprint"><code>#!c
BK=second-&gt;bk（在例子中bk实际上是shellcode的地址）
FD=second-&gt;fd (在例子中fd实际上是free@got的地址 - 12)
FD-&gt;bk=BK
/*shellcode的地址被写进了FD+12的位置，但是FD是free@got的地址-12，所以实际上我们已经把shellcode地址写入了free@got*/
BK-&gt;fd=FD 
</code></pre>
  <p>
执行    <code>unlink</code>
宏之后，再调用    <code>free</code>
其实就是调用    <code>shellcode</code>
，这时就可以执行任意命令了。  </p>
  <p>
但是，在现如今，    <code>glibc</code>
已经不这么简单了，为了使堆溢出不那么容易就被利用，它加入了许多新的保护措施，如何绕过也就是要在第二部分中讨论的内容。  </p>
  <h2>0x02 第二部分</h2>
  <p>以glibc中的代码作为示例，首先拿出最新版本的unlink宏。</p>
  <pre class="prettyprint"><code>#!c
1413    /* Take a chunk off a bin list */
1414    #define unlink(AV, P, BK, FD) {                                            
1415        FD = P-&gt;fd;                                                                      
1416        BK = P-&gt;bk;                                                                      
1417        if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                      
1418          malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  
1419        else {                                                                      
1420            FD-&gt;bk = BK;                                                              
1421            BK-&gt;fd = FD;                                                              
1422            if (!in_smallbin_range (P-&gt;size)                                      
1423                && __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) {                      
1424                if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)              
1425                    || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    
1426                  malloc_printerr (check_action,                                      
1427                                   &quot;corrupted double-linked list (not small)&quot;,    
1428                                   P, AV);                                              
1429                if (FD-&gt;fd_nextsize == NULL) {                                      
1430                    if (P-&gt;fd_nextsize == P)                                      
1431                      FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                      
1432                    else {                                                              
1433                        FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                              
1434                        FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                              
1435                        P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                              
1436                        P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                              
1437                      }                                                              
1438                  } else {                                                              
1439                    P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                      
1440                    P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                      
1441                  }                                                                      
1442              }                                                                      
1443          }                                                                              
1444    }
1445    
1446    /*
</code></pre>
  <p>我们可以看到我们最大的阻碍是下面的这部分代码</p>
  <pre class="prettyprint"><code>#!c
if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                     
      malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P);
</code></pre>
  <p>
这段代码被添加到了    <code>unlink</code>
宏中，所以现在再调用    <code>unlink</code>
宏的时候，    <code>chunk</code>
指针    <code>P-&gt;fd-&gt;bk</code>
(即代码中的大写    <code>FD-&gt;bk</code>
)应该还是p指针自己。对于    <code>BK-&gt;fd != p</code>
这部分也是同样的道理。  </p>
  <p>在第一部分的利用方法中，我们修改了</p>
  <pre><code>#!c
p-&gt;fd=free@got-12
p-&gt;bk=shellcode_adress
</code></pre>
  <p>
我们在此记    <code>FD=p-&gt;fd</code>
,    <code>BK=p-&gt;bk</code>
,再去看    <code>FD-&gt;bk</code>
已经是    <code>free@got</code>
了，这部分是不能满足要求的。再看    <code>BK-&gt;fd</code>
已经是    <code>shellcode+16</code>
了,所以如上文的利用方法已经不能成功了。之所以还加以介绍，是因为这会使我们理解第二部分变得又快又好。  </p>
  <p>
如果绕过还是要根据这段保护代码来谈。我们势必需要构造合适的条件的来过掉这行代码，那么就要找一个指向    <code>p</code>
的的已知的地址，然后根据这个地址去设置伪造的fd和bk指针就能改掉原    <code>p</code>
指针。  </p>
  <p>以64bit为例,假设找到了一个已知地址的ptr是指向p(p指向堆上的某个地方)的，通过堆溢出，我们可以做如下的修改。</p>
  <pre><code>#!c
p-&gt;fd=ptr-0x18
p-&gt;bk=ptr-0x10
</code></pre>
  <p>布置好如此结构后，再触发unlink宏，会发生如下情况。</p>
  <pre class="prettyprint"><code>#!c
1.FD=p-&gt;fd(实际是ptr-0x18)
2.BK=p-&gt;bk(实际是ptr-0x10)
3.检查是否满足上文所示的限制，由于FD-&gt;bk和BK-&gt;fd均为*ptr(即p)，由此可以过掉这个限制
4.FD-&gt;bk=BK
5.BK-&gt;fd=FD(p=ptr-0x18)
</code></pre>
  <p>
这时候再对p进行写入，可以覆盖掉p原来的值，例如我们用合适的    <code>payload</code>
将    <code>free@got</code>
写入。p就变成了    <code>free@got</code>
，那么再改一次p，把    <code>free@got</code>
改为    <code>shellcode</code>
的地址或者说    <code>system</code>
的地址都可以。之后再调用free功能，就可以任意命令执行。  </p>
  <p>
为了方便，在这边拿出一个最近的    <code>wargame</code>
出现的一个逻辑非常简单的程序作为漏洞示例程序,    <a href="https://www.dropbox.com/s/ifjua544gd4js41/shellman?dl=0" rel="nofollow,noindex">可以在此下载</a>
  </p>
  <p>首先简单介绍这个Binary的功能以及基本情况</p>
  <p>开启的保护</p>
  <pre class="prettyprint"><code>RELRO    STACK CANARY    NX          PIE     RPATH    RUNPATH    FILE
No RELRO No canary found NX enabled  No PIE  No RPATH No RUNPATH shellman
</code></pre>
  <p>基本功能</p>
  <pre class="prettyprint"><code>1.显示已经建立的堆块中存储的内容
2.建立一个新的堆块，大小和内容又用户决定
3.对一个已经分配的堆块做编辑，这个地方没有限制大小，若太长可造成堆溢出
4.释放一个已经分配的堆块
</code></pre>
  <p>存放的堆块的基本逻辑结构</p>
  <pre class="prettyprint"><code>.bss:00000000006016C0 ; __int64 usingFLAG[]
.bss:00000000006016C0 usingFLAG       dq ?                    ; DATA XREF: main+38o
.bss:00000000006016C0                                         ; .text:0000000000400A90o ...
.bss:00000000006016C8 ; __int64 LEN[]
.bss:00000000006016C8 LEN             dq ?                    ; DATA XREF: new+B5w
.bss:00000000006016C8                                         ; delete+79w
.bss:00000000006016D0 ; __int64 content[]
.bss:00000000006016D0 content         dq ?                    ; DATA XREF: new+BCw
</code></pre>
  <p>程序有一个全局数组会存储好每一个经过malloc分配的堆块返回的指针。以及在全局数组中存储长度以及本块是否正在使用的标志。</p>
  <p>如何利用</p>
  <p>按照前文所介绍的，我们希望使用Unlink的方法去利用这个堆溢出漏洞。首先，我们要找一个指向堆上某处的指针。因为存储malloc返回指针的全局数组的存在，这让我们的利用变得异常的简单。因为bss段的地址也是固定的，我们可以知道，从而设置满足需要的bk和fd指针，下面介绍具体步骤。</p>
  <p>1.我们可以首先分配两个长度合适的堆块。(如下图所示)</p>
  <pre class="prettyprint"><code>chunk0                malloc返回的ptr        chunk1        malloc返回的ptr
|                     |                     |             |
+-----------+---------+---+---+-------------+------+------+----+----+------+
|           |         |   |   |             |      |      |    |    |      |
|           |         |   |   |             | prev | size&|    |    |      |
| prev_size |size&Flag|   |   |             | size | flag |    |    |      |
|           |         |   |   |             |      |      |    |    |      |
|           |         |   |   |             |      |      |    |    |      |
+-----------+---------+---+---+-------------+------+------+----+----+------+
</code></pre>
  <p>这时候这两块的fd和bk区域其实都是空的，因为他们都是正在使用的</p>
  <p>2.对第一块进行编辑，编辑的过程中设置好第零块的bk和fd指针并溢出第一块，改好第一块的chunk头的控制信息(如下图所示)</p>
  <pre class="prettyprint"><code>chunk0                malloc返回的ptr           chunk1        malloc返回的pt
|                     |                        |             |
+-----------+---------+----+----+----+----+----+------+------+----+----+------+
|           |         |fake|fake|fake|fake| D  | fake | fake |    |    |      |
|           |         |prev|size| FD | BK | A  | prev | size&|    |    |      |
| prev_size |size&Flag|size|    |    |    | T  | size | flag |    |    |      |
|           |         |    |    |    |    | A  |      |      |    |    |      |
|           |         |    |    |    |    |    |      |      |    |    |      |
+-----------+---------+----+----+----+----+----+------+------+----+----+------+
                      |--------new_size--------|
</code></pre>
  <p>
我们为了欺骗glibc，让它以为堆块零malloc返回的指针(我们后文中简记为p)出就是chunk0指针，所以我们伪造了prev_size和size的部分，然后溢出堆块1，改掉第1个堆块的prev_size,数值应该是上图所示    <code>new_size</code>
的大小；另外第1块的size部分还要把prev_inuse的flag给去掉。如此就做好了unlink触发之前的准备工作  </p>
  <p>3.删掉chunk1,触发unlink(p)，将p给改写。</p>
  <p>在删除堆块1时，glib会检查一下自己的size部分的prev_inuse FLAG，发现到到比较早的一个chunk是空闲的(实际是我们伪造的)，glibc希望将即将出现的两个空闲块合并。glibc会先将chunk0从它的Binlist中解引用，所以触发unlink(p)。</p>
  <pre class="prettyprint"><code>1).FD=p-&gt;fd(实际是0x6016D0-0x18,因为全局数组里面指向p的那个指针就是0x6016D0)
2).BK=p-&gt;bk(实际是6016D0-0x10)
3).检查是否满足上文所示的限制，由于FD-&gt;bk和BK-&gt;fd均为*6016D0(即p)，由此可以过掉这个限制
4).FD-&gt;bk=BK
5).BK-&gt;fd=FD(p=0x6016D0-0x18)
</code></pre>
  <p>4.对p再次写入，修改p为free@got地址</p>
  <p>5.现在p已经是free@got了，我们只要使用一次List功能便可以知道free函数的真实地址，进而算出libc的基址来过掉ASLR。</p>
  <p>6.根据已经算出的libc基址再次算出system函数的真实地址。向p再次写入便可以将free@got改为system函数。 (如果没有libc，可以考虑简历多个chunk，在改p为free@got时候将其他的堆块的指针也改为libc里面的函数，这样在list时，我们可以得到两个libc函数的真实地址，根据其偏移，便可以找出服务器上的libc，若保护再够复杂无法改got，我们还可以构造ropchain，同样利用这样的方式，把ropchain丢进全局数组中)</p>
  <p>
7.因为free已经变成了system，只要再建立一个内容为    <code>/bin/sh</code>
的块，再删掉，就可以得到shell，由此全部利用完成。  </p>
</div>

        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="E3Ezu2u">  </div>

</div>
        <div id="share_weixin_image">
            <img width="100px" height="100px" src="http://s.jiathis.com/qrcode.php?url=http://www.tuicool.com/articles/E3Ezu2u?via=wechat_qr">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id"  title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id"  title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="E3Ezu2u">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="E3Ezu2u" uid="462071652">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript">
$("#share_weibo_id").click( function() {
   window.open("http://share.baidu.com/s?type=text&searchPic=0&sign=on&to=tsina&url=http://www.tuicool.com/articles/E3Ezu2u&title=%E5%A0%86%E6%BA%A2%E5%87%BA%E7%9A%84unlink%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95++%28%E5%88%86%E4%BA%AB%E8%87%AA+%40%E6%8E%A8%E9%85%B7%E7%BD%91%29&key=3113829255");
});
$("#share_qq_id").click( function() {
   window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.tuicool.com/articles/E3Ezu2u&title=%E5%A0%86%E6%BA%A2%E5%87%BA%E7%9A%84unlink%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95&desc=&summary=&site=");
});
$("#share_weixin_id").click( function() {
  $("#share_weixin_image").toggle();
});
</script>


        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="/articles/2ABVbez" target="_blank" title="Python3实现TCP端口扫描器">
                    Python3实现TCP端口扫描器
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="/articles/Anaea26" target="_blank" title="【建议收藏】黑客基础必学命令行！">
                    【建议收藏】黑客基础必学命令行！
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="/articles/2qiIfu" target="_blank" title="浅析互联网后最具颠覆性创新技术——区块链安全">
                    浅析互联网后最具颠覆性创新技术——区块链安全
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="/articles/UrANNvR" target="_blank" title="Android系统新权限模型剖析与预警">
                    Android系统新权限模型剖析与预警
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="/articles/AfeiY3E" target="_blank" title="Chrome浏览器地址栏欺骗漏洞(CVE-2016-1707)">
                    Chrome浏览器地址栏欺骗漏洞(CVE-2016-1707)
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="/articles/iUfyiuq" target="_blank" title="揭秘花招最多的三种敲诈者木马">
                    揭秘花招最多的三种敲诈者木马
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"></div>
        <div id="article_weibo" style="display:none;">
            <div class='article-part-title'>
                <span>相关微博</span>
                <sub>
                    <a href="/articles/weibo_list/E3Ezu2u" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
           <textarea name="comment[body]" id="comment-body" cols="60" rows="6" placeholder="请输入评论内容..." style="resize: none;"></textarea>
           <a href="javascript:commentsub();" class="btn btn-medium btn-submit" id="comment-submit">发表评论</a>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt"></span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail">
        评论加载失败，<a href="javascript:reload_comments('E3Ezu2u',1,0,1);">重新加载</a>
        <img src="http://static1.tuicool.com//images/spinner.gif" id="spinner3"/>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="http://stimg2.tuicool.com/a2UJrq.png"/>
        </div>
        <div class="name">
            <div>
                <a href="/sites/a2UJrq" target="_blank"> WooYun知识库</a>
            </div>
            <div>
                <div class="btn right_site_follow" >已订阅</div>
            </div>
        </div>
    </div>
</div>

<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="/articles/2ABVbez" target="_blank" title="Python3实现TCP端口扫描器"> Python3实现TCP端口扫描器 </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="/articles/Anaea26" target="_blank" title="【建议收藏】黑客基础必学命令行！"> 【建议收藏】黑客基础必学命令行！ </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="/articles/2qiIfu" target="_blank" title="浅析互联网后最具颠覆性创新技术——区块链安全"> 浅析互联网后最具颠覆性创新技术——区块链安全 </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="/articles/AfeiY3E" target="_blank" title="Chrome浏览器地址栏欺骗漏洞(CVE-2016-1707)"> Chrome浏览器地址栏欺骗漏洞(CVE-2016-1707) </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="/articles/iUfyiuq" target="_blank" title="揭秘花招最多的三种敲诈者木马"> 揭秘花招最多的三种敲诈者木马 </a>
        </li>
    </ul>
</div>
<div class="right-link">
      <a href="https://www.teambition.com/?utm_source=tuicool&utm_medium=banner01" target="_blank"><img src="http://static2.tuicool.com/images/upload/teambition120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiandaoyun.com/?f=tc" target="_blank"><img src="http://static0.tuicool.com/images/upload/jiandaoyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://click.aliyun.com/m/6128/" target="_blank"><img src="http://static1.tuicool.com/images/upload/aliyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 0px">
      <a href="http://www.toushibao.com/landing.html?utm_source=tuicoolwenzhang&utm_medium=guanggao&utm_campaign=tuicoolwenzhang.guanggao.tsbxgn" target="_blank"><img src="http://static1.tuicool.com/images/upload/jiankongbao120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.handone.com/?f=tc" target="_blank"><img src="http://static1.tuicool.com/images/upload/handone300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.daocloud.io/cloud/voice.html?utm_source=tuicool&utm_medium=banner%20&utm_campaign=daovoicecampaign" target="_blank"><img src="http://static1.tuicool.com/images/upload/daocloud300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiguang.cn/devservice/?from=tuicool01" target="_blank"><img src="http://static1.tuicool.com/images/upload/jpush120.jpg"/></a>

</div>
<div class="frd_pos">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-7054762349007490"
     data-ad-slot="5705695566"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>

         </div>
</div>

<div>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="E3Ezu2u" class="article-id" /> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true" style="margin-right: 15px">取消</button>
  </div>
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name"  placeholder="推刊名(必填)" required data-validation-required-message="请填写推刊名" />
    <span class="new-ness-name">请填写推刊名</span>
    <br/>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br/>
    权限设置：<input type="radio" name="type" value="1" checked="checked" /> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled>创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="E3Ezu2u" id="article-correct-source">
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="标题不准确">标题不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="排版有问题">主题不准确</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="图片无法显示">图片无法显示</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="与原文不一致">与原文不一致</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span4"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            &nbsp;&nbsp;提交&nbsp;&nbsp;
        </button>
    </div>
</div>
    <div class="share_zone">
    <div class="bdsharebuttonbox"> 
         <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_more" data-cmd="more"></a>
     </div>
    <script>
        window._bd_share_config = {
            "common" : {
                "bdSnsKey" : {
                    "tsina" : "3113829255",
                    "tqq" : "801536792"
                },
                "bdText" : "堆溢出的unlink利用方法 (分享自 @推酷网)",
                "bdMini" : "2",
                "bdMiniList" : false,
                "bdPic" : "",
                "bdStyle" : "1",
                "bdSize" : "24"
            },
            "slide" : {
                "type" : "slide",
                "bdImg" : "1",
                "bdPos" : "left",
                "bdTop" : "200"
            }
        };
        with (document)
        0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>

<style type="text/css">
    .btn-large {
        padding: 0;
    }
    .load-fail {
        display: none;
    }
</style>
<script src="http://static1.tuicool.com//assets/highlight.pack.js"></script>
<script type="text/javascript">
    $('table').each(function(i) {
        var size = $(this).children().size();
        if (size > 1) {
            $(this).attr('class',"table table-bordered");
        } else if (size == 1) {
            var e11 = $(this).children(":first");
            var e1 = e11[0];
            var name = e1.nodeName.toLowerCase();
            if ("tbody" == name) {
                if (e1.children.length > 1) {
                    $(this).attr('class',"table table-bordered");
                } else if (e1.children.length == 1){
                    var e12 = e1.children[0];
                    var name2 = e12.nodeName.toLowerCase();
                    if ("tr" == name2) {
                       if (e12.children.length > 1) {
                         $(this).attr('class',"table table-bordered");
                       }
                    }
                }
            }
        }
    });
        window.page = 0;
        window.last = 0;    
        window.first = true;
        resize_article_image('#nei', 550);
                load_comments("E3Ezu2u",1,0,"MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451");
                window.uid = parseInt("155792");
        open_add_article_to_kan("true");
        async_do_zan_article(); 
        $('pre').each(function(i, e) {
            hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
        });
       
          function commentsub(){  
    $.ajaxSetup({
    error:function(x,e){        
      $('.comment-alert').text("系统出现问题，请稍候再试").show();
      $('textarea').attr('disabled',false);
      return false;
    },
    headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    }
  }); 
    $("#comment-body").attr("disabled",true);
    $("#comment-submit").addClass("disabled");
    $("#comment-submit").attr("href","#comment-body");
    text = $("#comment-body").val();
    if(text.length < 2 ){
        $('.comment-alert').text("你的字数太少了").show();
        reset_submit_btn();
    }else if(text.length > 500){
        $('.comment-alert').text("你的字数太多了,不能超过500字!").show();
        reset_submit_btn();
    }else{      
    $.post("/comments.json", { aid: "E3Ezu2u", html_body: $("#comment-body").val(), auth: "MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451"},function(data){
      if(data.success == true){
        $(".comments-list").show();
        var aComment = data.comment;
        var text = aComment.content;
        var id = "E3Ezu2u";
        var title = "堆溢出的unlink利用方法";
        var share_code = "<ul class='dropdown-menu'><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tsina&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>新浪微博</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tqq&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @tuicool）'>腾讯微博</a></li><li><a target='blank' href='http://s.evernote.com/grclip?url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>印象笔记</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=douban&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>豆瓣</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=renren&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>人人网</a></li></ul>"
        $(".comments-list").prepend("<div class='single' id='c-"+aComment.id+"'><img src='"+aComment.avatar+"' class='img avatar'><div class='comment-item' style='padding:0 0 0 5px;'><div class='info mine'>"+"<a class='uname' href='/user/"+ aComment.uid+ "' target='_blank'>"+ aComment.username  +"</a>" +"<span class='timestamp'>" +aComment.timestamp +"</span> <div class='reply dropdown'><a class='dropdown-toggle share' data-toggle='dropdown' href='javascript:share("+aComment.id+");'>分享<b class='caret'></b></a> | <a href='javascript:reply(\""+aComment.username+"\");'>回复</a>"+share_code+"</div> "+ "</div><div class='body' id='comment-"+aComment.id+"'>" + aComment.content + "</div></div></div>");
        $("#comment-body").attr("disabled",false).val("");
        $("#comment-submit").removeClass("disabled");
        $("#comment-submit").attr("href","javascript:commentsub();");
        location = "#c-"+aComment.id
        $('.empty-cmts').hide();
        $('.comment-alert').hide();
        $('.comment_cnt').text(parseInt($('.comment_cnt').text())+1);
       } else{
        $('.comment-alert').text(data.error).show();
        reset_submit_btn();
       }
    },"json");
    }
}
function reset_submit_btn() {
  $('textarea').attr('disabled',false);
  $("#comment-submit").removeClass("disabled");
  $("#comment-submit").attr("href","javascript:commentsub();");
}

       handle_follow_site("#my_follow","已订阅","+ 订阅");
</script>


    <div class="loader-inner ball-pulse ball-loading-center" id="page-loading" style="display: none">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="read-later-alert"></div>
  </div>

    <div class="footer">
    <div class="footer-inner">
    <dl class="about-link site-link">
        <dt>
            网站相关
        </dt>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/about">关于我们</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/mobile">移动应用</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/bbs/go/issues">建议反馈</a>
        </dd>
    </dl>
    <dl class="site-link follow-link">
        <dt>
            关注我们
        </dt>
        <dd>
            <a target="_blank" href="http://e.weibo.com/tuicool2012"><img src="http://static1.tuicool.com/images/weibo-32.png">推酷网</a>
        </dd>
        <dd><img src="http://static1.tuicool.com/images/weixin-32.png">tuicool2012
        </dd>
    </dl>
    <dl class="site-link links">
        <dt>
            友情链接
        </dt>
        <dd>
                <a href="http://www.woshipm.com/" title="人人都是产品经理" target="_blank">人人都是产品经理</a>
                <a href="http://www.pm265.com/" title="PM256" target="_blank">PM256</a>
                <a href="http://www.yidonghua.com/" title="移动信息化" target="_blank">移动信息化</a>
                <a href="http://www.snsiu.com/" title="行晓网" target="_blank">行晓网</a>
                <a href="http://www.taskcity.com/" title="智城外包网" target="_blank">智城外包网</a>
                <a href="http://www.huxiu.com/" title="虎嗅" target="_blank">虎嗅</a>
                <a href="http://www.iterduo.com/" title="IT耳朵" target="_blank">IT耳朵</a>
                <a href="http://mediaworks.caixin.com/" title="创媒工场" target="_blank">创媒工场</a>
                <a href="http://www.managershare.com/" title="经理人分享" target="_blank">经理人分享</a>
                <a href="http://www.shichangbu.com/" title="市场部网" target="_blank">市场部网</a>
                <a href="http://www.ikanchai.com/" title="砍柴网" target="_blank">砍柴网</a>
                <a href="http://www.cocoachina.com/" title="CocoaChina" target="_blank">CocoaChina</a>
                <a href="http://www.ibeifeng.com/" title="北风网" target="_blank">北风网</a>
                <a href="http://www.jiankongbao.com/" title="云智慧" target="_blank">云智慧</a>
                <a href="http://www.wyzc.com" title="我赢职场" target="_blank">我赢职场</a>
                <a href="http://www.thebigdata.cn/" title="大数据时代" target="_blank">大数据时代</a>
                <a href="http://www.qidic.com/" title="奇笛网" target="_blank">奇笛网</a>
                <a href="http://www.cngulu.com/" title="咕噜网" target="_blank">咕噜网</a>
                <a href="http://www.linuxdiyf.com/" title="红联linux" target="_blank">红联linux</a>
                <a href="http://win10.ithome.com" title="Win10之家" target="_blank">Win10之家</a>
                <a href="http://www.niaogebiji.com/" title="鸟哥笔记" target="_blank">鸟哥笔记</a>
                <a href="http://www.play.cn" title="爱游戏" target="_blank">爱游戏</a>
                <a href="http://www.investide.cn/" title="投资潮" target="_blank">投资潮</a>
                <a href="http://www.31huiyi.com/" title="31会议网" target="_blank">31会议网</a>
                <a href="https://www.jiguang.cn/" title="极光推送" target="_blank">极光推送</a>
                <a href="https://www.teambition.com/" title="Teambition" target="_blank">Teambition</a>
                <a href="http://www.guigu.org/" title="硅谷网" target="_blank">硅谷网</a>
                <a href="https://home.leangoo.com/" title="leangoo" target="_blank">leangoo</a>
                <a href="http://www.zealer.com/" title="ZEALER中国" target="_blank">ZEALER中国</a>
                <a href="http://www.opensns.cn/" title="OpenSNS" target="_blank">OpenSNS</a>
                <a href="http://www.edu360.cn/" title="小牛学堂" target="_blank">小牛学堂</a>
                <a href="http://www.handone.com/" title="handone" target="_blank">handone</a>
                <a href="http://www.scrumcn.com/" title="Scrum中文网" target="_blank">Scrum中文网</a>
                <a href="http://www.bigniu.com/" title="比戈大牛" target="_blank">比戈大牛</a>
                <a href="https://www.upyun.com/" title="又拍云" target="_blank">又拍云</a>
            <a href="/links">更多链接>></a>&nbsp;&nbsp;
        </dd>
    </dl>
    <div class="clear"></div>
    </div>
</div>

<div style="display:none;">
   <script src="http://s22.cnzz.com/stat.php?id=5541078&web_id=5541078&show=pic" language="JavaScript"></script>
</div>


</body>
</html>
